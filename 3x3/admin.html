<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrador ‚Äî Torneo 3x3 Baloncesto</title>
  <style>
    :root{ --bg:#f8fafc; --panel:#e2e8f0; --card:#ffffff; --muted:#475569; --text:#0f172a; --accent:#dc2626; --ok:#16a34a; --bad:#dc2626; --ring:0 0 0 2px var(--accent) inset; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:20px 16px;border-bottom:2px solid #cbd5e1;background:linear-gradient(90deg,#e2e8f0,#f1f5f9);position:sticky;top:0;z-index:10}
    .container{max-width:1400px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:clamp(22px,3.2vw,34px)}
    .subtitle{color:var(--muted)}

    .grid{display:grid;gap:16px}
    @media(min-width:1100px){.grid{grid-template-columns:500px 1fr}}

    .card{background:var(--card);border:1px solid #cbd5e1;border-radius:18px;padding:16px;box-shadow:0 3px 10px rgba(0,0,0,.1)}
    .card h2{margin:0 0 12px;font-size:18px}
    label{display:block;margin:8px 0 6px;color:var(--muted)}
    textarea,input[type="text"],input[type="number"],input[type="url"],select,input[type="file"],input[type="color"]{width:100%;background:#f8fafc;color:var(--text);border:1px solid #cbd5e1;border-radius:12px;padding:10px 12px;outline:none}
    textarea:focus,input:focus,select:focus{box-shadow:var(--ring);border-color:transparent}
    textarea{min-height:96px;white-space:pre}
    button{background:linear-gradient(180deg,var(--accent),#e11d48);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:all 0.2s ease}
    button:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.15)}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #cbd5e1}
    button:disabled{opacity:0.6;cursor:not-allowed;transform:none !important}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}

    .groups{display:grid;gap:12px}
    @media(min-width:700px){.groups{grid-template-columns:1fr 1fr}}

    /* Colores por grupo */
    .groupA{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.45)}
    .groupB{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.45)}
    .groupC{background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.45)}
    .groupD{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.45)}
    .groupE{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.45)}
    .groupF{background:rgba(14,165,233,.12);border:1px solid rgba(14,165,233,.45)}
    .groupG{background:rgba(139,92,246,.12);border:1px solid rgba(139,92,246,.45)}

    .groupBox{padding:12px;border-radius:12px;margin-bottom:12px}

    .matches{display:grid;gap:10px;margin-top:10px}
    .match{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;background:#f8fafc;border:1px solid #cbd5e1;border-radius:12px;padding:10px}
    .team{display:flex;align-items:center;gap:10px}
    .team input{max-width:80px;text-align:center}
    .dash{opacity:.6}
    .info{display:flex;gap:8px;margin-top:6px}
    .info input{background:#f8fafc;border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px;font-size:14px}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #cbd5e1;text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{font-size:12px;color:var(--muted);font-weight:600}
    tbody tr:hover{background:#e2e8f0}
    .pos{font-variant-numeric:tabular-nums;color:var(--muted)}
    .pts{font-weight:800}
    .first{background:rgba(34,197,94,.15)}
    .second{background:rgba(253,224,71,.15)}
    .note{font-size:12px;color:var(--muted)}

    /* Eliminatorias */
    .bracket{display:grid;gap:12px;margin-top:16px}
    @media(min-width:900px){.bracket{grid-template-columns:1fr 1fr}}
    .quarter, .semi, .final, .third{background:#ffffff;border:1px solid #cbd5e1;border-radius:12px;padding:12px}
    .quarter h3, .semi h3, .final h3, .third h3{margin:0 0 8px;font-size:16px}

    /* Estado de publicaci√≥n */
    .status{font-size:12px;padding:4px 8px;border-radius:6px;margin-left:8px}
    .status.success{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
    .status.error{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
    .status.loading{background:#eff6ff;color:#1e40af;border:1px solid#dbeafe}

    /* Import/Export section */
    .import-export{background:#f0f9ff;border:2px dashed #bae6fd;border-radius:12px;padding:16px;margin-top:12px}
    .import-export h3{margin:0 0 12px;font-size:16px;color:#0369a1}

    /* Resaltar Final */
    .final {
      position: relative;
      border: 2px solid var(--accent);
      box-shadow: 0 0 0 4px rgba(220,38,38,.12) inset;
      background: #ffffff;
      overflow: hidden;
    }
    .final h3{ color: var(--accent); }

    .final::before {
      content: 'FINAL üèÄ';
      position: absolute;
      top: 12px;
      right: -48px;
      transform: rotate(45deg);
      background: var(--accent);
      color: white;
      font-weight: 700;
      font-size: 14px;
      padding: 4px 48px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      opacity: 0.9;
    }

    /* Baloncesto espec√≠fico */
    .basketball-stats {
      background: #fef7ed;
      border: 1px solid #fed7aa;
      border-radius: 12px;
      padding: 12px;
      margin-top: 8px;
    }
    .basketball-stats h4 {
      margin: 0 0 8px;
      color: #ea580c;
      font-size: 14px;
    }

    /* Mensajes de estado */
    .message {
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      font-size: 14px;
    }
    .message.success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    .message.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Administrador ‚Äî Torneo 3x3 Baloncesto</h1>
      <div class="subtitle">22 equipos: 6 grupos de 3 equipos + 1 grupo de 4 equipos</div>
    </div>
  </header>

  <main class="container grid">
    <section class="card">
      <h2>1) Equipos por grupo</h2>
      <div id="statusMessage"></div>
      
      <div class="groups">
        <div><label>Grupo A (3 equipos)</label><textarea id="ga">Equipo A1
Equipo A2
Equipo A3</textarea></div>
        <div><label>Grupo B (3 equipos)</label><textarea id="gb">Equipo B1
Equipo B2
Equipo B3</textarea></div>
        <div><label>Grupo C (3 equipos)</label><textarea id="gc">Equipo C1
Equipo C2
Equipo C3</textarea></div>
        <div><label>Grupo D (3 equipos)</label><textarea id="gd">Equipo D1
Equipo D2
Equipo D3</textarea></div>
        <div><label>Grupo E (3 equipos)</label><textarea id="ge">Equipo E1
Equipo E2
Equipo E3</textarea></div>
        <div><label>Grupo F (3 equipos)</label><textarea id="gf">Equipo F1
Equipo F2
Equipo F3</textarea></div>
        <div><label>Grupo G (4 equipos)</label><textarea id="gg">Equipo G1
Equipo G2
Equipo G3
Equipo G4</textarea></div>
      </div>

      <!-- Tema (colores) -->
      <div class="row" style="margin-top:8px">
        <input type="text" id="tournamentName" placeholder="Nombre del torneo (ej: Liga 3x3 2024)" style="flex:2" />
        <div style="display:flex; gap:8px; align-items:center">
          <label for="themeColor" style="margin:0;color:var(--muted)">Acento</label>
          <input type="color" id="themeColor" value="#dc2626" style="width:54px;padding:0">
          <label for="themeBg" style="margin:0;color:var(--muted)">Fondo</label>
          <input type="color" id="themeBg" value="#f8fafc" style="width:54px;padding:0">
        </div>
      </div>

      <div class="basketball-stats">
        <h4>üèÄ Configuraci√≥n Baloncesto 3x3</h4>
        <div class="row">
          <div style="flex:1">
            <label>Puntos por victoria</label>
            <input type="number" id="pointsWin" value="2" min="1" style="max-width:100px">
          </div>
          <div style="flex:1">
            <label>Puntos por derrota</label>
            <input type="number" id="pointsLoss" value="0" min="0" style="max-width:100px">
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <button id="btnGenerate">üîÑ Generar calendario</button>
        <button id="btnPublish">üì§ Publicar <span id="publishStatus"></span></button>
        
        <div class="spacer"></div>
        <button id="btnSaveCopy" class="ghost">üíæ Guardar copia</button>
        <button id="btnClearAll" class="ghost">üßπ Limpiar</button>
      </div>

      <!-- SECCI√ìN IMPORTAR/EXPORTAR -->
      <div class="import-export">
        <h3>üì• Importar / üì§ Exportar Datos</h3>
        <div class="row">
          <input type="file" id="importFile" accept=".json" style="flex:2">
          <button id="btnImport" class="ghost">üì• Importar JSON</button>
          <button id="btnExport" class="ghost">üì§ Exportar JSON</button>
        </div>
        <div style="font-size:12px; color:var(--muted); margin-top:8px">
          üí° Puedes importar un archivo JSON anterior para continuar donde lo dejaste
        </div>
      </div>

      <div style="margin-top:8px; font-size:12px; color:var(--muted)">
        üí° <strong>Para usar:</strong> 1) Agrega equipos ‚Üí 2) Genera calendario ‚Üí 3) Ingresa resultados ‚Üí 4) Publica
      </div>
    </section>

    <section class="card">
      <h2>Grupos y partidos</h2>
      <div id="groupsRoot"></div>

      <div class="bracket">
        <!-- Cuartos de final -->
        <div class="quarter">
          <h3>Cuartos de Final 1 ‚Äî A1 vs B1</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="qf1h">A1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="qf1gh" style="max-width:80px"> <span class="dash">‚Äî</span>
              <input type="number" min="0" inputmode="numeric" id="qf1ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="qf1a">B1</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="qf1w" style="max-width:260px"><option value="">‚Äî Ganador ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="qf1Hour" placeholder="Hora (ej. 16:00)" style="max-width:180px">
            <input type="text" id="qf1Place" placeholder="Lugar (ej. Cancha 1)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="qf1HomeName" placeholder="Nombre local (opcional)" style="flex:1">
            <input type="text" id="qf1AwayName" placeholder="Nombre visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="quarter">
          <h3>Cuartos de Final 2 ‚Äî C1 vs D1</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="qf2h">C1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="qf2gh" style="max-width:80px"> <span class="dash">‚Äî</span>
              <input type="number" min="0" inputmode="numeric" id="qf2ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="qf2a">D1</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="qf2w" style="max-width:260px"><option value="">‚Äî Ganador ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="qf2Hour" placeholder="Hora (ej. 16:30)" style="max-width:180px">
            <input type="text" id="qf2Place" placeholder="Lugar (ej. Cancha 1)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="qf2HomeName" placeholder="Nombre local (opcional)" style="flex:1">
            <input type="text" id="qf2AwayName" placeholder="Nombre visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="quarter">
          <h3>Cuartos de Final 3 ‚Äî E1 vs F1</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="qf3h">E1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="qf3gh" style="max-width:80px"> <span class="dash">‚Äî</span>
              <input type="number" min="0" inputmode="numeric" id="qf3ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="qf3a">F1</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="qf3w" style="max-width:260px"><option value="">‚Äî Ganador ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="qf3Hour" placeholder="Hora (ej. 17:00)" style="max-width:180px">
            <input type="text" id="qf3Place" placeholder="Lugar (ej. Cancha 1)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="qf3HomeName" placeholder="Nombre local (opcional)" style="flex:1">
            <input type="text" id="qf3AwayName" placeholder="Nombre visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="quarter">
          <h3>Cuartos de Final 4 ‚Äî G1 vs G2</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="qf4h">G1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="qf4gh" style="max-width:80px"> <span class="dash">‚Äî</span>
              <input type="number" min="0" inputmode="numeric" id="qf4ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="qf4a">G2</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="qf4w" style="max-width:260px"><option value="">‚Äî Ganador ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="qf4Hour" placeholder="Hora (ej. 17:30)" style="max-width:180px">
            <input type="text" id="qf4Place" placeholder="Lugar (ej. Cancha 1)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="qf4HomeName" placeholder="Nombre local (opcional)" style="flex:1">
            <input type="text" id="qf4AwayName" placeholder="Nombre visita (opcional)" style="flex:1">
          </div>
        </div>

        <!-- Semifinales -->
        <div class="semi">
          <h3>Semifinal 1 ‚Äî Ganador QF1 vs Ganador QF2</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf1h">Ganador QF1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="sf1gh" style="max-width:80px"> <span class="dash">‚Äî</span>
              <input type="number" min="0" inputmode="numeric" id="sf1ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf1a">Ganador QF2</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf1w" style="max-width:260px"><option value="">‚Äî Ganador ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf1Hour" placeholder="Hora (ej. 18:00)" style="max-width:180px">
            <input type="text" id="sf1Place" placeholder="Lugar (ej. Cancha 1)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf1HomeName" placeholder="Nombre local (opcional)" style="flex:1">
            <input type="text" id="sf1AwayName" placeholder="Nombre visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="semi">
          <h3>Semifinal 2 ‚Äî Ganador QF3 vs Ganador QF4</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf2h">Ganador QF3</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="sf2gh" style="max-width:80px"> <span class="dash">‚Äî</span>
              <input type="number" min="0" inputmode="numeric" id="sf2ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf2a">Ganador QF4</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf2w" style="max-width:260px"><option value="">‚Äî Ganador ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf2Hour" placeholder="Hora (ej. 18:30)" style="max-width:180px">
            <input type="text" id="sf2Place" placeholder="Lugar (ej. Cancha 1)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf2HomeName" placeholder="Nombre local (opcional)" style="flex:1">
            <input type="text" id="sf2AwayName" placeholder="Nombre visita (opcional)" style="flex:1">
          </div>
        </div>

        <!-- Final y tercer lugar -->
        <div class="final">
          <h3>Final</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="fih">Ganador SF1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="figh" style="max-width:80px"> <span class="dash">‚Äî</span>
              <input type="number" min="0" inputmode="numeric" id="figa" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="fia">Ganador SF2</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige campe√≥n</label>
            <select id="fiw" style="max-width:260px"><option value="">‚Äî Campe√≥n ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="fiHour" placeholder="Hora (ej. 19:00)" style="max-width:180px">
            <input type="text" id="fiPlace" placeholder="Lugar (ej. Cancha 1)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="fiHomeName" placeholder="Nombre local (opcional)" style="flex:1">
            <input type="text" id="fiAwayName" placeholder="Nombre visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="third">
          <h3>Tercer Lugar</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="thirdh">Perdedor SF1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="thirdgh" style="max-width:80px"> <span class="dash">‚Äî</span>
              <input type="number" min="0" inputmode="numeric" id="thirdga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="thirda">Perdedor SF2</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige tercero</label>
            <select id="thirdw" style="max-width:260px"><option value="">‚Äî Tercero ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="thirdHour" placeholder="Hora (ej. 18:30)" style="max-width:180px">
            <input type="text" id="thirdPlace" placeholder="Lugar (ej. Cancha 1)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="thirdHomeName" placeholder="Nombre local (opcional)" style="flex:1">
            <input type="text" id="thirdAwayName" placeholder="Nombre visita (opcional)" style="flex:1">
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
// ===== CONFIGURACI√ìN =====
const STORAGE_KEY = 'torneo_3x3_v2';
const $ = (selector, root = document) => root.querySelector(selector);

// ===== ESTADO INICIAL =====
let state = {
  groups: {
    A: { teams: ['Equipo A1', 'Equipo A2', 'Equipo A3'], matches: [] },
    B: { teams: ['Equipo B1', 'Equipo B2', 'Equipo B3'], matches: [] },
    C: { teams: ['Equipo C1', 'Equipo C2', 'Equipo C3'], matches: [] },
    D: { teams: ['Equipo D1', 'Equipo D2', 'Equipo D3'], matches: [] },
    E: { teams: ['Equipo E1', 'Equipo E2', 'Equipo E3'], matches: [] },
    F: { teams: ['Equipo F1', 'Equipo F2', 'Equipo F3'], matches: [] },
    G: { teams: ['Equipo G1', 'Equipo G2', 'Equipo G3', 'Equipo G4'], matches: [] }
  },
  points: { win: 2, loss: 0 },
  knockout: {
    qf1: { home: '', away: '', gh: null, ga: null, winner: '', hour: '', place: '', homeName: '', awayName: '' },
    qf2: { home: '', away: '', gh: null, ga: null, winner: '', hour: '', place: '', homeName: '', awayName: '' },
    qf3: { home: '', away: '', gh: null, ga: null, winner: '', hour: '', place: '', homeName: '', awayName: '' },
    qf4: { home: '', away: '', gh: null, ga: null, winner: '', hour: '', place: '', homeName: '', awayName: '' },
    sf1: { home: '', away: '', gh: null, ga: null, winner: '', hour: '', place: '', homeName: '', awayName: '' },
    sf2: { home: '', away: '', gh: null, ga: null, winner: '', hour: '', place: '', homeName: '', awayName: '' },
    final: { home: '', away: '', gh: null, ga: null, winner: '', hour: '', place: '', homeName: '', awayName: '' },
    third: { home: '', away: '', gh: null, ga: null, winner: '', hour: '', place: '', homeName: '', awayName: '' }
  },
  tournamentName: 'Torneo 3x3 Baloncesto 2024',
  theme: { color: '#dc2626', bg: '#f8fafc' }
};

// ===== FUNCIONES AUXILIARES =====
function showMessage(message, type = 'success') {
  const messageEl = $('#statusMessage');
  messageEl.innerHTML = `<div class="message ${type}">${message}</div>`;
  setTimeout(() => {
    messageEl.innerHTML = '';
  }, 3000);
}

function parseTeams(txt) {
  return String(txt || '').split('\n').map(s => s.trim()).filter(Boolean);
}

function roundRobin3(teams) {
  if (teams.length !== 3) return [];
  const [a, b, c] = teams;
  return [[a, b], [c, a], [b, c]];
}

function roundRobin4(teams) {
  if (teams.length !== 4) return [];
  const [a, b, c, d] = teams;
  return [[a, b], [c, d], [a, c], [b, d], [a, d], [b, c]];
}

function valInt(v) {
  if (v === '' || v == null) return null;
  const n = parseInt(v, 10);
  return Number.isFinite(n) && n >= 0 ? n : null;
}

// ===== FUNCIONES PRINCIPALES =====
function generateSchedule() {
  try {
    // Actualizar equipos desde textareas
    ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(key => {
      const textarea = $(`#g${key.toLowerCase()}`);
      state.groups[key].teams = parseTeams(textarea.value);
    });

    // Validar que todos los grupos tengan equipos
    let hasEmptyGroups = false;
    ['A', 'B', 'C', 'D', 'E', 'F'].forEach(key => {
      if (state.groups[key].teams.length !== 3) {
        hasEmptyGroups = true;
        showMessage(`El grupo ${key} debe tener exactamente 3 equipos`, 'error');
      }
    });
    
    if (state.groups.G.teams.length !== 4) {
      hasEmptyGroups = true;
      showMessage('El grupo G debe tener exactamente 4 equipos', 'error');
    }

    if (hasEmptyGroups) return;

    // Generar partidos para cada grupo
    ['A', 'B', 'C', 'D', 'E', 'F'].forEach(key => {
      const teams = state.groups[key].teams;
      state.groups[key].matches = roundRobin3(teams).map(([home, away]) => ({
        home, away, gh: null, ga: null, hour: '', place: ''
      }));
    });

    // Grupo G (4 equipos)
    const teamsG = state.groups.G.teams;
    state.groups.G.matches = roundRobin4(teamsG).map(([home, away]) => ({
      home, away, gh: null, ga: null, hour: '', place: ''
    }));

    // Actualizar configuraci√≥n
    state.points.win = parseInt($('#pointsWin').value) || 2;
    state.points.loss = parseInt($('#pointsLoss').value) || 0;
    state.tournamentName = $('#tournamentName').value || 'Torneo 3x3 Baloncesto';
    state.theme.color = $('#themeColor').value;
    state.theme.bg = $('#themeBg').value;

    saveState();
    renderGroups();
    updateKnockout();
    applyTheme();

    showMessage('‚úÖ Calendario generado correctamente');
  } catch (error) {
    console.error('Error generando calendario:', error);
    showMessage('‚ùå Error al generar el calendario', 'error');
  }
}

function publishTournament() {
  const statusEl = $('#publishStatus');
  statusEl.textContent = '‚è≥';
  statusEl.className = 'status loading';

  try {
    // Preparar datos para exportar
    const exportData = {
      tournamentName: state.tournamentName,
      subtitle: 'Torneo 3x3 Baloncesto - 22 equipos',
      groups: state.groups,
      knockout: state.knockout,
      updatedAtLocal: new Date().toLocaleString('es-ES'),
      theme: state.theme,
      points: state.points,
      sport: 'basketball'
    };

    // Crear y descargar archivo
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'data.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    statusEl.textContent = '‚úÖ';
    statusEl.className = 'status success';
    showMessage('‚úÖ Archivo data.json descargado correctamente');

    setTimeout(() => {
      statusEl.textContent = '';
      statusEl.className = '';
    }, 3000);

  } catch (error) {
    statusEl.textContent = '‚ùå';
    statusEl.className = 'status error';
    showMessage('‚ùå Error al publicar el torneo', 'error');
    console.error('Error al publicar:', error);
  }
}

function saveCopy() {
  saveState();
  showMessage('üíæ Datos guardados correctamente');
}

function clearAll() {
  if (confirm('¬øEst√°s seguro de que quieres borrar todos los datos? Esta acci√≥n no se puede deshacer.')) {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
}

function exportData() {
  try {
    const exportData = {
      ...state,
      exportedAt: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `torneo-3x3-backup-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showMessage('üì§ Datos exportados correctamente');
  } catch (error) {
    showMessage('‚ùå Error al exportar los datos', 'error');
  }
}

function importData() {
  const fileInput = $('#importFile');
  const file = fileInput.files[0];

  if (!file) {
    showMessage('‚ùå Por favor selecciona un archivo JSON', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);

      if (confirm('¬øEst√°s seguro de que quieres importar estos datos? Se perder√°n los datos actuales.')) {
        // Actualizar estado
        Object.assign(state, importedData);

        // Actualizar UI
        ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(key => {
          $(`#g${key.toLowerCase()}`).value = state.groups[key].teams.join('\n');
        });

        $('#tournamentName').value = state.tournamentName;
        $('#themeColor').value = state.theme.color;
        $('#themeBg').value = state.theme.bg;
        $('#pointsWin').value = state.points.win;
        $('#pointsLoss').value = state.points.loss;

        applyTheme();
        saveState();
        renderGroups();
        updateKnockout();

        showMessage('‚úÖ Datos importados correctamente');
        fileInput.value = '';
      }
    } catch (error) {
      showMessage('‚ùå Error al importar: ' + error.message, 'error');
    }
  };

  reader.onerror = function() {
    showMessage('‚ùå Error al leer el archivo', 'error');
  };

  reader.readAsText(file);
}

// ===== RENDERIZADO =====
function computeTable(matches, teams) {
  const table = Object.fromEntries(teams.map(team => [team, {
    team, PJ: 0, G: 0, P: 0, PF: 0, PC: 0, Dif: 0, Pts: 0
  }]));

  const cfg = state.points;

  matches.forEach(match => {
    if (match.gh == null || match.ga == null) return;

    const homeTeam = table[match.home];
    const awayTeam = table[match.away];
    if (!homeTeam || !awayTeam) return;

    homeTeam.PJ++;
    awayTeam.PJ++;

    homeTeam.PF += match.gh;
    homeTeam.PC += match.ga;
    awayTeam.PF += match.ga;
    awayTeam.PC += match.gh;

    if (match.gh > match.ga) {
      homeTeam.G++;
      awayTeam.P++;
      homeTeam.Pts += cfg.win;
      awayTeam.Pts += cfg.loss;
    } else {
      awayTeam.G++;
      homeTeam.P++;
      awayTeam.Pts += cfg.win;
      homeTeam.Pts += cfg.loss;
    }
  });

  teams.forEach(team => {
    table[team].Dif = table[team].PF - table[team].PC;
  });

  return Object.values(table).sort((a, b) => {
    if (b.Pts !== a.Pts) return b.Pts - a.Pts;
    if (b.Dif !== a.Dif) return b.Dif - a.Dif;
    if (b.PF !== a.PF) return b.PF - a.PF;
    return a.team.localeCompare(b.team);
  });
}

function renderGroups() {
  const root = $('#groupsRoot');
  root.innerHTML = '';

  ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(groupKey => {
    const group = state.groups[groupKey];
    const isGroupG = groupKey === 'G';

    const groupDiv = document.createElement('div');
    groupDiv.className = `groupBox group${groupKey}`;

    const title = document.createElement('h3');
    title.textContent = `Grupo ${groupKey} (${group.teams.length} equipos)`;
    groupDiv.appendChild(title);

    // Tabla de posiciones
    const table = document.createElement('table');
    const rows = computeTable(group.matches, group.teams);

    table.innerHTML = `
      <thead>
        <tr>
          <th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>P</th>
          <th>PF</th><th>PC</th><th>Dif</th><th>Pts</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map((row, idx) => `
          <tr class="${idx === 0 ? 'first' : ''} ${idx === 1 && isGroupG ? 'second' : ''}">
            <td class="pos">${idx + 1}</td>
            <td>${row.team}</td>
            <td>${row.PJ}</td>
            <td>${row.G}</td>
            <td>${row.P}</td>
            <td>${row.PF}</td>
            <td>${row.PC}</td>
            <td>${row.Dif > 0 ? '+' : ''}${row.Dif}</td>
            <td class="pts">${row.Pts}</td>
          </tr>
        `).join('')}
      </tbody>
    `;

    groupDiv.appendChild(table);

    // Partidos
    const matchesDiv = document.createElement('div');
    matchesDiv.className = 'matches';

    group.matches.forEach((match, idx) => {
      const matchDiv = document.createElement('div');
      matchDiv.className = 'match';

      matchDiv.innerHTML = `
        <div class="team">${match.home}</div>
        <div class="team">
          <input type="number" min="0" inputmode="numeric" data-group="${groupKey}" data-match="${idx}" data-side="home" value="${match.gh ?? ''}" placeholder="0">
          <span class="dash">‚Äî</span>
          <input type="number" min="0" inputmode="numeric" data-group="${groupKey}" data-match="${idx}" data-side="away" value="${match.ga ?? ''}" placeholder="0">
        </div>
        <div class="team">${match.away}</div>
        <div class="info">
          <input type="text" data-group="${groupKey}" data-match="${idx}" data-type="hour" value="${match.hour || ''}" placeholder="Hora">
          <input type="text" data-group="${groupKey}" data-match="${idx}" data-type="place" value="${match.place || ''}" placeholder="Lugar">
        </div>
      `;

      matchesDiv.appendChild(matchDiv);
    });

    groupDiv.appendChild(matchesDiv);
    root.appendChild(groupDiv);
  });

  setupGroupEventListeners();
}

function updateKnockout() {
  // Actualizar nombres de equipos en cuartos
  $('#qf1h').textContent = state.knockout.qf1.homeName || 'A1';
  $('#qf1a').textContent = state.knockout.qf1.awayName || 'B1';
  $('#qf2h').textContent = state.knockout.qf2.homeName || 'C1';
  $('#qf2a').textContent = state.knockout.qf2.awayName || 'D1';
  $('#qf3h').textContent = state.knockout.qf3.homeName || 'E1';
  $('#qf3a').textContent = state.knockout.qf3.awayName || 'F1';
  $('#qf4h').textContent = state.knockout.qf4.homeName || 'G1';
  $('#qf4a').textContent = state.knockout.qf4.awayName || 'G2';

  // Actualizar selectores de ganadores
  updateWinnerSelectors();

  // Actualizar nombres en semifinales
  const sf1Home = state.knockout.sf1.homeName || state.knockout.sf1.winner || 'Ganador QF1';
  const sf1Away = state.knockout.sf1.awayName || state.knockout.sf2.winner || 'Ganador QF2';
  const sf2Home = state.knockout.sf2.homeName || state.knockout.sf3.winner || 'Ganador QF3';
  const sf2Away = state.knockout.sf2.awayName || state.knockout.sf4.winner || 'Ganador QF4';

  $('#sf1h').textContent = sf1Home;
  $('#sf1a').textContent = sf1Away;
  $('#sf2h').textContent = sf2Home;
  $('#sf2a').textContent = sf2Away;

  // Actualizar nombres en final y tercer lugar
  const finalHome = state.knockout.final.homeName || state.knockout.sf1.winner || 'Ganador SF1';
  const finalAway = state.knockout.final.awayName || state.knockout.sf2.winner || 'Ganador SF2';
  
  $('#fih').textContent = finalHome;
  $('#fia').textContent = finalAway;

  const thirdHome = state.knockout.third.homeName || 'Perdedor SF1';
  const thirdAway = state.knockout.third.awayName || 'Perdedor SF2';
  
  $('#thirdh').textContent = thirdHome;
  $('#thirda').textContent = thirdAway;
}

function updateWinnerSelectors() {
  const knockoutKeys = ['qf1', 'qf2', 'qf3', 'qf4', 'sf1', 'sf2', 'final', 'third'];
  
  knockoutKeys.forEach(key => {
    const selectEl = $(`#${key}w`);
    const homeEl = $(`#${key}h`);
    const awayEl = $(`#${key}a`);
    
    if (selectEl && homeEl && awayEl) {
      const homeTeam = homeEl.textContent;
      const awayTeam = awayEl.textContent;
      const currentWinner = state.knockout[key].winner;
      
      selectEl.innerHTML = `<option value="">‚Äî Ganador ‚Äî</option>`;
      
      if (homeTeam && !homeTeam.includes('Ganador') && !homeTeam.includes('Perdedor')) {
        const opt1 = document.createElement('option');
        opt1.value = homeTeam;
        opt1.textContent = homeTeam;
        opt1.selected = currentWinner === homeTeam;
        selectEl.appendChild(opt1);
      }
      
      if (awayTeam && !awayTeam.includes('Ganador') && !awayTeam.includes('Perdedor')) {
        const opt2 = document.createElement('option');
        opt2.value = awayTeam;
        opt2.textContent = awayTeam;
        opt2.selected = currentWinner === awayTeam;
        selectEl.appendChild(opt2);
      }
    }
  });
}

// ===== EVENT LISTENERS =====
function setupGroupEventListeners() {
  // Scores
  document.querySelectorAll('input[type="number"]').forEach(input => {
    if (input.dataset.group && input.dataset.match !== undefined) {
      input.addEventListener('input', function() {
        const groupKey = this.dataset.group;
        const matchIdx = parseInt(this.dataset.match, 10);
        const side = this.dataset.side;
        
        const match = state.groups[groupKey].matches[matchIdx];
        if (match) {
          match[side === 'home' ? 'gh' : 'ga'] = valInt(this.value);
          saveState();
          renderGroups();
          updateKnockout();
        }
      });
    }
  });

  // Hora y lugar
  document.querySelectorAll('input[type="text"]').forEach(input => {
    if (input.dataset.group && input.dataset.match !== undefined) {
      input.addEventListener('change', function() {
        const groupKey = this.dataset.group;
        const matchIdx = parseInt(this.dataset.match, 10);
        const type = this.dataset.type;
        
        const match = state.groups[groupKey].matches[matchIdx];
        if (match) {
          match[type] = this.value.trim();
          saveState();
        }
      });
    }
  });
}

function setupKnockoutEventListeners() {
  // Eliminatorias - scores
  document.querySelectorAll('input[type="number"]').forEach(input => {
    const id = input.id;
    const match = id.match(/^(qf[1-4]|sf[1-2]|final|third)(gh|ga)$/);
    
    if (match) {
      input.addEventListener('input', function() {
        const [, key, field] = match;
        state.knockout[key][field] = valInt(this.value);
        saveState();
        updateKnockout();
      });
    }
  });

  // Eliminatorias - hora y lugar
  document.querySelectorAll('input[type="text"]').forEach(input => {
    const id = input.id;
    const match = id.match(/^(qf[1-4]|sf[1-2]|final|third)(Hour|Place|HomeName|AwayName)$/);
    
    if (match) {
      input.addEventListener('input', function() {
        const [, key, field] = match;
        const fieldName = field === 'HomeName' ? 'homeName' : 
                         field === 'AwayName' ? 'awayName' : 
                         field.toLowerCase();
        
        state.knockout[key][fieldName] = this.value.trim();
        saveState();
        updateKnockout();
      });
    }
  });

  // Eliminatorias - ganadores
  document.querySelectorAll('select').forEach(select => {
    const id = select.id;
    const match = id.match(/^(qf[1-4]|sf[1-2]|final|third)w$/);
    
    if (match) {
      select.addEventListener('change', function() {
        const key = match[1];
        state.knockout[key].winner = this.value;
        saveState();
        updateKnockout();
      });
    }
  });
}

// ===== PERSISTENCIA =====
function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.error('Error guardando estado:', e);
  }
}

function loadState() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const parsed = JSON.parse(saved);
      Object.assign(state, parsed);
      return true;
    }
  } catch (e) {
    console.error('Error cargando estado:', e);
  }
  return false;
}

function applyTheme() {
  try {
    document.documentElement.style.setProperty('--accent', state.theme?.color || '#dc2626');
    document.documentElement.style.setProperty('--bg', state.theme?.bg || '#f8fafc');
    if (document.body) document.body.style.background = state.theme?.bg || '#f8fafc';
  } catch(e) { /* no-op */ }
}

// ===== INICIALIZACI√ìN =====
function init() {
  // Cargar estado guardado
  const loaded = loadState();
  
  // Configurar valores iniciales en UI
  ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(key => {
    $(`#g${key.toLowerCase()}`).value = state.groups[key].teams.join('\n');
  });
  
  $('#tournamentName').value = state.tournamentName;
  $('#themeColor').value = state.theme.color;
  $('#themeBg').value = state.theme.bg;
  $('#pointsWin').value = state.points.win;
  $('#pointsLoss').value = state.points.loss;
  
  // Configurar event listeners principales
  $('#btnGenerate').addEventListener('click', generateSchedule);
  $('#btnPublish').addEventListener('click', publishTournament);
  $('#btnSaveCopy').addEventListener('click', saveCopy);
  $('#btnClearAll').addEventListener('click', clearAll);
  $('#btnExport').addEventListener('click', exportData);
  $('#btnImport').addEventListener('click', importData);
  
  // Configurar event listeners de knockout
  setupKnockoutEventListeners();
  
  // Tema
  $('#tournamentName').addEventListener('input', e => {
    state.tournamentName = e.target.value;
    saveState();
  });
  
  $('#themeColor').addEventListener('input', e => { 
    state.theme.color = e.target.value; 
    saveState(); 
    applyTheme(); 
  });
  
  $('#themeBg').addEventListener('input', e => { 
    state.theme.bg = e.target.value; 
    saveState(); 
    applyTheme(); 
  });
  
  // Sistema de puntos
  $('#pointsWin').addEventListener('input', e => { 
    state.points.win = parseInt(e.target.value) || 2; 
    saveState(); 
    renderGroups(); 
  });
  
  $('#pointsLoss').addEventListener('input', e => { 
    state.points.loss = parseInt(e.target.value) || 0; 
    saveState(); 
    renderGroups(); 
  });

  // Renderizar inicial
  applyTheme();
  renderGroups();
  updateKnockout();
}

// Iniciar la aplicaci√≥n
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>