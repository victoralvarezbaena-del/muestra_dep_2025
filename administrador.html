<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrador — Torneo 4 Grupos + Semifinales</title>
  <style>
    :root{ --bg:#f8fafc; --panel:#e2e8f0; --card:#ffffff; --muted:#475569; --text:#0f172a; --accent:#0284c7; --ok:#16a34a; --bad:#dc2626; --ring:0 0 0 2px var(--accent) inset; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:20px 16px;border-bottom:2px solid #cbd5e1;background:linear-gradient(90deg,#e2e8f0,#f1f5f9);position:sticky;top:0;z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:clamp(22px,3.2vw,34px)}
    .subtitle{color:var(--muted)}

    .grid{display:grid;gap:16px}
    @media(min-width:1100px){.grid{grid-template-columns:420px 1fr}}

    .card{background:var(--card);border:1px solid #cbd5e1;border-radius:18px;padding:16px;box-shadow:0 3px 10px rgba(0,0,0,.1)}
    .card h2{margin:0 0 12px;font-size:18px}
    label{display:block;margin:8px 0 6px;color:var(--muted)}
    textarea,input[type="text"],input[type="number"],input[type="url"],select,input[type="file"],input[type="color"]{width:100%;background:#f8fafc;color:var(--text);border:1px solid #cbd5e1;border-radius:12px;padding:10px 12px;outline:none}
    textarea:focus,input:focus,select:focus{box-shadow:var(--ring);border-color:transparent}
    textarea{min-height:96px;white-space:pre}
    button{background:linear-gradient(180deg,var(--accent),#0ea5e9);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #cbd5e1}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}

    .groups{display:grid;gap:12px}
    @media(min-width:700px){.groups{grid-template-columns:1fr 1fr}}

    /* Colores por grupo */
    .groupA{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.45)}
    .groupB{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.45)}
    .groupC{background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.45)}
    .groupD{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.45)}

    .groupBox{padding:12px;border-radius:12px;margin-bottom:12px}

    .matches{display:grid;gap:10px;margin-top:10px}
    .match{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;background:#f8fafc;border:1px solid #cbd5e1;border-radius:12px;padding:10px}
    .team{display:flex;align-items:center;gap:10px}
    .team input{max-width:80px;text-align:center}
    .dash{opacity:.6}
    .info{display:flex;gap:8px;margin-top:6px}
    .info input{background:#f8fafc;border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #cbd5e1;text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{font-size:12px;color:var(--muted);font-weight:600}
    tbody tr:hover{background:#e2e8f0}
    .pos{font-variant-numeric:tabular-nums;color:var(--muted)}
    .pts{font-weight:800}
    .first{background:rgba(34,197,94,.15)}
    .note{font-size:12px;color:var(--muted)}

    /* Knockout */
    .bracket{display:grid;gap:12px;margin-top:16px}
    @media(min-width:900px){.bracket{grid-template-columns:1fr 1fr}}
    .semi,.final{background:#ffffff;border:1px solid #cbd5e1;border-radius:12px;padding:12px}
    .semi h3,.final h3{margin:0 0 8px;font-size:16px}

    /* Estado de publicación */
    .status{font-size:12px;padding:4px 8px;border-radius:6px;margin-left:8px}
    .status.success{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
    .status.error{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
    .status.loading{background:#eff6ff;color:#1e40af;border:1px solid#dbeafe}

    /* Import/Export section */
    .import-export{background:#f0f9ff;border:2px dashed #bae6fd;border-radius:12px;padding:16px;margin-top:12px}
    .import-export h3{margin:0 0 12px;font-size:16px;color:#0369a1}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Administrador — Torneo 4 Grupos + Semifinales</h1>
      <div class="subtitle">Crea y gestiona tu torneo. Los datos se guardan localmente y puedes publicarlos online.</div>
    </div>
  </header>

  <main class="container grid">
    <section class="card">
      <h2>1) Equipos por grupo</h2>
      <div class="groups">
        <div><label>Grupo A</label><textarea id="ga">A1
A2
A3</textarea></div>
        <div><label>Grupo B</label><textarea id="gb">B1
B2
B3</textarea></div>
        <div><label>Grupo C</label><textarea id="gc">C1
C2
C3</textarea></div>
        <div><label>Grupo D</label><textarea id="gd">D1
D2
D3</textarea></div>
      </div>

      <!-- NUEVO: Tema (colores) -->
      <div class="row" style="margin-top:8px">
        <input type="text" id="tournamentName" placeholder="Nombre del torneo (opcional)" style="flex:2" />
        <div style="display:flex; gap:8px; align-items:center">
          <label for="themeColor" style="margin:0;color:var(--muted)">Acento</label>
          <input type="color" id="themeColor" value="#0284c7" style="width:54px;padding:0">
          <label for="themeBg" style="margin:0;color:var(--muted)">Fondo</label>
          <input type="color" id="themeBg" value="#f8fafc" style="width:54px;padding:0">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnGenerate">Generar rol por grupo</button>

        <!-- PUBLICAR (para GH Pages descarga data.json) -->
        <input type="url" id="publishURL" placeholder="(Opcional para otros backends)" style="flex:2; min-width:320px" />
        <button id="btnPublish">Publicar <span id="publishStatus"></span></button>

        <div class="spacer"></div>
        <button id="btnSaveCopy" class="ghost">💾 Guardar copia</button>
        <button id="btnClearAll" class="ghost">🧹 Limpiar</button>
      </div>

      <!-- SECCIÓN IMPORTAR/EXPORTAR -->
      <div class="import-export">
        <h3>📥 Importar / 📤 Exportar Datos</h3>
        <div class="row">
          <input type="file" id="importFile" accept=".json" style="flex:2">
          <button id="btnImport" class="ghost">📥 Importar JSON</button>
          <button id="btnExport" class="ghost">📤 Exportar JSON</button>
        </div>
        <div style="font-size:12px; color:var(--muted); margin-top:8px">
          💡 Puedes importar un archivo JSON anterior para continuar donde lo dejaste
        </div>
      </div>

      <div style="margin-top:8px; font-size:12px; color:var(--muted)">
        💡 <strong>Para usar:</strong> 1) Agrega equipos → 2) Genera rol → 3) Ingresa resultados → 4) Publica
      </div>
    </section>

    <section class="card">
      <h2>Grupos y partidos</h2>
      <div id="groupsRoot"></div>

      <div class="bracket">
        <div class="semi">
          <h3>Semifinal 1 — A1 vs D1</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf1h">A1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="sf1gh" style="max-width:80px"> <span class="dash">—</span>
              <input type="number" min="0" inputmode="numeric" id="sf1ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf1a">D1</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf1w" style="max-width:260px"><option value="">— Ganador —</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="sf1Hour" placeholder="Hora (ej. 16:00)" style="max-width:180px">
              <input type="text" id="sf1Place" placeholder="Lugar (ej. Estadio)" style="flex:1">
            </div>
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf1HomeName" placeholder="Nombre semifinalista local (opcional)" style="flex:1">
            <input type="text" id="sf1AwayName" placeholder="Nombre semifinalista visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="semi">
          <h3>Semifinal 2 — B1 vs C1</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf2h">B1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="sf2gh" style="max-width:80px"> <span class="dash">—</span>
              <input type="number" min="0" inputmode="numeric" id="sf2ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf2a">C1</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf2w" style="max-width:260px"><option value="">— Ganador —</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="sf2Hour" placeholder="Hora (ej. 17:00)" style="max-width:180px">
              <input type="text" id="sf2Place" placeholder="Lugar (ej. Estadio)" style="flex:1">
            </div>
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf2HomeName" placeholder="Nombre semifinalista local (opcional)" style="flex:1">
            <input type="text" id="sf2AwayName" placeholder="Nombre semifinalista visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="final" style="grid-column:1/-1">
          <h3>Final</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="fih">Ganador SF1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="figh" style="max-width:80px"> <span class="dash">—</span>
              <input type="number" min="0" inputmode="numeric" id="figa" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="fia">Ganador SF2</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige campeón</label>
            <select id="fiw" style="max-width:260px"><option value="">— Campeón —</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="fiHour" placeholder="Hora (ej. 19:00)" style="max-width:180px">
              <input type="text" id="fiPlace" placeholder="Lugar (ej. Estadio)" style="flex:1">
            </div>
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="fiHomeName" placeholder="Nombre finalista local (opcional)" style="flex:1">
            <input type="text" id="fiAwayName" placeholder="Nombre finalista visita (opcional)" style="flex:1">
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
/* ===== Configuración ===== */
const STORAGE_KEY = 'torneo_grupos_ko_v1';
const $ = (s, r = document) => r.querySelector(s);

/* ===== Estado inicial ===== */
const state = {
  groups: {
    A: { teams: ['A1','A2','A3'], matches: [] },
    B: { teams: ['B1','B2','B3'], matches: [] },
    C: { teams: ['C1','C2','C3'], matches: [] },
    D: { teams: ['D1','D2','D3'], matches: [] },
  },
  points: { win:3, draw:1, loss:0 },
  knockout: {
    sf1:  { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
    sf2:  { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
    final:{ home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' }
  },
  tournamentName: '',
  // NUEVO: tema
  theme: { color: '#0284c7', bg: '#f8fafc' }
};

/* ===== Helpers ===== */
function parseTeams(txt){ return String(txt||'').split('\n').map(s=>s.trim()).filter(Boolean); }
function roundRobin3(t){ if(t.length!==3) return []; const [a,b,c]=t; return [[a,b],[c,a],[b,c]]; }
function valInt(v){ if(v===''||v==null) return null; const n=parseInt(v,10); return Number.isFinite(n)&&n>=0?n:null; }
function computeTable(matches,teams){
  const t=Object.fromEntries(teams.map(x=>[x,{team:x,PJ:0,G:0,E:0,P:0,GF:0,GC:0,DG:0,Pts:0}])), cfg=state.points;
  for(const m of matches){ if(m.gh==null||m.ga==null) continue; const H=t[m.home],A=t[m.away]; if(!H||!A) continue;
    H.PJ++;A.PJ++;H.GF+=m.gh;H.GC+=m.ga;A.GF+=m.ga;A.GC+=m.gh;
    if(m.gh>m.ga){H.G++;A.P++;H.Pts+=cfg.win;A.Pts+=cfg.loss;}
    else if(m.gh<m.ga){A.G++;H.P++;A.Pts+=cfg.win;H.Pts+=cfg.loss;}
    else {H.E++;A.E++;H.Pts+=cfg.draw;A.Pts+=cfg.draw;}
  }
  for(const x of teams){ t[x].DG=t[x].GF-t[x].GC; }
  return Object.values(t).sort((a,b)=> b.Pts-a.Pts || b.DG-a.DG || b.GF-a.GF || a.team.localeCompare(b.team));
}

/* ===== Render ===== */
function render(){
  const root=$('#groupsRoot'); root.innerHTML='';
  const colors={A:'groupA',B:'groupB',C:'groupC',D:'groupD'};
  for(const g of ['A','B','C','D']){
    const box=document.createElement('div'); box.className=`groupBox ${colors[g]}`;
    const G=state.groups[g]; box.innerHTML=`<h3 style="margin:0 0 6px">Grupo ${g}</h3>`;
    if(G.teams.length!==3){ const warn=document.createElement('div'); warn.className='note'; warn.textContent='Agrega exactamente 3 equipos (uno por línea).'; box.appendChild(warn); root.appendChild(box); continue; }
    // Partidos
    const wrap=document.createElement('div'); wrap.className='matches';
    G.matches.forEach(m=>{
      const row=document.createElement('div'); row.className='match';
      row.innerHTML=`
        <div class="team">${m.home}</div>
        <div class="team" style="justify-content:center">
          <input type="number" min="0" class="gh" value="${m.gh??''}" aria-label="Goles ${m.home}">
          <span class="dash">—</span>
          <input type="number" min="0" class="ga" value="${m.ga??''}" aria-label="Goles ${m.away}">
        </div>
        <div class="team" style="justify-content:flex-end">${m.away}</div>`;
      const info=document.createElement('div'); info.className='info';
      info.innerHTML=`<input type="text" class="hour" placeholder="Hora" value="${m.hour||''}">
                      <input type="text" class="place" placeholder="Lugar" value="${m.place||''}">`;
      const gh=row.querySelector('.gh'), ga=row.querySelector('.ga');
      const hour=info.querySelector('.hour'), place=info.querySelector('.place');
      const persist=()=>{ m.gh=valInt(gh.value); m.ga=valInt(ga.value); m.hour=hour.value.trim(); m.place=place.value.trim(); save(); render(); };
      gh.addEventListener('input',persist); ga.addEventListener('input',persist);
      hour.addEventListener('change',persist); place.addEventListener('change',persist);
      wrap.appendChild(row); wrap.appendChild(info);
    });
    box.appendChild(wrap);
    // Tabla
    const rows=computeTable(G.matches,G.teams);
    const table=document.createElement('div');
    table.innerHTML=`
      <div style="overflow:auto">
        <table>
          <thead><tr>
            <th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>E</th><th>P</th>
            <th>GF</th><th>GC</th><th>DG</th><th>Pts</th>
          </tr></thead>
          <tbody>
            ${rows.map((r,i)=>`
              <tr class="${i===0?'first':''}">
                <td class="pos">${i+1}</td>
                <td>${r.team}</td>
                <td>${r.PJ}</td>
                <td>${r.G}</td>
                <td>${r.E}</td>
                <td>${r.P}</td>
                <td>${r.GF}</td>
                <td>${r.GC}</td>
                <td>${r.DG}</td>
                <td class="pts">${r.Pts}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;
    box.appendChild(table); root.appendChild(box);
  }
  updateKnockoutSeeds();
}

/* ===== Tema (preview inmediato) ===== */
function applyPreviewTheme(){
  // Fondo general
  document.body.style.background = state.theme?.bg || '#f8fafc';
  // Acento (botones/bordes con var(--accent))
  const color = state.theme?.color || '#0284c7';
  document.documentElement.style.setProperty('--accent', color);
}

/* ===== Generate / Winners / KO ===== */
function generate(){
  state.groups.A.teams=parseTeams($('#ga').value);
  state.groups.B.teams=parseTeams($('#gb').value);
  state.groups.C.teams=parseTeams($('#gc').value);
  state.groups.D.teams=parseTeams($('#gd').value);
  for(const g of ['A','B','C','D']){
    const T=state.groups[g].teams;
    state.groups[g].matches=roundRobin3(T).map(p=>({home:p[0],away:p[1],gh:null,ga:null,hour:'',place:''}));
  }
  state.tournamentName=$('#tournamentName').value.trim();
  save(); render();
}
function groupWinner(gkey){ const G=state.groups[gkey]; if(G.teams.length!==3) return ''; const rows=computeTable(G.matches,G.teams); return rows[0]?.team||''; }
function updateKnockoutSeeds(){
  const A1=groupWinner('A')||'A1', B1=groupWinner('B')||'B1', C1=groupWinner('C')||'C1', D1=groupWinner('D')||'D1';
  const sf1Home=state.knockout.sf1.home || A1;
  const sf1Away=state.knockout.sf1.away || D1;
  const sf2Home=state.knockout.sf2.home || B1;
  const sf2Away=state.knockout.sf2.away || C1;
  $('#sf1h').textContent=sf1Home; $('#sf1a').textContent=sf1Away;
  $('#sf2h').textContent=sf2Home; $('#sf2a').textContent=sf2Away;
  const sf1w=$('#sf1w'); sf1w.innerHTML=`<option value="">— Ganador —</option><option value="${sf1Home}">${sf1Home}</option><option value="${sf1Away}">${sf1Away}</option>`; if(state.knockout.sf1.winner) sf1w.value=state.knockout.sf1.winner;
  const sf2w=$('#sf2w'); sf2w.innerHTML=`<option value="">— Ganador —</option><option value="${sf2Home}">${sf2Home}</option><option value="${sf2Away}">${sf2Away}</option>`; if(state.knockout.sf2.winner) sf2w.value=state.knockout.sf2.winner;
  const w1=state.knockout.sf1.winner || 'Ganador SF1';
  const w2=state.knockout.sf2.winner || 'Ganador SF2';
  const fiHome=state.knockout.final.home || w1;
  const fiAway=state.knockout.final.away || w2;
  $('#fih').textContent=fiHome; $('#fia').textContent=fiAway;
  const fiw=$('#fiw'); fiw.innerHTML=`<option value="">— Campeón —</option>${fiHome!=='Ganador SF1'?`<option value="${fiHome}">${fiHome}</option>`:''}${fiAway!=='Ganador SF2'?`<option value="${fiAway}">${fiAway}</option>`:''}`; if(state.knockout.final.winner) fiw.value=state.knockout.final.winner;
  // Restaurar marcadores
  $('#sf1gh').value=state.knockout.sf1.gh??''; $('#sf1ga').value=state.knockout.sf1.ga??'';
  $('#sf2gh').value=state.knockout.sf2.gh??''; $('#sf2ga').value=state.knockout.sf2.ga??'';
  $('#figh').value=state.knockout.final.gh??''; $('#figa').value=state.knockout.final.ga??'';
  // Rellenar inputs override
  $('#sf1HomeName').value = state.knockout.sf1.home || '';
  $('#sf1AwayName').value = state.knockout.sf1.away || '';
  $('#sf2HomeName').value = state.knockout.sf2.home || '';
  $('#sf2AwayName').value = state.knockout.sf2.away || '';
  $('#fiHomeName').value  = state.knockout.final.home || '';
  $('#fiAwayName').value  = state.knockout.final.away || '';
}

/* ===== Persistencia ===== */
function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{} }
function load(){
  try{
    const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); if(!s) return false;
    Object.assign(state,s);
    $('#ga').value=state.groups.A.teams.join('\n');
    $('#gb').value=state.groups.B.teams.join('\n');
    $('#gc').value=state.groups.C.teams.join('\n');
    $('#gd').value=state.groups.D.teams.join('\n');
    if(state.tournamentName) $('#tournamentName').value=state.tournamentName;
    // Tema -> inputs + preview
    if(state.theme){ 
      $('#themeColor').value = state.theme.color || '#0284c7';
      $('#themeBg').value    = state.theme.bg || '#f8fafc';
      applyPreviewTheme();
    }
    return true;
  }catch{ return false; }
}

/* ===== Exportar/Importar/Publish ===== */
function slug(s){ return String(s).toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
function ts(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`; }
function downloadFile(name, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/json'})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
function stamp(snapshot){
  const now=new Date(); snapshot.updatedAt=now.toISOString();
  try{ snapshot.updatedAtLocal=new Intl.DateTimeFormat(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(now); }
  catch{ snapshot.updatedAtLocal=now.toLocaleString(); }
  return snapshot;
}
function saveCopy(){ const base=$('#tournamentName')?.value?.trim()||'torneo_grupos'; const file=`${slug(base)}_${ts()}.json`; const snap=JSON.parse(JSON.stringify(state)); stamp(snap); downloadFile(file, JSON.stringify(snap,null,2)); }
function clearAll(){ if(!confirm('¿Borrar datos locales?')) return; try{ localStorage.removeItem(STORAGE_KEY);}catch{} location.reload(); }

function importData(){
  const inp=$('#importFile'); const f=inp.files?.[0]; if(!f){ alert('Selecciona un archivo JSON'); return; }
  const rd=new FileReader();
  rd.onload=()=>{ try{
      const obj=JSON.parse(rd.result);
      if(!obj.groups||!obj.knockout) throw new Error('Estructura inválida');
      if(confirm('Esto reemplazará los datos actuales. ¿Continuar?')){
        Object.assign(state,obj);
        $('#ga').value=state.groups.A.teams.join('\n');
        $('#gb').value=state.groups.B.teams.join('\n');
        $('#gc').value=state.groups.C.teams.join('\n');
        $('#gd').value=state.groups.D.teams.join('\n');
        $('#tournamentName').value=state.tournamentName||'';
        // Cargar tema desde import
        $('#themeColor').value = state.theme?.color || '#0284c7';
        $('#themeBg').value    = state.theme?.bg || '#f8fafc';
        applyPreviewTheme();
        save(); render(); updateKnockoutSeeds();
        alert('✅ Datos importados'); inp.value='';
      }
    }catch(e){ alert('❌ Error al importar: '+e.message); } };
  rd.onerror=()=>alert('❌ Error al leer el archivo');
  rd.readAsText(f);
}
function exportData(){ const snap=JSON.parse(JSON.stringify(state)); stamp(snap); const base=$('#tournamentName')?.value?.trim()||'torneo'; const fn=`${slug(base)}_export_${ts()}.json`; downloadFile(fn, JSON.stringify(snap,null,2)); alert('📤 Exportado: '+fn); }

function setPublishStatus(t,cls=''){ const el=$('#publishStatus'); el.textContent=t; el.className=`status ${cls}`; }
async function publishNow(){
  const snap=JSON.parse(JSON.stringify(state)); stamp(snap);
  const btn=$('#btnPublish'); btn.disabled=true; setPublishStatus('⏳','loading');
  try{
    localStorage.setItem('TORNEO_PUBLIC_DATA', JSON.stringify(snap));
    const dataStr=JSON.stringify(snap,null,2);
    const blob=new Blob([dataStr],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='data.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    setPublishStatus('✅','success'); setTimeout(()=>setPublishStatus(''),3000);
    alert('✅ Datos listos.\nSube el archivo descargado como data.json (o renómbralo a data-<slug>.json) a tu repositorio.');
  }catch(e){ console.error(e); setPublishStatus('❌','error'); alert('Error: '+e.message); }
  finally{ btn.disabled=false; }
}

/* ===== Inicialización ===== */
function populateKOInputsFromState(){
  const k=state.knockout||{}, s1=k.sf1||{}, s2=k.sf2||{}, fi=k.final||{};
  // Horas/Lugares
  $('#sf1Hour').value=s1.hour||''; $('#sf1Place').value=s1.place||'';
  $('#sf2Hour').value=s2.hour||''; $('#sf2Place').value=s2.place||'';
  $('#fiHour').value =fi.hour ||''; $('#fiPlace').value =fi.place ||'';
  // Nombres manuales
  $('#sf1HomeName').value=s1.home||''; $('#sf1AwayName').value=s1.away||'';
  $('#sf2HomeName').value=s2.home||''; $('#sf2AwayName').value=s2.away||'';
  $('#fiHomeName').value =fi.home ||''; $('#fiAwayName').value =fi.away ||'';
}
function init(){ const had=load(); if(!had){ generate(); } else { render(); } populateKOInputsFromState(); applyPreviewTheme(); }

/* ===== Listeners ===== */
$('#btnGenerate').addEventListener('click',generate);
$('#btnSaveCopy').addEventListener('click',saveCopy);
$('#btnClearAll').addEventListener('click',clearAll);
$('#btnPublish').addEventListener('click',publishNow);
$('#btnImport').addEventListener('click',importData);
$('#btnExport').addEventListener('click',exportData);
$('#importFile').addEventListener('change',importData);

$('#tournamentName').addEventListener('change',e=>{ state.tournamentName=e.target.value.trim(); save(); });

// KO
['sf1','sf2','final'].forEach(round=>{
  $(`#${round}gh`).addEventListener('input',e=>{ state.knockout[round].gh=valInt(e.target.value); save(); });
  $(`#${round}ga`).addEventListener('input',e=>{ state.knockout[round].ga=valInt(e.target.value); save(); });
  $(`#${round}w`).addEventListener('change',e=>{ state.knockout[round].winner=e.target.value||''; if(round!=='final') updateKnockoutSeeds(); save(); });
  $(`#${round}Hour`).addEventListener('change',e=>{ state.knockout[round].hour=e.target.value.trim(); save(); });
  $(`#${round}Place`).addEventListener('change',e=>{ state.knockout[round].place=e.target.value.trim(); save(); });
});
// KO nombres manuales
$('#sf1HomeName').addEventListener('input',e=>{ state.knockout.sf1.home=e.target.value.trim(); updateKnockoutSeeds(); save(); });
$('#sf1AwayName').addEventListener('input',e=>{ state.knockout.sf1.away=e.target.value.trim(); updateKnockoutSeeds(); save(); });
$('#sf2HomeName').addEventListener('input',e=>{ state.knockout.sf2.home=e.target.value.trim(); updateKnockoutSeeds(); save(); });
$('#sf2AwayName').addEventListener('input',e=>{ state.knockout.sf2.away=e.target.value.trim(); updateKnockoutSeeds(); save(); });
$('#fiHomeName').addEventListener('input',e=>{ state.knockout.final.home=e.target.value.trim(); updateKnockoutSeeds(); save(); });
$('#fiAwayName').addEventListener('input',e=>{ state.knockout.final.away=e.target.value.trim(); updateKnockoutSeeds(); save(); });

// Tema: cambios con preview inmediata
$('#themeColor').addEventListener('input', e=>{
  state.theme.color = e.target.value || '#0284c7';
  applyPreviewTheme(); save();
});
$('#themeBg').addEventListener('input', e=>{
  state.theme.bg = e.target.value || '#f8fafc';
  applyPreviewTheme(); save();
});

init();
</script>
</body>
</html>



