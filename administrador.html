<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrador â€” Torneo 4 Grupos + Semifinales</title>
  <style>
    :root{ --bg:#f8fafc; --panel:#e2e8f0; --card:#ffffff; --muted:#475569; --text:#0f172a; --accent:#0284c7; --ok:#16a34a; --bad:#dc2626; --ring:0 0 0 2px var(--accent) inset; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:20px 16px;border-bottom:2px solid #cbd5e1;background:linear-gradient(90deg,#e2e8f0,#f1f5f9);position:sticky;top:0;z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:clamp(22px,3.2vw,34px)}
    .subtitle{color:var(--muted)}

    .grid{display:grid;gap:16px}
    @media(min-width:1100px){.grid{grid-template-columns:420px 1fr}}

    .card{background:var(--card);border:1px solid #cbd5e1;border-radius:18px;padding:16px;box-shadow:0 3px 10px rgba(0,0,0,.1)}
    .card h2{margin:0 0 12px;font-size:18px}
    label{display:block;margin:8px 0 6px;color:var(--muted)}
    textarea,input[type="text"],input[type="number"],input[type="url"],select{width:100%;background:#f8fafc;color:var(--text);border:1px solid #cbd5e1;border-radius:12px;padding:10px 12px;outline:none}
    textarea:focus,input:focus,select:focus{box-shadow:var(--ring);border-color:transparent}
    textarea{min-height:96px;white-space:pre}
    button{background:linear-gradient(180deg,var(--accent),#0ea5e9);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #cbd5e1}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .spacer{flex:1}

    .groups{display:grid;gap:12px}
    @media(min-width:700px){.groups{grid-template-columns:1fr 1fr}}

    /* Colores por grupo */
    .groupA{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.45)}
    .groupB{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.45)}
    .groupC{background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.45)}
    .groupD{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.45)}

    .groupBox{padding:12px;border-radius:12px;margin-bottom:12px}

    .matches{display:grid;gap:10px;margin-top:10px}
    .match{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;background:#f8fafc;border:1px solid #cbd5e1;border-radius:12px;padding:10px}
    .team{display:flex;align-items:center;gap:10px}
    .team input{max-width:80px;text-align:center}
    .dash{opacity:.6}
    .info{display:flex;gap:8px;margin-top:6px}
    .info input{background:#f8fafc;border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #cbd5e1;text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{font-size:12px;color:var(--muted);font-weight:600}
    tbody tr:hover{background:#e2e8f0}
    .pos{font-variant-numeric:tabular-nums;color:var(--muted)}
    .pts{font-weight:800}
    .first{background:rgba(34,197,94,.15)}
    .note{font-size:12px;color:var(--muted)}

    /* Knockout */
    .bracket{display:grid;gap:12px;margin-top:16px}
    @media(min-width:900px){.bracket{grid-template-columns:1fr 1fr}}
    .semi,.final{background:#ffffff;border:1px solid #cbd5e1;border-radius:12px;padding:12px}
    .semi h3,.final h3{margin:0 0 8px;font-size:16px}

    /* Estado de publicaciÃ³n */
    .status{font-size:12px;padding:4px 8px;border-radius:6px;margin-left:8px}
    .status.success{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
    .status.error{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
    .status.loading{background:#eff6ff;color:#1e40af;border:1px solid#dbeafe}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Administrador â€” Torneo 4 Grupos + Semifinales</h1>
      <div class="subtitle">Crea y gestiona tu torneo. Los datos se guardan localmente y puedes publicarlos online.</div>
    </div>
  </header>

  <main class="container grid">
    <section class="card">
      <h2>1) Equipos por grupo</h2>
      <div class="groups">
        <div><label>Grupo A</label><textarea id="ga">A1
A2
A3</textarea></div>
        <div><label>Grupo B</label><textarea id="gb">B1
B2
B3</textarea></div>
        <div><label>Grupo C</label><textarea id="gc">C1
C2
C3</textarea></div>
        <div><label>Grupo D</label><textarea id="gd">D1
D2
D3</textarea></div>
      </div>
      <div class="row" style="margin-top:8px;align-items:center">
        <input type="text" id="tournamentName" placeholder="Nombre del torneo (opcional)" style="flex:2" />
        <button id="btnGenerate">Generar rol por grupo</button>

        <!-- PUBLICAR -->
        <input type="url" id="publishURL" placeholder="URL del Web App (â€¦/exec)" style="flex:2; min-width:320px" />
        <button id="btnPublish">Publicar <span id="publishStatus"></span></button>

        <div class="spacer"></div>
        <button id="btnSaveCopy" class="ghost">ðŸ’¾ Guardar copia</button>
        <button id="btnClearAll" class="ghost">ðŸ§¹ Limpiar</button>
      </div>
      <div style="margin-top:8px; font-size:12px; color:var(--muted)">
        ðŸ’¡ <strong>Para usar:</strong> 1) Agrega equipos â†’ 2) Genera rol â†’ 3) Ingresa resultados â†’ 4) Publica
      </div>
    </section>

    <section class="card">
      <h2>Grupos y partidos</h2>
      <div id="groupsRoot"></div>

      <div class="bracket">
        <div class="semi">
          <h3>Semifinal 1 â€” A1 vs D1</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf1h">A1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="sf1gh" style="max-width:80px"> <span class="dash">â€”</span>
              <input type="number" min="0" inputmode="numeric" id="sf1ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf1a">D1</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf1w" style="max-width:260px"><option value="">â€” Ganador â€”</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="sf1Hour" placeholder="Hora (ej. 16:00)" style="max-width:180px">
              <input type="text" id="sf1Place" placeholder="Lugar (ej. Estadio)" style="flex:1">
            </div>
          </div>
        </div>
        <div class="semi">
          <h3>Semifinal 2 â€” B1 vs C1</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf2h">B1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="sf2gh" style="max-width:80px"> <span class="dash">â€”</span>
              <input type="number" min="0" inputmode="numeric" id="sf2ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf2a">C1</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf2w" style="max-width:260px"><option value="">â€” Ganador â€”</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="sf2Hour" placeholder="Hora (ej. 17:00)" style="max-width:180px">
              <input type="text" id="sf2Place" placeholder="Lugar (ej. Estadio)" style="flex:1">
            </div>
          </div>
        </div>
        <div class="final" style="grid-column:1/-1">
          <h3>Final</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="fih">Ganador SF1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="figh" style="max-width:80px"> <span class="dash">â€”</span>
              <input type="number" min="0" inputmode="numeric" id="figa" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="fia">Ganador SF2</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige campeÃ³n</label>
            <select id="fiw" style="max-width:260px"><option value="">â€” CampeÃ³n â€”</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="fiHour" placeholder="Hora (ej. 19:00)" style="max-width:180px">
              <input type="text" id="fiPlace" placeholder="Lugar (ej. Estadio)" style="flex:1">
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
// ===== ConfiguraciÃ³n =====
const STORAGE_KEY = 'torneo_grupos_ko_v1';
const $ = (s, r = document) => r.querySelector(s);

// ===== Estado inicial =====
const state = {
  groups: {
    A: { teams: ['A1', 'A2', 'A3'], matches: [] },
    B: { teams: ['B1', 'B2', 'B3'], matches: [] },
    C: { teams: ['C1', 'C2', 'C3'], matches: [] },
    D: { teams: ['D1', 'D2', 'D3'], matches: [] },
  },
  points: { win: 3, draw: 1, loss: 0 },
  knockout: {
    sf1: { gh: null, ga: null, winner: '', hour: '', place: '' },
    sf2: { gh: null, ga: null, winner: '', hour: '', place: '' },
    final: { gh: null, ga: null, winner: '', hour: '', place: '' }
  },
  tournamentName: ''
};

// ===== Funciones auxiliares =====
function parseTeams(txt) {
  return String(txt || '').split('\n').map(s => s.trim()).filter(Boolean);
}

function roundRobin3(teams) {
  if (teams.length !== 3) return [];
  const [t1, t2, t3] = teams;
  return [[t1, t2], [t3, t1], [t2, t3]];
}

function valInt(v) {
  if (v === null || v === undefined || v === '') return null;
  const n = parseInt(v, 10);
  return Number.isFinite(n) && n >= 0 ? n : null;
}

function computeTable(matches, teams) {
  const t = Object.fromEntries(teams.map(x => [x, { team: x, PJ: 0, G: 0, E: 0, P: 0, GF: 0, GC: 0, DG: 0, Pts: 0 }]));
  const cfg = state.points;
  
  for (const m of matches) {
    if (m.gh == null || m.ga == null) continue;
    const H = t[m.home], A = t[m.away];
    if (!H || !A) continue;
    
    H.PJ++; A.PJ++;
    H.GF += m.gh; H.GC += m.ga;
    A.GF += m.ga; A.GC += m.gh;
    
    if (m.gh > m.ga) {
      H.G++; A.P++;
      H.Pts += cfg.win; A.Pts += cfg.loss;
    } else if (m.gh < m.ga) {
      A.G++; H.P++;
      A.Pts += cfg.win; H.Pts += cfg.loss;
    } else {
      H.E++; A.E++;
      H.Pts += cfg.draw; A.Pts += cfg.draw;
    }
  }
  
  for (const x of teams) {
    t[x].DG = t[x].GF - t[x].GC;
  }
  
  return Object.values(t).sort((a, b) =>
    b.Pts - a.Pts || b.DG - a.DG || b.GF - a.GF || a.team.localeCompare(b.team)
  );
}

// ===== Renderizado =====
function render() {
  const root = document.getElementById('groupsRoot');
  root.innerHTML = '';
  const colors = { A: 'groupA', B: 'groupB', C: 'groupC', D: 'groupD' };
  
  for (const g of ['A', 'B', 'C', 'D']) {
    const box = document.createElement('div');
    box.className = `groupBox ${colors[g]}`;
    const G = state.groups[g];
    
    box.innerHTML = `<h3 style="margin:0 0 6px">Grupo ${g}</h3>`;
    
    if (G.teams.length !== 3) {
      const warn = document.createElement('div');
      warn.className = 'note';
      warn.textContent = 'Agrega exactamente 3 equipos (uno por lÃ­nea).';
      box.appendChild(warn);
      root.appendChild(box);
      continue;
    }

    // Partidos
    const matchesWrap = document.createElement('div');
    matchesWrap.className = 'matches';
    
    G.matches.forEach(m => {
      const row = document.createElement('div');
      row.className = 'match';
      row.innerHTML = `
        <div class="team">${m.home}</div>
        <div class="team" style="justify-content:center">
          <input type="number" min="0" class="gh" value="${m.gh ?? ''}" aria-label="Goles ${m.home}">
          <span class="dash">â€”</span>
          <input type="number" min="0" class="ga" value="${m.ga ?? ''}" aria-label="Goles ${m.away}">
        </div>
        <div class="team" style="justify-content:flex-end">${m.away}</div>`;
      
      const info = document.createElement('div');
      info.className = 'info';
      info.innerHTML = `
        <input type="text" class="hour" placeholder="Hora" value="${m.hour || ''}">
        <input type="text" class="place" placeholder="Lugar" value="${m.place || ''}">`;

      const gh = row.querySelector('.gh'), ga = row.querySelector('.ga');
      const hour = info.querySelector('.hour'), place = info.querySelector('.place');
      
      const persist = () => {
        m.gh = valInt(gh.value);
        m.ga = valInt(ga.value);
        m.hour = hour.value.trim();
        m.place = place.value.trim();
        save();
        render();
      };
      
      gh.addEventListener('input', persist);
      ga.addEventListener('input', persist);
      hour.addEventListener('change', persist);
      place.addEventListener('change', persist);

      matchesWrap.appendChild(row);
      matchesWrap.appendChild(info);
    });
    
    box.appendChild(matchesWrap);

    // Tabla
    const rows = computeTable(G.matches, G.teams);
    const table = document.createElement('div');
    table.innerHTML = `
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>E</th><th>P</th>
              <th>GF</th><th>GC</th><th>DG</th><th>Pts</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map((r, i) => `
              <tr class="${i === 0 ? 'first' : ''}">
                <td class="pos">${i + 1}</td>
                <td>${r.team}</td>
                <td>${r.PJ}</td>
                <td>${r.G}</td>
                <td>${r.E}</td>
                <td>${r.P}</td>
                <td>${r.GF}</td>
                <td>${r.GC}</td>
                <td>${r.DG}</td>
                <td class="pts">${r.Pts}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;
    
    box.appendChild(table);
    root.appendChild(box);
  }
  
  updateKnockoutSeeds();
}

function generate() {
  state.groups.A.teams = parseTeams(document.getElementById('ga').value);
  state.groups.B.teams = parseTeams(document.getElementById('gb').value);
  state.groups.C.teams = parseTeams(document.getElementById('gc').value);
  state.groups.D.teams = parseTeams(document.getElementById('gd').value);
  
  for (const g of ['A', 'B', 'C', 'D']) {
    const T = state.groups[g].teams;
    state.groups[g].matches = roundRobin3(T).map(p => ({
      home: p[0], away: p[1], gh: null, ga: null, hour: '', place: ''
    }));
  }
  
  state.tournamentName = document.getElementById('tournamentName').value.trim();
  save();
  render();
}

function groupWinner(gkey) {
  const G = state.groups[gkey];
  if (G.teams.length !== 3) return '';
  const rows = computeTable(G.matches, G.teams);
  return rows[0]?.team || '';
}

function updateKnockoutSeeds() {
  const A1 = groupWinner('A') || 'A1', B1 = groupWinner('B') || 'B1';
  const C1 = groupWinner('C') || 'C1', D1 = groupWinner('D') || 'D1';
  
  document.getElementById('sf1h').textContent = A1;
  document.getElementById('sf1a').textContent = D1;
  document.getElementById('sf2h').textContent = B1;
  document.getElementById('sf2a').textContent = C1;
  
  // Actualizar selects de ganadores
  const sf1w = document.getElementById('sf1w');
  sf1w.innerHTML = `<option value="">â€” Ganador â€”</option>
                   <option value="${A1}">${A1}</option>
                   <option value="${D1}">${D1}</option>`;
  if (state.knockout.sf1.winner) sf1w.value = state.knockout.sf1.winner;
  
  const sf2w = document.getElementById('sf2w');
  sf2w.innerHTML = `<option value="">â€” Ganador â€”</option>
                   <option value="${B1}">${B1}</option>
                   <option value="${C1}">${C1}</option>`;
  if (state.knockout.sf2.winner) sf2w.value = state.knockout.sf2.winner;
  
  const w1 = state.knockout.sf1.winner || 'Ganador SF1';
  const w2 = state.knockout.sf2.winner || 'Ganador SF2';
  
  document.getElementById('fih').textContent = w1;
  document.getElementById('fia').textContent = w2;
  
  const fiw = document.getElementById('fiw');
  fiw.innerHTML = `<option value="">â€” CampeÃ³n â€”</option>
                  ${w1 !== 'Ganador SF1' ? `<option value="${w1}">${w1}</option>` : ''}
                  ${w2 !== 'Ganador SF2' ? `<option value="${w2}">${w2}</option>` : ''}`;
  if (state.knockout.final.winner) fiw.value = state.knockout.final.winner;
  
  // Restaurar marcadores KO
  document.getElementById('sf1gh').value = state.knockout.sf1.gh ?? '';
  document.getElementById('sf1ga').value = state.knockout.sf1.ga ?? '';
  document.getElementById('sf2gh').value = state.knockout.sf2.gh ?? '';
  document.getElementById('sf2ga').value = state.knockout.sf2.ga ?? '';
  document.getElementById('figh').value = state.knockout.final.gh ?? '';
  document.getElementById('figa').value = state.knockout.final.ga ?? '';
}

// ===== Persistencia =====
function save() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.warn('No se pudo guardar en localStorage');
  }
}

function load() {
  try {
    const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');
    if (!s) return false;
    
    Object.assign(state, s);
    document.getElementById('ga').value = state.groups.A.teams.join('\n');
    document.getElementById('gb').value = state.groups.B.teams.join('\n');
    document.getElementById('gc').value = state.groups.C.teams.join('\n');
    document.getElementById('gd').value = state.groups.D.teams.join('\n');
    
    if (state.tournamentName) {
      document.getElementById('tournamentName').value = state.tournamentName;
    }
    
    return true;
  } catch {
    return false;
  }
}

// ===== Exportar/Importar =====
function slug(s) {
  return String(s).toLowerCase().normalize('NFD')
    .replace(/\p{Diacritic}/gu, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

function ts() {
  const d = new Date();
  const p = n => String(n).padStart(2, '0');
  return `${d.getFullYear()}${p(d.getMonth() + 1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`;
}

function downloadFile(name, text) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], { type: 'application/json' }));
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

function saveCopy() {
  const base = document.getElementById('tournamentName')?.value?.trim() || 'torneo_grupos';
  const file = `${slug(base)}_${ts()}.json`;
  const snapshot = JSON.parse(JSON.stringify(state));
  stamp(snapshot);
  downloadFile(file, JSON.stringify(snapshot, null, 2));
}

function stamp(snapshot) {
  const now = new Date();
  snapshot.updatedAt = now.toISOString();
  try {
    snapshot.updatedAtLocal = new Intl.DateTimeFormat(undefined, {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    }).format(now);
  } catch {
    snapshot.updatedAtLocal = now.toLocaleString();
  }
  return snapshot;
}

function clearAll() {
  if (!confirm('Â¿EstÃ¡s seguro de que quieres borrar todos los datos locales?')) return;
  try {
    localStorage.removeItem(STORAGE_KEY);
  } catch {}
  location.reload();
}

// ===== PublicaciÃ³n =====
function setPublishStatus(text, type = '') {
  const statusEl = document.getElementById('publishStatus');
  statusEl.textContent = text;
  statusEl.className = `status ${type}`;
}

async function publishNow() {
  let url = document.getElementById('publishURL')?.value?.trim();
  if (!url) {
    alert('Ingresa la URL del Web App (â€¦/exec) del Publicador');
    return;
  }

  // Asegurar que la URL termina en /exec
  if (!url.endsWith('/exec')) {
    url = url.replace(/\/dev$/, '/exec').replace(/\/$/, '') + '/exec';
  }

  const snapshot = JSON.parse(JSON.stringify(state));
  stamp(snapshot);

  // Mostrar loading
  const btn = document.getElementById('btnPublish');
  const originalText = btn.textContent;
  btn.disabled = true;
  setPublishStatus('â³', 'loading');

  try {
    console.log('Enviando datos a:', url);
    
    // Intentar con fetch
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(snapshot)
    });

    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
    }

    const text = await response.text();
    const data = JSON.parse(text);
    
    if (data && data.ok) {
      setPublishStatus('âœ…', 'success');
      setTimeout(() => setPublishStatus(''), 3000);
      alert('âœ… Publicado correctamente\n' + (data.message || ''));
    } else {
      setPublishStatus('âŒ', 'error');
      alert('âš ï¸ ' + (data.error || text));
    }
  } catch (err) {
    console.error('Error:', err);
    setPublishStatus('âŒ', 'error');
    
    // Intentar con XMLHttpRequest como fallback
    try {
      await publishWithXHR(url, snapshot);
    } catch (xhrError) {
      alert('âŒ No se pudo publicar. Verifica:\nâ€¢ La URL es correcta\nâ€¢ El Web App estÃ¡ desplegado\nâ€¢ Tu conexiÃ³n a internet');
    }
  } finally {
    btn.disabled = false;
  }
}

function publishWithXHR(url, snapshot) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.timeout = 10000;
    
    xhr.onload = function() {
      if (xhr.status === 200) {
        try {
          const data = JSON.parse(xhr.responseText);
          if (data && data.ok) {
            setPublishStatus('âœ…', 'success');
            setTimeout(() => setPublishStatus(''), 3000);
            alert('âœ… Publicado correctamente');
            resolve();
          } else {
            reject(new Error(data.error || 'Error desconocido'));
          }
        } catch (e) {
          reject(new Error('Respuesta invÃ¡lida'));
        }
      } else {
        reject(new Error(`HTTP ${xhr.status}`));
      }
    };
    
    xhr.onerror = xhr.ontimeout = function() {
      reject(new Error('Error de conexiÃ³n'));
    };
    
    xhr.send(JSON.stringify(snapshot));
  });
}

// ===== InicializaciÃ³n =====
function populateKOInputsFromState() {
  const k = state.knockout || {};
  const s1 = k.sf1 || {}, s2 = k.sf2 || {}, fi = k.final || {};
  
  document.getElementById('sf1Hour').value = s1.hour || '';
  document.getElementById('sf1Place').value = s1.place || '';
  document.getElementById('sf2Hour').value = s2.hour || '';
  document.getElementById('sf2Place').value = s2.place || '';
  document.getElementById('fiHour').value = fi.hour || '';
  document.getElementById('fiPlace').value = fi.place || '';
}

function init() {
  const hadData = load();
  if (!hadData) {
    generate();
  } else {
    render();
  }
  populateKOInputsFromState();
}

// ===== Event Listeners =====
document.getElementById('btnGenerate').addEventListener('click', generate);
document.getElementById('btnSaveCopy').addEventListener('click', saveCopy);
document.getElementById('btnClearAll').addEventListener('click', clearAll);
document.getElementById('btnPublish').addEventListener('click', publishNow);

// Guardar nombre del torneo
document.getElementById('tournamentName').addEventListener('change', function(e) {
  state.tournamentName = e.target.value.trim();
  save();
});

// Listeners para knockout
['sf1', 'sf2', 'final'].forEach(round => {
  document.getElementById(`${round}gh`).addEventListener('input', e => {
    state.knockout[round].gh = valInt(e.target.value);
    save();
  });
  document.getElementById(`${round}ga`).addEventListener('input', e => {
    state.knockout[round].ga = valInt(e.target.value);
    save();
  });
  document.getElementById(`${round}w`).addEventListener('change', e => {
    state.knockout[round].winner = e.target.value || '';
    if (round !== 'final') updateKnockoutSeeds();
    save();
  });
  document.getElementById(`${round}Hour`).addEventListener('change', e => {
    state.knockout[round].hour = e.target.value.trim();
    save();
  });
  document.getElementById(`${round}Place`).addEventListener('change', e => {
    state.knockout[round].place = e.target.value.trim();
    save();
  });
});

// Iniciar
init();
</script>
</body>
</html>