<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visor ‚Äî Torneo de B√©isbol</title>
  <style>
    :root { --accent:#0284c7; --bg:#f8fafc; --panel:#e2e8f0; --card:#ffffff; --muted:#475569; --text:#0f172a; --ok:#16a34a; --bad:#dc2626; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    header{padding:20px 16px;border-bottom:2px solid #cbd5e1;background:linear-gradient(90deg,var(--panel),#f1f5f9);position:sticky;top:0;z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:clamp(22px,3.2vw,34px)} .subtitle{color:var(--muted);margin-top:4px}
    .card{background:var(--card);border:1px solid #cbd5e1;border-radius:18px;padding:16px;box-shadow:0 3px 10px rgba(0,0,0,.1);margin-bottom:16px}
    .groups{display:grid;gap:12px} @media(min-width:700px){.groups{grid-template-columns:1fr 1fr}}
    .groupA{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.45)} .groupB{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.45)}
    .groupBox{padding:12px;border-radius:12px;margin-bottom:12px}
    .matches{display:grid;gap:10px;margin-top:10px}
    .match{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;background:#f8fafc;border:1px solid #cbd5e1;border-radius:12px;padding:10px}
    .team{display:flex;align-items:center;gap:10px} .dash{opacity:.6}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #cbd5e1;text-align:right}
    th:first-child,td:first-child{text-align:left} thead th{font-size:12px;color:var(--muted);font-weight:600}
    tbody tr:hover{background:#e2e8f0} .pos{font-variant-numeric:tabular-nums;color:var(--muted)} .pts{font-weight:800} .first{background:rgba(34,197,94,.15)}
    .bracket{display:grid;gap:12px;margin-top:16px} @media(min-width:900px){.bracket{grid-template-columns:1fr 1fr}}
    .semi,.final,.third{background:#fff;border:1px solid #cbd5e1;border-radius:12px;padding:12px}
    .final{position:relative;border:2px solid var(--accent);box-shadow:0 0 0 4px rgba(2,132,199,.12) inset;overflow:hidden}
    .final::before{content:'FINAL üèÜ';position:absolute;top:12px;right:-48px;transform:rotate(45deg);background:var(--accent);color:#fff;font-weight:700;font-size:14px;padding:4px 48px;box-shadow:0 2px 6px rgba(0,0,0,.15);opacity:.9}
    .winner{color:var(--ok);font-weight:800}
    .loading,.error{text-align:center;padding:20px;color:var(--muted)} .error{color:var(--bad)}
    .champion{text-align:center;padding:20px;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:18px;margin:20px 0;border:2px solid #f59e0b}
    .champion h2{color:#92400e;margin-bottom:10px} .champion .team-name{font-size:24px;font-weight:bold;color:#92400e}
    .cover{text-align:center;padding:40px 20px;margin-bottom:30px;border-radius:18px;background:linear-gradient(135deg,var(--accent),color-mix(in srgb,var(--accent) 80%, black));color:#fff;box-shadow:0 8px 25px rgba(0,0,0,.15);position:relative;overflow:hidden}
    .cover h1{font-size:clamp(28px,4vw,48px);margin-bottom:10px} .cover .subtitle{color:rgba(255,255,255,.9);font-size:clamp(16px,2vw,20px);margin-bottom:15px}
    .cover .update-info{background:rgba(255,255,255,.2);backdrop-filter:blur(10px);padding:8px 16px;border-radius:20px;font-size:14px;display:inline-block;border:1px solid rgba(255,255,255,.3)}
    .mercyTag{display:inline-block;font-size:12px;background:#fde68a;border:1px solid #f59e0b;color:#92400e;padding:2px 8px;border-radius:999px;margin-left:8px;font-weight:700}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 id="tournamentTitle">Torneo de B√©isbol</h1>
      <div class="subtitle" id="tournamentSubtitle">Visualizaci√≥n de resultados</div>
    </div>
  </header>

  <main class="container">
    <div id="tournamentContent"><div class="loading">Cargando datos del torneo...</div></div>
  </main>

  <script>
    function getJsonFileNameFromUrl(){
      const p = new URLSearchParams(location.search).get('t');
      if (p) return p.includes('.')?p:`${p}.json`;
      return 'data.json';
    }

    function applyTheme(theme){
      if (!theme) return;
      const accent = theme.color || '#0284c7';
      const bg = theme.bg || '#f8fafc';
      document.documentElement.style.setProperty('--accent', accent);
      document.documentElement.style.setProperty('--bg', bg);
      document.body.style.background = bg;
      const header = document.querySelector('header');
      header.style.background = `linear-gradient(90deg, color-mix(in srgb, ${accent} 15%, white), color-mix(in srgb, ${accent} 8%, white))`;
    }

    // ---- BEISBOL: tabla y desempates ----
    function computeBaseballTable(matches, teams){
      const table = Object.fromEntries(teams.map(t=>[t,{team:t,JJ:0,G:0,P:0,CF:0,CC:0,DIF:0,PCT:0}]));
      (matches||[]).forEach(m=>{
        if (!m || m.gh==null || m.ga==null) return;
        const h=table[m.home], a=table[m.away]; if(!h||!a) return;
        h.JJ++; a.JJ++; h.CF+=m.gh; h.CC+=m.ga; a.CF+=m.ga; a.CC+=m.gh;
        if (m.gh>m.ga){h.G++;a.P++;} else if (m.ga>m.gh){a.G++;h.P++;}
      });
      teams.forEach(t=>{ const r=table[t]; r.DIF=r.CF-r.CC; const tot=r.G+r.P; r.PCT=tot>0?+(r.G/tot).toFixed(3):0; });

      let rows = Object.values(table).sort((a,b)=> b.PCT-a.PCT || a.team.localeCompare(b.team));

      function subOrder(block){
        const names = block.map(r=>r.team);
        const subM = (matches||[]).filter(m=>m && names.includes(m.home) && names.includes(m.away) && m.gh!=null && m.ga!=null);
        const subT = computeBaseballTable(subM, names);
        const map = Object.fromEntries(subT.map(r=>[r.team,r]));
        return [...block].sort((x,y)=>{
          const A=map[x.team]||{PCT:0,DIF:0,CF:0,CC:999999};
          const B=map[y.team]||{PCT:0,DIF:0,CF:0,CC:999999};
          return (B.PCT-A.PCT) || (B.DIF-A.DIF) || (B.CF-A.CF) || (A.CC-B.CC) || x.team.localeCompare(y.team);
        });
      }
      let i=0, final=[]; 
      while(i<rows.length){
        const pct=rows[i].PCT; let j=i; while(j<rows.length && rows[j].PCT===pct) j++;
        const block=rows.slice(i,j); final.push(...(block.length>1?subOrder(block):block)); i=j;
      }
      return final;
    }

    function renderMatch(m,defH,defA,mercy){
      const _m = Object.assign({gh:null,ga:null,hour:'',place:'',inning:''}, m||{});
      const has = _m.gh!=null && _m.ga!=null;
      const homeWin = has && _m.gh>_m.ga, awayWin = has && _m.ga>_m.gh;
      const mercyShow = mercy && _m.inning && ( (parseInt(_m.inning,10)>=3 && Math.abs(_m.gh-_m.ga)>=15) || (parseInt(_m.inning,10)>=4 && Math.abs(_m.gh-_m.ga)>=10) );
      return `
        <div class="match">
          <div class="team ${homeWin?'winner':''}">${_m.home||defH||'Equipo A'}</div>
          <div class="match-result">${has?`${_m.gh} <span class="dash">‚Äî</span> ${_m.ga}`:'<span class="dash">-</span>'}${mercyShow?'<span class="mercyTag">Mercy</span>':''}</div>
          <div class="team ${awayWin?'winner':''}" style="justify-content:flex-end">${_m.away||defA||'Equipo B'}</div>
        </div>
        ${(_m.hour||_m.place)?`<div class="info" style="display:flex;gap:8px;color:var(--muted);font-size:14px">${_m.hour?`<span>üïí ${_m.hour}</span>`:''}${_m.place?`<span>üìç ${_m.place}</span>`:''}</div>`:''}
      `;
    }

    function renderCover(d){
      const acc = d.theme?.color || '#0284c7';
      const up = d.updatedAtLocal || '';
      return `
        <div class="cover" style="background:linear-gradient(135deg, ${acc}, color-mix(in srgb, ${acc} 80%, black))">
          <h1>${d.tournamentName||'Torneo de B√©isbol'}</h1>
          <div class="subtitle">${d.subtitle||'Visualizaci√≥n de resultados'}</div>
          ${up?`<div class="update-info">üìÖ √öltima actualizaci√≥n: ${up}</div>`:''}
        </div>
      `;
    }

    function renderGroups(groups){
      let html = '<div class="card"><h2>Fase de Grupos</h2><div class="groups">';
      ['A','B'].forEach(k=>{
        const g = groups[k]; if (!g || !g.teams?.length) return;
        const teams = g.teams, matches = g.matches||[];
        html += `<div class="groupBox group${k}"><h3>Grupo ${k}</h3><div class="matches">`;
        matches.forEach(m=> html += renderMatch(m, m.home, m.away, false));
        html += `</div>`;
        const table = computeBaseballTable(matches, teams);
        html += `
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>#</th><th>Equipo</th><th>JJ</th><th>G</th><th>P</th><th>CF</th><th>CC</th><th>DIF</th><th>PCT</th></tr>
              </thead>
              <tbody>
                ${table.map((r,i)=>`
                  <tr class="${i===0?'first':''}">
                    <td class="pos">${i+1}</td>
                    <td>${r.team}</td>
                    <td>${r.JJ}</td><td>${r.G}</td><td>${r.P}</td>
                    <td>${r.CF}</td><td>${r.CC}</td><td>${r.DIF}</td>
                    <td class="pts">${r.PCT.toFixed(3)}</td>
                  </tr>`).join('')}
              </tbody>
            </table>
            <div style="font-size:12px;color:var(--muted);margin-top:6px">
              Desempates: PCT ‚Üí Enfrentamiento directo ‚Üí DIF directo ‚Üí CF directo ‚Üí Menos CC directo ‚Üí sorteo.
            </div>
          </div>
        `;
        html += `</div>`;
      });
      html += '</div></div>';
      return html;
    }

    function renderKnockout(k){
      if (!k) return '';
      let html = '';
      if (k.final?.winner){
        html += `<div class="champion"><h2>üèÜ CAMPE√ìN üèÜ</h2><div class="team-name">${k.final.winner}</div></div>`;
      }
      html += `
        <div class="card">
          <h2>Fase Eliminatoria</h2>
          <div class="bracket">
            <div class="semi">
              <h3>Semifinal 1</h3>
              ${renderMatch(k.sf1, k.sf1.home||'A1', k.sf1.away||'B2', true)}
              ${k.sf1?.winner?`<div class="info"><strong>Ganador: ${k.sf1.winner}</strong></div>`:''}
            </div>
            <div class="semi">
              <h3>Semifinal 2</h3>
              ${renderMatch(k.sf2, k.sf2.home||'B1', k.sf2.away||'A2', true)}
              ${k.sf2?.winner?`<div class="info"><strong>Ganador: ${k.sf2.winner}</strong></div>`:''}
            </div>
            <div class="third">
              <h3>Tercer Lugar</h3>
              ${renderMatch(k.third, k.third.home||'Perdedor SF1', k.third.away||'Perdedor SF2', true)}
              ${k.third?.winner?`<div class="info"><strong>Tercero: ${k.third.winner}</strong></div>`:''}
            </div>
            <div class="final">
              <h3>Final</h3>
              ${renderMatch(k.final, k.final.home||'Ganador SF1', k.final.away||'Ganador SF2', true)}
              ${k.final?.winner?`<div class="info"><strong>üèÜ Campe√≥n: ${k.final.winner}</strong></div>`:''}
            </div>
          </div>
        </div>
      `;
      return html;
    }

    async function loadTournamentData(){
      const fileName = getJsonFileNameFromUrl();
      try{
        document.getElementById('tournamentContent').innerHTML = '<div class="loading">Cargando datos del torneo...</div>';
        const res = await fetch(fileName, {cache:'no-store'});
        if (!res.ok) throw new Error('No se pudo cargar '+fileName+' ('+res.status+')');
        let data = await res.json();
        // normalizar m√≠nimo
        data = data || {};
        data.theme = Object.assign({color:'#0284c7',bg:'#f8fafc'}, data.theme||{});
        applyTheme(data.theme);
        document.getElementById('tournamentTitle').textContent = data.tournamentName || 'Torneo de B√©isbol';
        document.getElementById('tournamentSubtitle').textContent = data.subtitle || 'Visualizaci√≥n de resultados';

        let html = '';
        html += `
          <div class="cover" style="background:linear-gradient(135deg, ${data.theme.color}, color-mix(in srgb, ${data.theme.color} 80%, black))">
            <h1>${data.tournamentName||'Torneo de B√©isbol'}</h1>
            <div class="subtitle">${data.subtitle||'Visualizaci√≥n de resultados'}</div>
            ${data.updatedAtLocal?`<div class="cover update-info">üìÖ √öltima actualizaci√≥n: ${data.updatedAtLocal}</div>`:''}
          </div>
        `;
        if (data.groups) html += renderGroups(data.groups);
        if (data.knockout) html += renderKnockout(data.knockout);
        document.getElementById('tournamentContent').innerHTML = html;
      }catch(err){
        document.getElementById('tournamentContent').innerHTML = `<div class="error"><h3>Error</h3><p>${err.message}</p><p>Archivo: <strong>${fileName}</strong></p></div>`;
        console.error(err);
      }
    }

    document.addEventListener('DOMContentLoaded', loadTournamentData);
  </script>
</body>
</html>
