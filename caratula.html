<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Car√°tula ‚Äî Torneo</title>
  <style>
    :root{ --bg:#f8fafc; --card:#ffffff; --muted:#475569; --text:#0f172a; --line:#cbd5e1; --accent:#0284c7; --ok:#16a34a; --bad:#dc2626; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:18px 16px;border-bottom:2px solid var(--line);background:linear-gradient(90deg,#e2e8f0,#f1f5f9)}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:16px}
    .groups{display:grid;gap:14px}
    @media(min-width:900px){.groups{grid-template-columns:1fr 1fr}}
    .group{padding:12px;border-radius:12px;border:1px solid var(--line)}
    .A{background:rgba(56,189,248,.10)}.B{background:rgba(168,85,247,.10)}
    .C{background:rgba(251,191,36,.10)}.D{background:rgba(34,197,94,.10)}
    .match{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;background:#f8fafc;border:1px solid var(--line);border-radius:10px;padding:8px;margin:4px 0}
    .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#ecfeff;border:1px solid #a5f3fc;color:#0369a1}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:6px 8px;border-bottom:1px solid var(--line);text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{font-size:12px;color:#64748b}
    .pts{font-weight:800}
    .loading{text-align:center;padding:40px;color:var(--muted)}
    .error{text-align:center;padding:20px;color:var(--bad);background:#fef2f2;border-radius:10px;margin:10px 0}
    .update-btn{background:var(--accent);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;margin:10px 0}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 id="title">Car√°tula ‚Äî Torneo</h1>
      <div id="subtitle">Cargando datos del torneo...</div>
    </div>
  </header>

  <main class="container">
    <div id="loading" class="loading">üîÑ Cargando datos del torneo...</div>
    <div id="error" class="error" style="display:none"></div>
    <div id="content" style="display:none">
      <button onclick="loadData()" class="update-btn">üîÑ Actualizar Datos</button>
      <div class="card">
        <h2>Grupos</h2>
        <div id="groupsRoot" class="groups"></div>
      </div>
      <div class="card">
        <h2>Fase Final</h2>
        <div id="koRoot"></div>
      </div>
      <div id="lastUpdate" style="text-align:center;color:var(--muted);margin-top:20px;font-size:14px"></div>
    </div>
  </main>

  <script>
    // ===== FUENTES DE DATOS =====
    const DATA_SOURCES = [
      // Opci√≥n 1: Archivo data.json en el repositorio
      'data.json',
      // Opci√≥n 2: Datos locales (si el administrador est√° en la misma p√°gina)
      () => {
        const local = localStorage.getItem('TORNEO_PUBLIC_DATA');
        return local ? JSON.parse(local) : null;
      }
    ];

    // ===== CARGAR DATOS =====
    async function loadData() {
      try {
        showLoading();
        
        let data = null;
        
        // Intentar cada fuente de datos
        for (const source of DATA_SOURCES) {
          try {
            if (typeof source === 'function') {
              data = source();
            } else {
              const response = await fetch(source);
              if (response.ok) {
                data = await response.json();
              }
            }
            
            if (data) break; // Si encontramos datos, salir del loop
          } catch (e) {
            console.log(`Fuente ${source} fall√≥:`, e);
          }
        }
        
        if (!data) {
          throw new Error('No se pudieron cargar los datos del torneo');
        }
        
        render(data);
        
      } catch (error) {
        showError('‚ùå Error cargando datos: ' + error.message);
        console.error('Error:', error);
      }
    }

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';
      document.getElementById('content').style.display = 'none';
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').textContent = message;
      document.getElementById('content').style.display = 'none';
    }

    function showContent() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }

    // ===== RENDERIZADO =====
    function render(state) {
      showContent();
      
      // T√≠tulo
      if (state.tournamentName) {
        document.getElementById('title').textContent = state.tournamentName;
        document.getElementById('subtitle').textContent = 'Estado actual del torneo';
      }
      
      // Grupos
      renderGroups(state);
      
      // Fase final
      renderKO(state);
      
      // √öltima actualizaci√≥n
      const updateTime = state.updatedAt || state.publishedAt;
      if (updateTime) {
        const date = new Date(updateTime);
        document.getElementById('lastUpdate').textContent = 
          '√öltima actualizaci√≥n: ' + date.toLocaleString();
      }
    }

    function renderGroups(state) {
      const container = document.getElementById('groupsRoot');
      const groups = state.groups || {};
      
      if (Object.keys(groups).length === 0) {
        container.innerHTML = '<div class="group">No hay grupos configurados</div>';
        return;
      }
      
      let html = '';
      
      for (const [groupKey, group] of Object.entries(groups)) {
        const teams = group.teams || [];
        const matches = group.matches || [];
        
        html += `
          <div class="group ${groupKey}">
            <h3>Grupo ${groupKey}</h3>
            <div style="margin-bottom: 12px; font-size: 14px; color: var(--muted)">
              Equipos: ${teams.length ? teams.join(', ') : 'Por definir'}
            </div>
            ${renderGroupMatches(matches)}
            ${renderGroupTable(matches, teams, state.points)}
          </div>
        `;
      }
      
      container.innerHTML = html;
    }

    function renderGroupMatches(matches) {
      if (!matches.length) {
        return '<div style="color: var(--muted); font-size: 14px">No hay partidos programados</div>';
      }
      
      let html = '<div style="margin-bottom: 12px">';
      
      matches.forEach(match => {
        const hasScore = match.gh != null && match.ga != null;
        const score = hasScore ? `${match.gh} ‚Äî ${match.ga}` : '<span class="badge">Programado</span>';
        
        html += `
          <div class="match">
            <div>${match.home || '‚Äî'}</div>
            <div style="font-weight: 800; text-align: center">${score}</div>
            <div style="text-align: right">${match.away || '‚Äî'}</div>
          </div>
        `;
        
        if (match.hour || match.place) {
          html += `<div style="font-size: 12px; color: var(--muted); margin: 2px 0 8px 0">
            ${match.hour ? 'üïí ' + match.hour : ''} ${match.place ? 'üìç ' + match.place : ''}
          </div>`;
        }
      });
      
      html += '</div>';
      return html;
    }

    function renderGroupTable(matches, teams, pointsConfig) {
      const playedMatches = matches.filter(m => m.gh != null && m.ga != null);
      
      if (playedMatches.length === 0) {
        return '<div style="color: var(--muted); font-size: 14px">La tabla se mostrar√° cuando se jueguen partidos</div>';
      }
      
      const tableData = computeTable(matches, teams, pointsConfig);
      
      return `
        <div style="overflow-x: auto">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>E</th><th>P</th>
                <th>GF</th><th>GC</th><th>DG</th><th>Pts</th>
              </tr>
            </thead>
            <tbody>
              ${tableData.map((team, index) => `
                <tr>
                  <td>${index + 1}</td>
                  <td><strong>${team.team}</strong></td>
                  <td>${team.PJ}</td>
                  <td>${team.G}</td>
                  <td>${team.E}</td>
                  <td>${team.P}</td>
                  <td>${team.GF}</td>
                  <td>${team.GC}</td>
                  <td>${team.DG}</td>
                  <td class="pts">${team.Pts}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function computeTable(matches, teams, points = {win: 3, draw: 1, loss: 0}) {
      const table = {};
      
      // Inicializar equipos
      teams.forEach(team => {
        table[team] = { team, PJ: 0, G: 0, E: 0, P: 0, GF: 0, GC: 0, DG: 0, Pts: 0 };
      });
      
      // Procesar partidos
      matches.forEach(match => {
        if (match.gh == null || match.ga == null) return;
        
        const home = table[match.home];
        const away = table[match.away];
        if (!home || !away) return;
        
        // Actualizar estad√≠sticas
        home.PJ++; away.PJ++;
        home.GF += match.gh; home.GC += match.ga;
        away.GF += match.ga; away.GC += match.gh;
        
        if (match.gh > match.ga) {
          home.G++; away.P++;
          home.Pts += points.win; away.Pts += points.loss;
        } else if (match.gh < match.ga) {
          away.G++; home.P++;
          away.Pts += points.win; home.Pts += points.loss;
        } else {
          home.E++; away.E++;
          home.Pts += points.draw; away.Pts += points.draw;
        }
      });
      
      // Calcular diferencia de goles
      teams.forEach(team => {
        table[team].DG = table[team].GF - table[team].GC;
      });
      
      // Ordenar
      return Object.values(table).sort((a, b) => {
        return b.Pts - a.Pts || b.DG - a.DG || b.GF - a.GF || a.team.localeCompare(b.team);
      });
    }

    function renderKO(state) {
      const container = document.getElementById('koRoot');
      const ko = state.knockout || {};
      
      const rounds = [
        { id: 'sf1', title: 'Semifinal 1' },
        { id: 'sf2', title: 'Semifinal 2' }, 
        { id: 'final', title: 'Final' }
      ];
      
      let html = '<div style="display: grid; gap: 16px;">';
      
      rounds.forEach(round => {
        const data = ko[round.id] || {};
        const hasScore = data.gh != null && data.ga != null;
        const score = hasScore ? `${data.gh} ‚Äî ${data.ga}` : '<span class="badge">Programado</span>';
        
        html += `
          <div style="border: 1px solid var(--line); border-radius: 10px; padding: 12px;">
            <h3 style="margin: 0 0 8px 0">${round.title}</h3>
            <div class="match">
              <div>${data.home || 'Por definir'}</div>
              <div style="font-weight: 800; text-align: center">${score}</div>
              <div style="text-align: right">${data.away || 'Por definir'}</div>
            </div>
            ${data.hour || data.place ? `
              <div style="font-size: 12px; color: var(--muted); margin-top: 6px">
                ${data.hour ? 'üïí ' + data.hour : ''} ${data.place ? 'üìç ' + data.place : ''}
              </div>
            ` : ''}
            ${round.id === 'final' && data.winner ? `
              <div style="margin-top: 8px; font-weight: 800; color: var(--ok)">
                üèÜ Campe√≥n: ${data.winner}
              </div>
            ` : ''}
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // ===== INICIALIZACI√ìN =====
    // Cargar datos al iniciar
    loadData();
    
    // Recargar cada 2 minutos
    setInterval(loadData, 120000);
    
    // Tambi√©n recargar cuando la p√°gina gana foco
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        loadData();
      }
    });
  </script>
</body>
</html>
