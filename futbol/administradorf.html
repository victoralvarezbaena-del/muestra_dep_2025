<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrador â€” Torneo FÃºtbol 4 Grupos + Semifinales</title>
  <style>
    :root{ --bg:#f8fafc; --panel:#e2e8f0; --card:#ffffff; --muted:#475569; --text:#0f172a; --accent:#0284c7; --ok:#16a34a; --bad:#dc2626; --ring:0 0 0 2px var(--accent) inset; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:20px 16px;border-bottom:2px solid #cbd5e1;background:linear-gradient(90deg,#e2e8f0,#f1f5f9);position:sticky;top:0;z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:clamp(22px,3.2vw,34px)}
    .subtitle{color:var(--muted)}

    .grid{display:grid;gap:16px}
    @media(min-width:1100px){.grid{grid-template-columns:420px 1fr}}

    .card{background:var(--card);border:1px solid #cbd5e1;border-radius:18px;padding:16px;box-shadow:0 3px 10px rgba(0,0,0,.1)}
    .card h2{margin:0 0 12px;font-size:18px}
    label{display:block;margin:8px 0 6px;color:var(--muted)}
    textarea,input[type="text"],input[type="number"],input[type="url"],select,input[type="file"],input[type="color"]{width:100%;background:#f8fafc;color:var(--text);border:1px solid #cbd5e1;border-radius:12px;padding:10px 12px;outline:none}
    textarea:focus,input:focus,select:focus{box-shadow:var(--ring);border-color:transparent}
    textarea{min-height:96px;white-space:pre}
    button{background:linear-gradient(180deg,var(--accent),#0ea5e9);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #cbd5e1}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}

    .groups{display:grid;gap:12px}
    @media(min-width:700px){.groups{grid-template-columns:1fr 1fr}}

    /* Colores por grupo */
    .groupA{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.45)}
    .groupB{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.45)}
    .groupC{background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.45)}
    .groupD{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.45)}

    .groupBox{padding:12px;border-radius:12px;margin-bottom:12px}

    .matches{display:grid;gap:10px;margin-top:10px}
    .match{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;background:#f8fafc;border:1px solid #cbd5e1;border-radius:12px;padding:10px}
    .team{display:flex;align-items:center;gap:10px}
    .team input{max-width:80px;text-align:center}
    .dash{opacity:.6}
    .info{display:flex;gap:8px;margin-top:6px}
    .info input{background:#f8fafc;border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #cbd5e1;text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{font-size:12px;color:var(--muted);font-weight:600}
    tbody tr:hover{background:#e2e8f0}
    .pos{font-variant-numeric:tabular-nums;color:var(--muted)}
    .pts{font-weight:800}
    .first{background:rgba(34,197,94,.15)}
    .note{font-size:12px;color:var(--muted)}

    /* Knockout */
    .bracket{display:grid;gap:12px;margin-top:16px}
    @media(min-width:900px){.bracket{grid-template-columns:1fr 1fr}}
    .semi,.final,.third-place{background:#ffffff;border:1px solid #cbd5e1;border-radius:12px;padding:12px}
    .semi h3,.final h3,.third-place h3{margin:0 0 8px;font-size:16px}

    /* Estado de publicaciÃ³n */
    .status{font-size:12px;padding:4px 8px;border-radius:6px;margin-left:8px}
    .status.success{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
    .status.error{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
    .status.loading{background:#eff6ff;color:#1e40af;border:1px solid#dbeafe}

    /* Import/Export section */
    .import-export{background:#f0f9ff;border:2px dashed #bae6fd;border-radius:12px;padding:16px;margin-top:12px}
    .import-export h3{margin:0 0 12px;font-size:16px;color:#0369a1}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Administrador â€” Torneo FÃºtbol 4 Grupos + Semifinales</h1>
      <div class="subtitle">Crea y gestiona tu torneo de fÃºtbol. Los datos se guardan localmente y puedes publicarlos online.</div>
    </div>
  </header>

  <main class="container grid">
    <section class="card">
      <h2>1) Equipos por grupo</h2>
      <div class="groups">
        <div><label>Grupo A</label><textarea id="ga">A1
A2
A3</textarea></div>
        <div><label>Grupo B</label><textarea id="gb">B1
B2
B3</textarea></div>
        <div><label>Grupo C</label><textarea id="gc">C1
C2
C3</textarea></div>
        <div><label>Grupo D</label><textarea id="gd">D1
D2
D3</textarea></div>
      </div>

      <!-- ConfiguraciÃ³n de puntos -->
      <div class="row" style="margin-top:12px">
        <label style="margin:0;color:var(--muted)">Sistema de puntos:</label>
        <select id="pointsSystem" style="max-width:180px">
          <option value="3-1-0">Victoria=3, Empate=1, Derrota=0</option>
          <option value="2-1-0">Victoria=2, Empate=1, Derrota=0</option>
        </select>
      </div>

      <!-- Tema (colores) -->
      <div class="row" style="margin-top:8px">
        <input type="text" id="tournamentName" placeholder="Nombre del torneo (opcional)" style="flex:2" />
        <div style="display:flex; gap:8px; align-items:center">
          <label for="themeColor" style="margin:0;color:var(--muted)">Acento</label>
          <input type="color" id="themeColor" value="#0284c7" style="width:54px;padding:0">
          <label for="themeBg" style="margin:0;color:var(--muted)">Fondo</label>
          <input type="color" id="themeBg" value="#f8fafc" style="width:54px;padding:0">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnGenerate">Generar fixture por grupo</button>

        <!-- PUBLICAR (para GH Pages descarga data.json) -->
        <input type="url" id="publishURL" placeholder="(Opcional para otros backends)" style="flex:2; min-width:320px" />
        <button id="btnPublish">Publicar <span id="publishStatus"></span></button>

        <div class="spacer"></div>
        <button id="btnSaveCopy" class="ghost">ðŸ’¾ Guardar copia</button>
        <button id="btnClearAll" class="ghost">ðŸ§¹ Limpiar</button>
      </div>

      <!-- SECCIÃ“N IMPORTAR/EXPORTAR -->
      <div class="import-export">
        <h3>ðŸ“¥ Importar / ðŸ“¤ Exportar Datos</h3>
        <div class="row">
          <input type="file" id="importFile" accept=".json" style="flex:2">
          <button id="btnImport" class="ghost">ðŸ“¥ Importar JSON</button>
          <button id="btnExport" class="ghost">ðŸ“¤ Exportar JSON</button>
        </div>
        <div style="font-size:12px; color:var(--muted); margin-top:8px">
          ðŸ’¡ Puedes importar un archivo JSON anterior para continuar donde lo dejaste
        </div>
      </div>

      <div style="margin-top:8px; font-size:12px; color:var(--muted)">
        ðŸ’¡ <strong>Para usar:</strong> 1) Agrega equipos â†’ 2) Genera fixture â†’ 3) Ingresa resultados â†’ 4) Publica
      </div>
    </section>

    <section class="card">
      <h2>Grupos y partidos</h2>
      <div id="groupsRoot"></div>

      <div class="bracket">
        <div class="semi">
          <h3>Semifinal 1 â€” A1 vs D1</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf1h">A1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="sf1gh" style="max-width:80px"> <span class="dash">â€”</span>
              <input type="number" min="0" inputmode="numeric" id="sf1ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf1a">D1</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf1w" style="max-width:260px"><option value="">â€” Ganador â€”</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="sf1Hour" placeholder="Hora (ej. 16:00)" style="max-width:180px">
              <input type="text" id="sf1Place" placeholder="Lugar (ej. Estadio)" style="flex:1">
            </div>
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf1HomeName" placeholder="Nombre semifinalista local (opcional)" style="flex:1">
            <input type="text" id="sf1AwayName" placeholder="Nombre semifinalista visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="semi">
          <h3>Semifinal 2 â€” B1 vs C1</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf2h">B1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="sf2gh" style="max-width:80px"> <span class="dash">â€”</span>
              <input type="number" min="0" inputmode="numeric" id="sf2ga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf2a">C1</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf2w" style="max-width:260px"><option value="">â€” Ganador â€”</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="sf2Hour" placeholder="Hora (ej. 17:00)" style="max-width:180px">
              <input type="text" id="sf2Place" placeholder="Lugar (ej. Estadio)" style="flex:1">
            </div>
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf2HomeName" placeholder="Nombre semifinalista local (opcional)" style="flex:1">
            <input type="text" id="sf2AwayName" placeholder="Nombre semifinalista visita (opcional)" style="flex:1">
          </div>
        </div>

        <!-- PARTIDO POR EL TERCER LUGAR -->
        <div class="third-place">
          <h3>Tercer Lugar â€” Perdedor SF1 vs Perdedor SF2</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="thirdh">Perdedor SF1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="thirdgh" style="max-width:80px"> <span class="dash">â€”</span>
              <input type="number" min="0" inputmode="numeric" id="thirdga" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="thirda">Perdedor SF2</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige tercer lugar</label>
            <select id="thirdw" style="max-width:260px"><option value="">â€” Tercer Lugar â€”</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="thirdHour" placeholder="Hora (ej. 18:00)" style="max-width:180px">
              <input type="text" id="thirdPlace" placeholder="Lugar (ej. Estadio)" style="flex:1">
            </div>
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="thirdHomeName" placeholder="Nombre local (opcional)" style="flex:1">
            <input type="text" id="thirdAwayName" placeholder="Nombre visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="final" style="grid-column:1/-1">
          <h3>Final</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="fih">Ganador SF1</span></div>
            <div class="team" style="justify-content:center">
              <input type="number" min="0" inputmode="numeric" id="figh" style="max-width:80px"> <span class="dash">â€”</span>
              <input type="number" min="0" inputmode="numeric" id="figa" style="max-width:80px">
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="fia">Ganador SF2</span></div>
          </div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige campeÃ³n</label>
            <select id="fiw" style="max-width:260px"><option value="">â€” CampeÃ³n â€”</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="fiHour" placeholder="Hora (ej. 19:00)" style="max-width:180px">
              <input type="text" id="fiPlace" placeholder="Lugar (ej. Estadio)" style="flex:1">
            </div>
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="fiHomeName" placeholder="Nombre finalista local (opcional)" style="flex:1">
            <input type="text" id="fiAwayName" placeholder="Nombre finalista visita (opcional)" style="flex:1">
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
/* ===== ConfiguraciÃ³n ===== */
const STORAGE_KEY = 'torneo_futbol_grupos_ko_v1';
const $ = (s, r = document) => r.querySelector(s);

/* ===== Estado inicial ===== */
const state = {
  groups: {
    A: { teams: ['A1','A2','A3'], matches: [] },
    B: { teams: ['B1','B2','B3'], matches: [] },
    C: { teams: ['C1','C2','C3'], matches: [] },
    D: { teams: ['D1','D2','D3'], matches: [] },
  },
  points: { win:3, draw:1, loss:0 }, // Sistema por defecto: 3-1-0
  knockout: {
    sf1:  { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
    sf2:  { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
    third: { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
    final:{ home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' }
  },
  tournamentName: '',
  theme: { color: '#0284c7', bg: '#f8fafc' }
};

/* ===== Helpers ===== */
function parseTeams(txt){ return String(txt||'').split('\n').map(s=>s.trim()).filter(Boolean); }
function roundRobin3(t){ if(t.length!==3) return []; const [a,b,c]=t; return [[a,b],[c,a],[b,c]]; }
function valInt(v){ if(v===''||v==null) return null; const n=parseInt(v,10); return Number.isFinite(n)&&n>=0?n:null; }
function computeTable(matches,teams){
  const t=Object.fromEntries(teams.map(x=>[x,{team:x,PJ:0,G:0,E:0,P:0,GF:0,GC:0,DG:0,Pts:0}])), cfg=state.points;
  for(const m of matches){ if(m.gh==null||m.ga==null) continue; const H=t[m.home],A=t[m.away]; if(!H||!A) continue;
    H.PJ++;A.PJ++;H.GF+=m.gh;H.GC+=m.ga;A.GF+=m.ga;A.GC+=m.gh;
    if(m.gh>m.ga){H.G++;A.P++;H.Pts+=cfg.win;A.Pts+=cfg.loss;}
    else if(m.gh<m.ga){A.G++;H.P++;A.Pts+=cfg.win;H.Pts+=cfg.loss;}
    else {H.E++;A.E++;H.Pts+=cfg.draw;A.Pts+=cfg.draw;}
  }
  for(const x of teams){ t[x].DG=t[x].GF-t[x].GC; }
  return Object.values(t).sort((a,b)=> b.Pts-a.Pts || b.DG-a.DG || b.GF-a.GF || a.team.localeCompare(b.team));
}

/* ===== Render ===== */
function render(){
  const root=$('#groupsRoot'); root.innerHTML='';
  const colors={A:'groupA',B:'groupB',C:'groupC',D:'groupD'};
  for(const g of ['A','B','C','D']){
    const box=document.createElement('div'); box.className=`groupBox ${colors[g]}`;
    const G=state.groups[g]; box.innerHTML=`<h3 style="margin:0 0 6px">Grupo ${g}</h3>`;
    if(G.teams.length!==3){ const warn=document.createElement('div'); warn.className='note'; warn.textContent='Agrega exactamente 3 equipos (uno por lÃ­nea).'; box.appendChild(warn); root.appendChild(box); continue; }
    // Partidos
    const wrap=document.createElement('div'); wrap.className='matches';
    G.matches.forEach(m=>{
      const row=document.createElement('div'); row.className='match';
      row.innerHTML=`
        <div class="team">${m.home}</div>
        <div class="team" style="justify-content:center">
          <input type="number" min="0" class="gh" value="${m.gh??''}" aria-label="Goles ${m.home}">
          <span class="dash">â€”</span>
          <input type="number" min="0" class="ga" value="${m.ga??''}" aria-label="Goles ${m.away}">
        </div>
        <div class="team" style="justify-content:flex-end">${m.away}</div>`;
      const info=document.createElement('div'); info.className='info';
      info.innerHTML=`<input type="text" class="hour" placeholder="Hora" value="${m.hour||''}">
                      <input type="text" class="place" placeholder="Lugar" value="${m.place||''}">`;
      const gh=row.querySelector('.gh'), ga=row.querySelector('.ga');
      const hour=info.querySelector('.hour'), place=info.querySelector('.place');
      const persist=()=>{ m.gh=valInt(gh.value); m.ga=valInt(ga.value); m.hour=hour.value.trim(); m.place=place.value.trim(); save(); render(); };
      gh.addEventListener('input',persist); ga.addEventListener('input',persist);
      hour.addEventListener('change',persist); place.addEventListener('change',persist);
      wrap.appendChild(row); wrap.appendChild(info);
    });
    box.appendChild(wrap);
    // Tabla
    const rows=computeTable(G.matches,G.teams);
    const table=document.createElement('div');
    table.innerHTML=`
      <div style="overflow:auto">
        <table>
          <thead><tr>
            <th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>E</th><th>P</th>
            <th>GF</th><th>GC</th><th>DG</th><th>Pts</th>
          </tr></thead>
          <tbody>
            ${rows.map((r,i)=>`
              <tr class="${i===0?'first':''}">
                <td class="pos">${i+1}</td>
                <td>${r.team}</td>
                <td>${r.PJ}</td>
                <td>${r.G}</td>
                <td>${r.E}</td>
                <td>${r.P}</td>
                <td>${r.GF}</td>
                <td>${r.GC}</td>
                <td>${r.DG}</td>
                <td class="pts">${r.Pts}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;
    box.appendChild(table); root.appendChild(box);
  }
  updateKnockoutSeeds();
}

/* ===== Tema (preview inmediato) ===== */
function applyPreviewTheme(){
  document.body.style.background = state.theme?.bg || '#f8fafc';
  const color = state.theme?.color || '#0284c7';
  document.documentElement.style.setProperty('--accent', color);
}

/* ===== Generate / Winners / KO ===== */
function generate(){
  state.groups.A.teams=parseTeams($('#ga').value);
  state.groups.B.teams=parseTeams($('#gb').value);
  state.groups.C.teams=parseTeams($('#gc').value);
  state.groups.D.teams=parseTeams($('#gd').value);
  for(const g of ['A','B','C','D']){
    const T=state.groups[g].teams;
    state.groups[g].matches=roundRobin3(T).map(p=>({home:p[0],away:p[1],gh:null,ga:null,hour:'',place:''}));
  }
  state.tournamentName=$('#tournamentName').value.trim();
  
  // Actualizar sistema de puntos segÃºn selecciÃ³n
  const pointsSystem = $('#pointsSystem').value;
  if(pointsSystem === '3-1-0') {
    state.points = { win:3, draw:1, loss:0 };
  } else {
    state.points = { win:2, draw:1, loss:0 };
  }
  
  save(); render();
}
function groupWinner(gkey){ const G=state.groups[gkey]; if(G.teams.length!==3) return ''; const rows=computeTable(G.matches,G.teams); return rows[0]?.team||''; }
function updateKnockoutSeeds(){
  const A1=groupWinner('A')||'A1', B1=groupWinner('B')||'B1', C1=groupWinner('C')||'C1', D1=groupWinner('D')||'D1';
  
  // Semifinales
  const sf1Home=state.knockout.sf1.home || A1;
  const sf1Away=state.knockout.sf1.away || D1;
  const sf2Home=state.knockout.sf2.home || B1;
  const sf2Away=state.knockout.sf2.away || C1;
  
  $('#sf1h').textContent=sf1Home; $('#sf1a').textContent=sf1Away;
  $('#sf2h').textContent=sf2Home; $('#sf2a').textContent=sf2Away;
  
  const sf1w=$('#sf1w'); 
  sf1w.innerHTML=`<option value="">â€” Ganador â€”</option><option value="${sf1Home}">${sf1Home}</option><option value="${sf1Away}">${sf1Away}</option>`; 
  if(state.knockout.sf1.winner) sf1w.value=state.knockout.sf1.winner;
  
  const sf2w=$('#sf2w'); 
  sf2w.innerHTML=`<option value="">â€” Ganador â€”</option><option value="${sf2Home}">${sf2Home}</option><option value="${sf2Away}">${sf2Away}</option>`; 
  if(state.knockout.sf2.winner) sf2w.value=state.knockout.sf2.winner;
  
  // Tercer lugar (perdedores de semifinales)
  const thirdHome = state.knockout.third.home || (state.knockout.sf1.winner === sf1Home ? sf1Away : sf1Home) || 'Perdedor SF1';
  const thirdAway = state.knockout.third.away || (state.knockout.sf2.winner === sf2Home ? sf2Away : sf2Home) || 'Perdedor SF2';
  
  $('#thirdh').textContent=thirdHome; $('#thirda').textContent=thirdAway;
  
  const thirdw=$('#thirdw'); 
  thirdw.innerHTML=`<option value="">â€” Tercer Lugar â€”</option><option value="${thirdHome}">${thirdHome}</option><option value="${thirdAway}">${thirdAway}</option>`; 
  if(state.knockout.third.winner) thirdw.value=state.knockout.third.winner;
  
  // Final
  const w1=state.knockout.sf1.winner || 'Ganador SF1';
  const w2=state.knockout.sf2.winner || 'Ganador SF2';
  const fiHome=state.knockout.final.home || w1;
  const fiAway=state.knockout.final.away || w2;
  
  $('#fih').textContent=fiHome; $('#fia').textContent=fiAway;
  
  const fiw=$('#fiw'); 
  fiw.innerHTML=`<option value="">â€” CampeÃ³n â€”</option>${fiHome!=='Ganador SF1'?`<option value="${fiHome}">${fiHome}</option>`:''}${fiAway!=='Ganador SF2'?`<option value="${fiAway}">${fiAway}</option>`:''}`; 
  if(state.knockout.final.winner) fiw.value=state.knockout.final.winner;

  // Restaurar marcadores
  $('#sf1gh').value=state.knockout.sf1.gh??''; $('#sf1ga').value=state.knockout.sf1.ga??'';
  $('#sf2gh').value=state.knockout.sf2.gh??''; $('#sf2ga').value=state.knockout.sf2.ga??'';
  $('#thirdgh').value=state.knockout.third.gh??''; $('#thirdga').value=state.knockout.third.ga??'';
  $('#figh').value=state.knockout.final.gh??''; $('#figa').value=state.knockout.final.ga??'';

  // Rellenar inputs override
  $('#sf1HomeName').value = state.knockout.sf1.home || '';
  $('#sf1AwayName').value = state.knockout.sf1.away || '';
  $('#sf2HomeName').value = state.knockout.sf2.home || '';
  $('#sf2AwayName').value = state.knockout.sf2.away || '';
  $('#thirdHomeName').value = state.knockout.third.home || '';
  $('#thirdAwayName').value = state.knockout.third.away || '';
  $('#fiHomeName').value  = state.knockout.final.home || '';
  $('#fiAwayName').value  = state.knockout.final.away || '';
}

/* ===== Persistencia ===== */
function getDeporteFromPath() {
  const path = window.location.pathname;
  // Extraer el deporte de la URL: /torneos/futbol/administrador.html -> "futbol"
  const match = path.match(/\/([^\/]+)\/administrador/);
  return match ? match[1] : 'futbol';
}

function getRamaFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('rama') || 'varonil';
}

function save(){ 
  try{ 
    const deporte = getDeporteFromPath();
    const rama = getRamaFromURL();
    const storageKey = `TORNEO_${deporte.toUpperCase()}_${rama.toUpperCase()}_DATA`;
    localStorage.setItem(storageKey, JSON.stringify(state)); 
  }catch{} 
}

function load(){
  try{
    const deporte = getDeporteFromPath();
    const rama = getRamaFromURL();
    const storageKey = `TORNEO_${deporte.toUpperCase()}_${rama.toUpperCase()}_DATA`;
    
    const s = JSON.parse(localStorage.getItem(storageKey) || 'null'); 
    if(!s) {
      console.log(`No hay datos guardados para ${deporte} - ${rama}`);
      return false;
    }
    
    Object.assign(state, s);
    $('#ga').value = state.groups.A.teams.join('\n');
    $('#gb').value = state.groups.B.teams.join('\n');
    $('#gc').value = state.groups.C.teams.join('\n');
    $('#gd').value = state.groups.D.teams.join('\n');
    
    if(state.tournamentName) $('#tournamentName').value = state.tournamentName;
    
    // Configurar sistema de puntos
    if(state.points.win === 3) {
      $('#pointsSystem').value = '3-1-0';
    } else {
      $('#pointsSystem').value = '2-1-0';
    }
    
    // Tema -> inputs + preview
    if(state.theme){ 
      $('#themeColor').value = state.theme.color || '#0284c7';
      $('#themeBg').value = state.theme.bg || '#f8fafc';
      applyPreviewTheme();
    }
    
    console.log(`âœ… Cargado: ${deporte} - ${rama}`);
    return true;
  } catch(e) { 
    console.error('Error loading:', e);
    return false; 
  }
}

/* ===== Exportar/Importar/Publish ===== */
function slug(s){ 
  return String(s).toLowerCase()
    .normalize('NFD')
    .replace(/\p{Diacritic}/gu,'')
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/^-+|-+$/g,'');
}

function ts(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`; }
function downloadFile(name, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/json'})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
function stamp(snapshot){
  const now=new Date(); snapshot.updatedAt=now.toISOString();
  try{ snapshot.updatedAtLocal=new Intl.DateTimeFormat(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(now); }
  catch{ snapshot.updatedAtLocal=now.toLocaleString(); }
  return snapshot;
}

function saveCopy(){ 
  const deporte = getDeporteFromPath();
  const rama = getRamaFromURL();
  const base = $('#tournamentName')?.value?.trim() || `torneo-${deporte}-${rama}`;
  const file = `${slug(base)}_backup_${ts()}.json`; 
  const snap = JSON.parse(JSON.stringify(state)); 
  if (state.theme) snap.theme = state.theme;
  
  // Incluir metadatos en el backup tambiÃ©n
  snap.metadata = {
    deporte: deporte,
    rama: rama,
    slug: slug(`${deporte}-${base}`),
    timestamp: new Date().toISOString(),
    backup: true
  };
  
  stamp(snap);
  downloadFile(file, JSON.stringify(snap, null, 2)); 
}

function clearAll(){ if(!confirm('Â¿Borrar datos locales?')) return; try{ localStorage.removeItem(STORAGE_KEY);}catch{} location.reload(); }

function importData(){
  const inp=$('#importFile'); const f=inp.files?.[0]; if(!f){ alert('Selecciona un archivo JSON'); return; }
  const rd=new FileReader();
  rd.onload=()=>{ try{
      const obj=JSON.parse(rd.result);
      if(!obj.groups||!obj.knockout) throw new Error('Estructura invÃ¡lida');
      if(confirm('Esto reemplazarÃ¡ los datos actuales. Â¿Continuar?')){
        Object.assign(state,obj);
        $('#ga').value=state.groups.A.teams.join('\n');
        $('#gb').value=state.groups.B.teams.join('\n');
        $('#gc').value=state.groups.C.teams.join('\n');
        $('#gd').value=state.groups.D.teams.join('\n');
        $('#tournamentName').value=state.tournamentName||'';
        
        // Configurar sistema de puntos
        if(state.points.win === 3) {
          $('#pointsSystem').value = '3-1-0';
        } else {
          $('#pointsSystem').value = '2-1-0';
        }
        
        // Cargar tema desde import
        $('#themeColor').value = state.theme?.color || '#0284c7';
        $('#themeBg').value    = state.theme?.bg || '#f8fafc';
        applyPreviewTheme();
        save(); render(); updateKnockoutSeeds();
        alert('âœ… Datos importados'); inp.value='';
      }
    }catch(e){ alert('âŒ Error al importar: '+e.message); } };
  rd.onerror=()=>alert('âŒ Error al leer el archivo');
  rd.readAsText(f);
}

function exportData(){ 
  const snap=JSON.parse(JSON.stringify(state)); 
  if (state.theme) snap.theme = state.theme;
  stamp(snap); 
  const base=$('#tournamentName')?.value?.trim()||'torneo_futbol'; 
  const fn=`${slug(base)}_export_${ts()}.json`; 
  downloadFile(fn, JSON.stringify(snap,null,2)); 
  alert('ðŸ“¤ Exportado: '+fn); 
}

function setPublishStatus(t,cls=''){ const el=$('#publishStatus'); el.textContent=t; el.className=`status ${cls}`; }

async function publishNow(){
  const snap = JSON.parse(JSON.stringify(state)); 
  if (state.theme) snap.theme = state.theme;
  stamp(snap);
  
  // AGREGAR METADATOS
  const deporte = getDeporteFromPath();
  const rama = getRamaFromURL();
  const nombreTorneo = $('#tournamentName')?.value?.trim() || 'torneo';
  const slugFinal = slug(`${deporte}-${nombreTorneo}-${rama}`);
  
  snap.metadata = {
    deporte: deporte,
    slug: slugFinal,
    rama: rama,
    timestamp: new Date().toISOString(),
    version: '1.0'
  };
  
  const btn = $('#btnPublish'); 
  btn.disabled = true; 
  setPublishStatus('â³','loading');
  
  try {
    // Guardar en localStorage con clave Ãºnica
    const storageKey = `TORNEO_${deporte.toUpperCase()}_${rama.toUpperCase()}_DATA`;
    localStorage.setItem(storageKey, JSON.stringify(snap));
    
    const dataStr = JSON.stringify(snap, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    
    // NOMBRE CON SLUG
    const filename = `${slugFinal}.json`;
    const url = URL.createObjectURL(blob); 
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = filename;
    document.body.appendChild(a); 
    a.click(); 
    document.body.removeChild(a); 
    URL.revokeObjectURL(url);
    
    setPublishStatus('âœ…','success'); 
    setTimeout(() => setPublishStatus(''), 3000);
    
    alert(`âœ… Datos publicados exitosamente!\n\n` +
          `Archivo: ${filename}\n` +
          `Deporte: ${deporte}\n` +
          `Rama: ${rama}\n` +
          `Slug: ${slugFinal}\n\n` +
          `ðŸ“ Sube este archivo a la carpeta: /torneos/data/\n` +
          `ðŸŒ La vista pÃºblica estarÃ¡ en: /torneos/${deporte}/?slug=${slugFinal}`);
    
  } catch(e) { 
    console.error(e); 
    setPublishStatus('âŒ','error'); 
    alert('Error: '+e.message); 
  } finally { 
    btn.disabled = false; 
  }
}

/* ===== InicializaciÃ³n ===== */
function populateKOInputsFromState(){
  const k=state.knockout||{}, s1=k.sf1||{}, s2=k.sf2||{}, third=k.third||{}, fi=k.final||{};
  // Horas/Lugares
  $('#sf1Hour').value=s1.hour||''; $('#sf1Place').value=s1.place||'';
  $('#sf2Hour').value=s2.hour||''; $('#sf2Place').value=s2.place||'';
  $('#thirdHour').value=third.hour||''; $('#thirdPlace').value=third.place||'';
  $('#fiHour').value =fi.hour ||''; $('#fiPlace').value =fi.place ||'';
  // Nombres manuales
  $('#sf1HomeName').value = s1.home || '';
  $('#sf1AwayName').value = s1.away || '';
  $('#sf2HomeName').value = s2.home || '';
  $('#sf2AwayName').value = s2.away || '';
  $('#thirdHomeName').value = third.home || '';
  $('#thirdAwayName').value = third.away || '';
  $('#fiHomeName').value  = fi.home || '';
  $('#fiAwayName').value  = fi.away || '';
}

// FunciÃ³n para mostrar informaciÃ³n actual en la UI
function updateUIInfo() {
  const deporte = getDeporteFromPath();
  const rama = getRamaFromURL();
  const nombreTorneo = $('#tournamentName')?.value?.trim() || 'torneo';
  const slugFinal = slug(`${deporte}-${nombreTorneo}-${rama}`);
  
  // Actualizar el header
  const infoElement = document.getElementById('currentTournamentInfo') || (() => {
    const el = document.createElement('div');
    el.id = 'currentTournamentInfo';
    el.style.cssText = 'font-size:12px; color:var(--muted); margin-top:8px; padding:8px; background:var(--panel); border-radius:8px;';
    $('header .container').appendChild(el);
    return el;
  })();
  
  infoElement.innerHTML = `
    <strong>Deporte:</strong> ${deporte} | 
    <strong>Rama:</strong> ${rama} | 
    <strong>Slug:</strong> ${slugFinal}
    ${nombreTorneo ? `| <strong>Torneo:</strong> ${nombreTorneo}` : ''}
  `;
}

function init(){
  load(); 
  render(); 
  updateKnockoutSeeds(); 
  populateKOInputsFromState();
  updateUIInfo(); // â† Nueva funciÃ³n
  
  // Botones
  $('#btnGenerate').addEventListener('click',generate);
  $('#btnSaveCopy').addEventListener('click',saveCopy);
  $('#btnClearAll').addEventListener('click',clearAll);
  $('#btnImport').addEventListener('click',importData);
  $('#btnExport').addEventListener('click',exportData);
  $('#btnPublish').addEventListener('click',publishNow);
  
  // Actualizar info cuando cambie el nombre
  $('#tournamentName').addEventListener('input', updateUIInfo);
  
  // ConfiguraciÃ³n de puntos
  $('#pointsSystem').addEventListener('change', (e) => {
    if(e.target.value === '3-1-0') {
      state.points = { win:3, draw:1, loss:0 };
    } else {
      state.points = { win:2, draw:1, loss:0 };
    }
    save(); render();
  });

  // Knockout: inputs de marcadores
  const k=state.knockout;
  $('#sf1gh').addEventListener('input',()=>{ k.sf1.gh=valInt($('#sf1gh').value); save(); updateKnockoutSeeds(); });
  $('#sf1ga').addEventListener('input',()=>{ k.sf1.ga=valInt($('#sf1ga').value); save(); updateKnockoutSeeds(); });
  $('#sf2gh').addEventListener('input',()=>{ k.sf2.gh=valInt($('#sf2gh').value); save(); updateKnockoutSeeds(); });
  $('#sf2ga').addEventListener('input',()=>{ k.sf2.ga=valInt($('#sf2ga').value); save(); updateKnockoutSeeds(); });
  $('#thirdgh').addEventListener('input',()=>{ k.third.gh=valInt($('#thirdgh').value); save(); updateKnockoutSeeds(); });
  $('#thirdga').addEventListener('input',()=>{ k.third.ga=valInt($('#thirdga').value); save(); updateKnockoutSeeds(); });
  $('#figh').addEventListener('input',()=>{ k.final.gh=valInt($('#figh').value); save(); updateKnockoutSeeds(); });
  $('#figa').addEventListener('input',()=>{ k.final.ga=valInt($('#figa').value); save(); updateKnockoutSeeds(); });

  // Knockout: selects de ganador
  $('#sf1w').addEventListener('change',()=>{ k.sf1.winner=$('#sf1w').value; save(); updateKnockoutSeeds(); });
  $('#sf2w').addEventListener('change',()=>{ k.sf2.winner=$('#sf2w').value; save(); updateKnockoutSeeds(); });
  $('#thirdw').addEventListener('change',()=>{ k.third.winner=$('#thirdw').value; save(); updateKnockoutSeeds(); });
  $('#fiw').addEventListener('change',()=>{ k.final.winner=$('#fiw').value; save(); updateKnockoutSeeds(); });

  // Knockout: horas/lugares
  $('#sf1Hour').addEventListener('change',()=>{ k.sf1.hour=$('#sf1Hour').value.trim(); save(); });
  $('#sf1Place').addEventListener('change',()=>{ k.sf1.place=$('#sf1Place').value.trim(); save(); });
  $('#sf2Hour').addEventListener('change',()=>{ k.sf2.hour=$('#sf2Hour').value.trim(); save(); });
  $('#sf2Place').addEventListener('change',()=>{ k.sf2.place=$('#sf2Place').value.trim(); save(); });
  $('#thirdHour').addEventListener('change',()=>{ k.third.hour=$('#thirdHour').value.trim(); save(); });
  $('#thirdPlace').addEventListener('change',()=>{ k.third.place=$('#thirdPlace').value.trim(); save(); });
  $('#fiHour').addEventListener('change',()=>{ k.final.hour=$('#fiHour').value.trim(); save(); });
  $('#fiPlace').addEventListener('change',()=>{ k.final.place=$('#fiPlace').value.trim(); save(); });

  // Knockout: nombres manuales
  $('#sf1HomeName').addEventListener('change',()=>{ k.sf1.home=$('#sf1HomeName').value.trim(); save(); updateKnockoutSeeds(); });
  $('#sf1AwayName').addEventListener('change',()=>{ k.sf1.away=$('#sf1AwayName').value.trim(); save(); updateKnockoutSeeds(); });
  $('#sf2HomeName').addEventListener('change',()=>{ k.sf2.home=$('#sf2HomeName').value.trim(); save(); updateKnockoutSeeds(); });
  $('#sf2AwayName').addEventListener('change',()=>{ k.sf2.away=$('#sf2AwayName').value.trim(); save(); updateKnockoutSeeds(); });
  $('#thirdHomeName').addEventListener('change',()=>{ k.third.home=$('#thirdHomeName').value.trim(); save(); updateKnockoutSeeds(); });
  $('#thirdAwayName').addEventListener('change',()=>{ k.third.away=$('#thirdAwayName').value.trim(); save(); updateKnockoutSeeds(); });
  $('#fiHomeName').addEventListener('change',()=>{ k.final.home=$('#fiHomeName').value.trim(); save(); updateKnockoutSeeds(); });
  $('#fiAwayName').addEventListener('change',()=>{ k.final.away=$('#fiAwayName').value.trim(); save(); updateKnockoutSeeds(); });

  // Tema: cambios en tiempo real
  $('#themeColor').addEventListener('input',()=>{ 
    state.theme = state.theme || {};
    state.theme.color = $('#themeColor').value;
    applyPreviewTheme(); 
    save(); 
  });
  $('#themeBg').addEventListener('input',()=>{ 
    state.theme = state.theme || {};
    state.theme.bg = $('#themeBg').value;
    applyPreviewTheme(); 
    save(); 
  });
}

document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>