<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carátula — Cargar Torneo</title>
  <style>
    :root{ --bg:#f8fafc; --panel:#e2e8f0; --card:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#0284c7; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:24px 16px;border-bottom:2px solid #cbd5e1;background:linear-gradient(90deg,#e2e8f0,#f1f5f9)}
    h1{margin:0;font-size:22px}
    main{max-width:900px;margin:18px auto;padding:16px}
    .card{background:var(--card);border:1px solid #cbd5e1;border-radius:14px;box-shadow:0 2px 8px rgba(15,23,42,.06);padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input[type="text"]{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px}
    input[type="color"]{width:54px;height:36px;padding:0;border:1px solid #cbd5e1;border-radius:8px;background:#fff}
    button{padding:10px 14px;border:1px solid #0ea5e9;background:#0ea5e9;color:#fff;border-radius:10px;font-weight:600;cursor:pointer}
    button.secondary{background:#fff;color:#0ea5e9}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    .preview{padding:14px;border-radius:12px;border:2px dashed var(--accent);background:#ffffff}
    .meta{font-size:13px;color:#334155}
    .badge{display:inline-block;background:var(--accent);color:#fff;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700}
    .hint{font-size:12px;color:#475569}
  </style>
</head>
<body>
  <header>
    <h1>Carátula — Cargar datos del torneo</h1>
  </header>

  <main class="grid">
    <section class="card">
      <div class="row">
        <div style="flex:2">
          <label for="slug">Archivo JSON (slug / nombre)</label>
          <input type="text" id="slug" placeholder="ej. data-futbolv.json" />
          <div class="hint">Coloca el nombre del archivo JSON a cargar (debe estar en la misma carpeta que esta carátula).</div>
        </div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <button id="btnLoad">Cargar JSON</button>
          <button id="btnOpen" class="secondary" title="Abrir administrador" disabled>Abrir administrador</button>
        </div>
      </div>

      <hr style="margin:16px 0;border:none;border-top:1px solid #e2e8f0">

      <div class="row">
        <input type="text" id="tournamentName" placeholder="Nombre del torneo" style="flex:2" />
        <div style="display:flex;gap:8px;align-items:center">
          <label for="themeColor" style="margin:0">Acento</label>
          <input type="color" id="themeColor" value="#0284c7">
          <label for="themeBg" style="margin:0">Fondo</label>
          <input type="color" id="themeBg" value="#f8fafc">
        </div>
      </div>

      <div class="preview" style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <div class="meta"><strong id="previewName">Sin nombre</strong></div>
          <div class="badge">Vista previa</div>
        </div>
        <div class="meta" style="margin-top:4px">Colores activos — Acento: <span id="prevAccent">#0284c7</span> · Fondo: <span id="prevBg">#f8fafc</span></div>
      </div>

      <div class="hint" style="margin-top:10px">Al cargar un JSON válido, se guardará en el navegador y podrás abrir el administrador.</div>
    </section>

    <aside class="card">
      <h3 style="margin-top:0">Estado</h3>
      <div id="status" class="meta">Esperando carga…</div>
      <div id="details" class="hint" style="margin-top:8px"></div>
    </aside>
  </main>

  <script>
    const STORAGE_KEY = 'torneo_grupos_ko_v2';

    // Normalización compatible con administrador
    function normalizeImported(data) {
      const KO_DEF = {
        sf1:  { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
        sf2:  { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
        final:{ home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
        third:{ home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' }
      };

      const safe = {
        tournamentName: data.tournamentName || '',
        theme: Object.assign({ color:'#0284c7', bg:'#f8fafc' }, data.theme || {}),
        points: Object.assign({ win:3, draw:1, loss:0 }, data.points || {}),
        groups: { A:{teams:[],matches:[]}, B:{teams:[],matches:[]}, C:{teams:[],matches:[]}, D:{teams:[],matches:[]} },
        knockout: {
          sf1:  Object.assign({}, KO_DEF.sf1,  data.knockout?.sf1  || {}),
          sf2:  Object.assign({}, KO_DEF.sf2,  data.knockout?.sf2  || {}),
          final:Object.assign({}, KO_DEF.final,data.knockout?.final|| {}),
          third:Object.assign({}, KO_DEF.third,data.knockout?.third|| {})
        }
      };

      ['A','B','C','D'].forEach(k => {
        const g = (data.groups && data.groups[k]) ? data.groups[k] : {};
        const t = Array.isArray(g.teams) ? g.teams.filter(Boolean) : [];
        const m = Array.isArray(g.matches) ? g.matches.map(mm => Object.assign(
          { home:'', away:'', gh:null, ga:null, hour:'', place:'' }, mm
        )) : [];
        safe.groups[k] = { teams: t, matches: m };
      });

      return safe;
    }

    function applyTheme(theme){
      const color = theme?.color || '#0284c7';
      const bg = theme?.bg || '#f8fafc';
      document.documentElement.style.setProperty('--accent', color);
      document.documentElement.style.setProperty('--bg', bg);
      document.body.style.background = bg;
      document.getElementById('prevAccent').textContent = color;
      document.getElementById('prevBg').textContent = bg;
    }

    function saveToStorage(state){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        return true;
      }catch(e){
        console.error(e);
        return false;
      }
    }

    function setStatus(msg, details=''){
      document.getElementById('status').textContent = msg;
      document.getElementById('details').textContent = details;
    }

    async function loadSlug(slug){
      if(!slug){ setStatus('❌ Debes indicar un archivo JSON'); return; }
      setStatus('Cargando…', slug);
      try{
        const res = await fetch(slug, { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const raw = await res.json();
        const safe = normalizeImported(raw);

        // Aplicar sobre-escrituras desde la carátula antes de guardar
        const nameInput = document.getElementById('tournamentName').value.trim();
        if (nameInput) safe.tournamentName = nameInput;
        safe.theme = {
          color: document.getElementById('themeColor').value || safe.theme.color,
          bg: document.getElementById('themeBg').value || safe.theme.bg
        };

        // Guardar
        if (saveToStorage(safe)){
          document.getElementById('previewName').textContent = safe.tournamentName || 'Sin nombre';
          applyTheme(safe.theme);
          document.getElementById('btnOpen').disabled = false;
          setStatus('✅ Datos cargados y guardados', 'Ahora puedes abrir el administrador.');
        } else {
          setStatus('❌ No se pudieron guardar los datos');
        }
      }catch(err){
        console.error(err);
        setStatus('❌ Error al cargar el JSON', String(err));
      }
    }

    // Eventos UI
    document.getElementById('btnLoad').addEventListener('click', () => {
      const slug = document.getElementById('slug').value.trim();
      loadSlug(slug);
    });

    document.getElementById('btnOpen').addEventListener('click', () => {
      // Abre el administrador (ajusta el nombre del archivo si es distinto)
      window.location.href = 'administrador_final_banda.html';
    });

    // Inputs con live preview
    document.getElementById('tournamentName').addEventListener('input', (e) => {
      document.getElementById('previewName').textContent = e.target.value || 'Sin nombre';
      // No guardamos todavía: se guarda hasta cargar JSON
    });

    document.getElementById('themeColor').addEventListener('input', (e) => {
      applyTheme({ color: e.target.value, bg: document.getElementById('themeBg').value });
    });
    document.getElementById('themeBg').addEventListener('input', (e) => {
      applyTheme({ color: document.getElementById('themeColor').value, bg: e.target.value });
    });

    // Cargar desde query param ?data=archivo.json
    (function boot(){
      const params = new URLSearchParams(window.location.search);
      const qp = params.get('data');
      if (qp){
        document.getElementById('slug').value = qp;
        loadSlug(qp);
      }
      // Inicializar preview con valores por defecto
      applyTheme({ color: document.getElementById('themeColor').value, bg: document.getElementById('themeBg').value });
    })();
  </script>
</body>
</html>
