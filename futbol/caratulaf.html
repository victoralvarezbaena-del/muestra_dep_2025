<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Torneo Fútbol — 4 Grupos + Semifinales</title>
  <style>
    :root{ --bg:#f8fafc; --panel:#e2e8f0; --card:#ffffff; --muted:#475569; --text:#0f172a; --accent:#0284c7; --ok:#16a34a; --bad:#dc2626; --ring:0 0 0 2px var(--accent) inset; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:20px 16px;border-bottom:2px solid #cbd5e1;background:linear-gradient(90deg,#e2e8f0,#f1f5f9);position:sticky;top:0;z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:clamp(22px,3.2vw,34px)}
    .subtitle{color:var(--muted)}

    .grid{display:grid;gap:16px}
    @media(min-width:1100px){.grid{grid-template-columns:1fr 420px}}

    .card{background:var(--card);border:1px solid #cbd5e1;border-radius:18px;padding:16px;box-shadow:0 3px 10px rgba(0,0,0,.1)}
    .card h2{margin:0 0 12px;font-size:18px}

    .groups{display:grid;gap:12px}
    @media(min-width:700px){.groups{grid-template-columns:1fr 1fr}}

    /* Colores por grupo */
    .groupA{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.45)}
    .groupB{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.45)}
    .groupC{background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.45)}
    .groupD{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.45)}

    .groupBox{padding:12px;border-radius:12px;margin-bottom:12px}

    .matches{display:grid;gap:10px;margin-top:10px}
    .match{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;background:#f8fafc;border:1px solid #cbd5e1;border-radius:12px;padding:10px}
    .team{display:flex;align-items:center;gap:10px}
    .dash{opacity:.6}
    .info{display:flex;gap:8px;margin-top:6px}
    .info input{background:#f8fafc;border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #cbd5e1;text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{font-size:12px;color:var(--muted);font-weight:600}
    tbody tr:hover{background:#e2e8f0}
    .pos{font-variant-numeric:tabular-nums;color:var(--muted)}
    .pts{font-weight:800}
    .first{background:rgba(34,197,94,.15)}
    .note{font-size:12px;color:var(--muted)}

    /* Knockout */
    .bracket{display:grid;gap:12px;margin-top:16px}
    @media(min-width:900px){.bracket{grid-template-columns:1fr 1fr}}
    .semi,.final,.third-place{background:#ffffff;border:1px solid #cbd5e1;border-radius:12px;padding:12px}
    .semi h3,.final h3,.third-place h3{margin:0 0 8px;font-size:16px}

    /* Admin link */
    .admin-link{position:absolute;top:20px;right:16px;background:var(--accent);color:#fff;border:none;border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer;text-decoration:none;font-size:14px}
    .admin-link:hover{opacity:0.9}

    /* Info banner */
    .info-banner{font-size:12px; color:var(--muted); margin-top:8px; padding:8px; background:var(--panel); border-radius:8px;}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 id="tournamentTitle">Torneo Fútbol — 4 Grupos + Semifinales</h1>
      <div class="subtitle">Resultados en tiempo real</div>
      <div id="tournamentInfo" class="info-banner"></div>
      <a href="administrador.html" class="admin-link">⚙️ Administrar</a>
    </div>
  </header>

  <main class="container grid">
    <section>
      <div class="groups">
        <div class="card groupA">
          <h2>Grupo A</h2>
          <div id="groupA"></div>
        </div>
        <div class="card groupB">
          <h2>Grupo B</h2>
          <div id="groupB"></div>
        </div>
        <div class="card groupC">
          <h2>Grupo C</h2>
          <div id="groupC"></div>
        </div>
        <div class="card groupD">
          <h2>Grupo D</h2>
          <div id="groupD"></div>
        </div>
      </div>

      <div class="bracket">
        <div class="card semi">
          <h3>Semifinal 1 — A1 vs D1</h3>
          <div id="sf1"></div>
        </div>
        <div class="card semi">
          <h3>Semifinal 2 — B1 vs C1</h3>
          <div id="sf2"></div>
        </div>
        <div class="card third-place">
          <h3>Tercer Lugar — Perdedor SF1 vs Perdedor SF2</h3>
          <div id="third"></div>
        </div>
        <div class="card final" style="grid-column:1/-1">
          <h3>Final</h3>
          <div id="final"></div>
        </div>
      </div>
    </section>

    <section>
      <div class="card">
        <h2>Clasificación general</h2>
        <div id="standings"></div>
      </div>
    </section>
  </main>

<script>
/* ===== Configuración ===== */
const $ = (s, r = document) => r.querySelector(s);

/* ===== Estado inicial ===== */
const state = {
  groups: {
    A: { teams: ['A1','A2','A3'], matches: [] },
    B: { teams: ['B1','B2','B3'], matches: [] },
    C: { teams: ['C1','C2','C3'], matches: [] },
    D: { teams: ['D1','D2','D3'], matches: [] },
  },
  points: { win:3, draw:1, loss:0 },
  knockout: {
    sf1:  { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
    sf2:  { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
    third: { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
    final:{ home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' }
  },
  tournamentName: '',
  theme: { color: '#0284c7', bg: '#f8fafc' }
};

/* ===== Helpers ===== */
function computeTable(matches, teams){
  const t=Object.fromEntries(teams.map(x=>[x,{team:x,PJ:0,G:0,E:0,P:0,GF:0,GC:0,DG:0,Pts:0}])), cfg=state.points;
  for(const m of matches){ if(m.gh==null||m.ga==null) continue; const H=t[m.home],A=t[m.away]; if(!H||!A) continue;
    H.PJ++;A.PJ++;H.GF+=m.gh;H.GC+=m.ga;A.GF+=m.ga;A.GC+=m.gh;
    if(m.gh>m.ga){H.G++;A.P++;H.Pts+=cfg.win;A.Pts+=cfg.loss;}
    else if(m.gh<m.ga){A.G++;H.P++;A.Pts+=cfg.win;H.Pts+=cfg.loss;}
    else {H.E++;A.E++;H.Pts+=cfg.draw;A.Pts+=cfg.draw;}
  }
  for(const x of teams){ t[x].DG=t[x].GF-t[x].GC; }
  return Object.values(t).sort((a,b)=> b.Pts-a.Pts || b.DG-a.DG || b.GF-a.GF || a.team.localeCompare(b.team));
}

/* ===== Render ===== */
function render(){
  renderGroup('A'); renderGroup('B'); renderGroup('C'); renderGroup('D');
  renderKnockout(); renderStandings();
  applyTheme();
  updateTournamentInfo();
}

function renderGroup(g){
  const el=$(`#group${g}`); if(!el) return;
  const G=state.groups[g]; if(G.teams.length!==3){ el.innerHTML='<div class="note">Grupo incompleto</div>'; return; }
  
  let html='<div class="matches">';
  G.matches.forEach(m=>{
    const homeScore=m.gh!=null?m.gh:'?'; const awayScore=m.ga!=null?m.ga:'?';
    html+=`
      <div class="match">
        <div class="team">${m.home}</div>
        <div class="team" style="justify-content:center">
          <span>${homeScore}</span><span class="dash">—</span><span>${awayScore}</span>
        </div>
        <div class="team" style="justify-content:flex-end">${m.away}</div>
      </div>`;
    if(m.hour||m.place){ html+=`<div class="info"><input type="text" value="${m.hour||''}" readonly><input type="text" value="${m.place||''}" readonly></div>`; }
  });
  html+='</div>';
  
  const rows=computeTable(G.matches,G.teams);
  html+=`
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>E</th><th>P</th>
          <th>GF</th><th>GC</th><th>DG</th><th>Pts</th>
        </tr></thead>
        <tbody>
          ${rows.map((r,i)=>`
            <tr class="${i===0?'first':''}">
              <td class="pos">${i+1}</td>
              <td>${r.team}</td>
              <td>${r.PJ}</td>
              <td>${r.G}</td>
              <td>${r.E}</td>
              <td>${r.P}</td>
              <td>${r.GF}</td>
              <td>${r.GC}</td>
              <td>${r.DG}</td>
              <td class="pts">${r.Pts}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>`;
  el.innerHTML=html;
}

function renderKnockout(){
  const k=state.knockout;
  
  // Semifinal 1
  const sf1Home = k.sf1.home || 'A1';
  const sf1Away = k.sf1.away || 'D1';
  const sf1HomeScore = k.sf1.gh!=null?k.sf1.gh:'?';
  const sf1AwayScore = k.sf1.ga!=null?k.sf1.ga:'?';
  let sf1Winner = '';
  if(k.sf1.winner) sf1Winner = `<div style="margin-top:6px;font-weight:700;color:var(--ok)">Ganador: ${k.sf1.winner}</div>`;
  $('#sf1').innerHTML=`
    <div class="match">
      <div class="team">${sf1Home}</div>
      <div class="team" style="justify-content:center">
        <span>${sf1HomeScore}</span><span class="dash">—</span><span>${sf1AwayScore}</span>
      </div>
      <div class="team" style="justify-content:flex-end">${sf1Away}</div>
    </div>
    ${(k.sf1.hour||k.sf1.place)?`<div class="info"><input type="text" value="${k.sf1.hour||''}" readonly><input type="text" value="${k.sf1.place||''}" readonly></div>`:''}
    ${sf1Winner}`;

  // Semifinal 2
  const sf2Home = k.sf2.home || 'B1';
  const sf2Away = k.sf2.away || 'C1';
  const sf2HomeScore = k.sf2.gh!=null?k.sf2.gh:'?';
  const sf2AwayScore = k.sf2.ga!=null?k.sf2.ga:'?';
  let sf2Winner = '';
  if(k.sf2.winner) sf2Winner = `<div style="margin-top:6px;font-weight:700;color:var(--ok)">Ganador: ${k.sf2.winner}</div>`;
  $('#sf2').innerHTML=`
    <div class="match">
      <div class="team">${sf2Home}</div>
      <div class="team" style="justify-content:center">
        <span>${sf2HomeScore}</span><span class="dash">—</span><span>${sf2AwayScore}</span>
      </div>
      <div class="team" style="justify-content:flex-end">${sf2Away}</div>
    </div>
    ${(k.sf2.hour||k.sf2.place)?`<div class="info"><input type="text" value="${k.sf2.hour||''}" readonly><input type="text" value="${k.sf2.place||''}" readonly></div>`:''}
    ${sf2Winner}`;

  // Tercer Lugar
  const thirdHome = k.third.home || 'Perdedor SF1';
  const thirdAway = k.third.away || 'Perdedor SF2';
  const thirdHomeScore = k.third.gh!=null?k.third.gh:'?';
  const thirdAwayScore = k.third.ga!=null?k.third.ga:'?';
  let thirdWinner = '';
  if(k.third.winner) thirdWinner = `<div style="margin-top:6px;font-weight:700;color:var(--ok)">Tercer Lugar: ${k.third.winner}</div>`;
  $('#third').innerHTML=`
    <div class="match">
      <div class="team">${thirdHome}</div>
      <div class="team" style="justify-content:center">
        <span>${thirdHomeScore}</span><span class="dash">—</span><span>${thirdAwayScore}</span>
      </div>
      <div class="team" style="justify-content:flex-end">${thirdAway}</div>
    </div>
    ${(k.third.hour||k.third.place)?`<div class="info"><input type="text" value="${k.third.hour||''}" readonly><input type="text" value="${k.third.place||''}" readonly></div>`:''}
    ${thirdWinner}`;

  // Final
  const fiHome = k.final.home || (k.sf1.winner||'Ganador SF1');
  const fiAway = k.final.away || (k.sf2.winner||'Ganador SF2');
  const fiHomeScore = k.final.gh!=null?k.final.gh:'?';
  const fiAwayScore = k.final.ga!=null?k.final.ga:'?';
  let fiWinner = '';
  if(k.final.winner) fiWinner = `<div style="margin-top:6px;font-weight:700;color:var(--ok);font-size:18px">🏆 Campeón: ${k.final.winner}</div>`;
  $('#final').innerHTML=`
    <div class="match">
      <div class="team">${fiHome}</div>
      <div class="team" style="justify-content:center">
        <span>${fiHomeScore}</span><span class="dash">—</span><span>${fiAwayScore}</span>
      </div>
      <div class="team" style="justify-content:flex-end">${fiAway}</div>
    </div>
    ${(k.final.hour||k.final.place)?`<div class="info"><input type="text" value="${k.final.hour||''}" readonly><input type="text" value="${k.final.place||''}" readonly></div>`:''}
    ${fiWinner}`;
}

function renderStandings(){
  const el=$('#standings'); if(!el) return;
  const allTeams=[...state.groups.A.teams,...state.groups.B.teams,...state.groups.C.teams,...state.groups.D.teams];
  const allMatches=[...state.groups.A.matches,...state.groups.B.matches,...state.groups.C.matches,...state.groups.D.matches];
  const rows=computeTable(allMatches,allTeams);
  const html=`
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>E</th><th>P</th>
          <th>GF</th><th>GC</th><th>DG</th><th>Pts</th>
        </tr></thead>
        <tbody>
          ${rows.map((r,i)=>`
            <tr>
              <td class="pos">${i+1}</td>
              <td>${r.team}</td>
              <td>${r.PJ}</td>
              <td>${r.G}</td>
              <td>${r.E}</td>
              <td>${r.P}</td>
              <td>${r.GF}</td>
              <td>${r.GC}</td>
              <td>${r.DG}</td>
              <td class="pts">${r.Pts}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>`;
  el.innerHTML=html;
}

/* ===== Tema ===== */
function applyTheme(){
  document.body.style.background = state.theme?.bg || '#f8fafc';
  const color = state.theme?.color || '#0284c7';
  document.documentElement.style.setProperty('--accent', color);
}

/* ===== Información del torneo ===== */
function updateTournamentInfo() {
  const infoEl = $('#tournamentInfo');
  if (!infoEl) return;
  
  let infoHTML = '';
  
  if (state.metadata) {
    const meta = state.metadata;
    infoHTML = `<strong>Deporte:</strong> ${meta.deporte || 'Fútbol'} | <strong>Rama:</strong> ${meta.rama || 'Varonil'}`;
    
    if (meta.slug) {
      infoHTML += ` | <strong>Slug:</strong> ${meta.slug}`;
    }
    
    if (meta.timestamp) {
      const date = new Date(meta.timestamp);
      infoHTML += ` | <strong>Actualizado:</strong> ${date.toLocaleString()}`;
    }
  } else if (state.tournamentName) {
    infoHTML = `<strong>Torneo:</strong> ${state.tournamentName}`;
  }
  
  infoEl.innerHTML = infoHTML;
}

/* ===== Carga de datos ===== */
function getSlugFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('slug');
}

function getDeporteFromPath() {
  const path = window.location.pathname;
  const match = path.match(/\/([^\/]+)\//);
  return match ? match[1] : 'futbol';
}

function load(){
  try{
    const slug = getSlugFromURL();
    
    if (slug) {
      // Intentar cargar desde el slug específico
      fetch(`../data/${slug}.json`)
        .then(r => {
          if (!r.ok) throw new Error('No se encontró el torneo');
          return r.json();
        })
        .then(data => { 
          Object.assign(state, data); 
          render();
          if(state.tournamentName) $('#tournamentTitle').textContent = state.tournamentName;
          console.log(`✅ Cargado torneo: ${slug}`);
        })
        .catch(err => {
          console.log(`❌ No se pudo cargar ${slug}.json, intentando con datos locales...`);
          loadFromLocal();
        });
    } else {
      // Cargar desde localStorage o data.json por defecto
      loadFromLocal();
    }
    
    return true;
  }catch(e){ 
    console.error('Error loading data:',e); 
    return false; 
  }
}

function loadFromLocal() {
  try {
    const deporte = getDeporteFromPath();
    
    // Intentar cargar de localStorage primero
    const ramas = ['varonil', 'femenil'];
    let loaded = false;
    
    for (const rama of ramas) {
      const storageKey = `TORNEO_${deporte.toUpperCase()}_${rama.toUpperCase()}_DATA`;
      const local = JSON.parse(localStorage.getItem(storageKey) || 'null');
      if (local) {
        Object.assign(state, local);
        console.log(`✅ Cargado desde localStorage: ${deporte} - ${rama}`);
        loaded = true;
        break;
      }
    }
    
    if (!loaded) {
      // Intentar cargar data.json por defecto
      fetch('./data.json')
        .then(r => {
          if (r.ok) return r.json();
          throw new Error('No data.json found');
        })
        .then(data => { 
          Object.assign(state, data); 
          render();
        })
        .catch(err => {
          console.log('No se pudo cargar data.json, usando datos por defecto');
          render(); // Render con datos por defecto
        });
    } else {
      render(); // Render con datos de localStorage
    }
  } catch(e) {
    console.error('Error loading local data:', e);
    render(); // Render con datos por defecto
  }
}

/* ===== Inicialización ===== */
function init(){
  load(); 
  
  // Actualizar título si hay nombre de torneo
  if(state.tournamentName) {
    $('#tournamentTitle').textContent = state.tournamentName;
  }
  
  // Recargar datos cada 10 segundos
  setInterval(() => { 
    load(); 
  }, 10000);
}

document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>