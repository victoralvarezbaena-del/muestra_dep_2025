<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Car√°tula del Torneo</title>
<style>
:root{
  --accent:#0284c7;
  --bg:#f8fafc;
  --text:#0f172a;
  --muted:#475569;
  --card:#ffffff;
  --line:#e2e8f0;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
header{padding:22px 16px;color:#fff;background:linear-gradient(90deg,var(--accent),var(--accent))}
.container{max-width:1200px;margin:0 auto;padding:16px}
h1{margin:0;font-size:clamp(22px,3.2vw,34px)}
.subtitle{opacity:.9}

.section{background:var(--card);border:1px solid var(--line);border-radius:14px;margin:14px 0;overflow:hidden}
.section h2{margin:0;padding:10px 14px;background:var(--bg);border-bottom:1px solid var(--line);color:var(--text)}
.box{padding:12px}

.group{border:1px solid var(--line);border-radius:12px;background:var(--card);margin-bottom:16px;overflow:hidden}
.group h3{margin:0;padding:8px 12px;background:var(--accent);color:#fff;font-size:16px}
.group .inner{padding:10px}

.matches{display:grid;gap:8px;margin:8px 0}
.match{
  display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;
  background:#f8fafc;border:1px solid var(--line);border-radius:10px;padding:8px 10px
}
.score{min-width:70px;text-align:center;font-weight:800}
.meta{grid-column:1/-1;font-size:12px;color:var(--muted);display:flex;gap:12px;padding:2px 2px 0 2px}
.meta span{display:inline-flex;align-items:center;gap:6px}
.meta .icon{opacity:.75}

.table-wrap{overflow:auto;margin-top:8px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:right}
th:first-child,td:first-child{text-align:left}
thead th{background:#f1f5f9;color:var(--muted);font-weight:600}
tbody tr:first-child{background:rgba(34,197,94,.12)}
.pos{color:var(--muted);font-variant-numeric:tabular-nums}
.pts{font-weight:800}

.bracket{display:grid;gap:12px}
@media(min-width:900px){.bracket{grid-template-columns:1fr 1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
.card h3{margin:0 0 8px 0}
.hr{height:1px;background:var(--line);margin:8px 0}

footer{font-size:12px;color:var(--muted);text-align:center;margin:18px 0}
.badge{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="container">
    <h1 id="title">Torneo</h1>
    <div class="subtitle" id="subtitle"></div>
  </div>
</header>

<main class="container">

  <div class="section">
    <h2>Car√°tula</h2>
    <div class="box">
      <div class="row" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <input type="text" id="ctlName" placeholder="Nombre del torneo" style="flex:2;min-width:260px;padding:10px 12px;border:1px solid var(--line);border-radius:10px">
        <div style="display:flex;gap:8px;align-items:center">
          <label for="ctlAccent" style="font-size:12px;color:var(--muted)">Acento</label>
          <input type="color" id="ctlAccent" value="#0284c7" style="width:54px;height:36px;padding:0;border:1px solid var(--line);border-radius:8px;background:#fff">
          <label for="ctlBg" style="font-size:12px;color:var(--muted)">Fondo</label>
          <input type="color" id="ctlBg" value="#f8fafc" style="width:54px;height:36px;padding:0;border:1px solid var(--line);border-radius:8px;background:#fff">
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-left:auto">
          <button id="btnSave" style="padding:10px 14px;border:1px solid #0ea5e9;background:#0ea5e9;color:#fff;border-radius:10px;font-weight:600;cursor:pointer">Guardar en navegador</button>
          <button id="btnOpenAdmin" class="secondary" style="padding:10px 14px;border:1px solid var(--line);background:#fff;color:#0ea5e9;border-radius:10px;font-weight:600;cursor:pointer">Abrir administrador</button>
        </div>
      </div>
      <div class="hr" style="height:1px;background:var(--line);margin:12px 0"></div>
      <div class="hint" style="font-size:12px;color:var(--muted)">Esta car√°tula carga <code>?t=slug</code> ‚Üí <code>slug.json</code>, normaliza el contenido y lo guarda con la clave <code>torneo_grupos_ko_v2</code> para el administrador.</div>
    </div>
  </div>

  <div class="section">
    <h2>Grupos</h2>
    <div class="box" id="groupsRoot">Cargando‚Ä¶</div>
  </div>

  <div class="section">
    <h2>Semifinales y Final</h2>
    <div class="box" id="koRoot"></div>
  </div>
</main>

<footer id="footer"></footer>

<script>

const STORAGE_KEY = 'torneo_grupos_ko_v2';

function normalizeImported(data) {
  const KO_DEF = {
    sf1:  { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
    sf2:  { home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
    final:{ home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' },
    third:{ home:'', away:'', gh:null, ga:null, winner:'', hour:'', place:'' }
  };

  const safe = {
    tournamentName: data.tournamentName || '',
    theme: Object.assign({ color:'#0284c7', bg:'#f8fafc' }, data.theme || {}),
    points: Object.assign({ win:3, draw:1, loss:0 }, data.points || {}),
    groups: { A:{teams:[],matches:[]}, B:{teams:[],matches:[]}, C:{teams:[],matches:[]}, D:{teams:[],matches:[]} },
    knockout: {
      sf1:  Object.assign({}, KO_DEF.sf1,  data.knockout?.sf1  || {}),
      sf2:  Object.assign({}, KO_DEF.sf2,  data.knockout?.sf2  || {}),
      final:Object.assign({}, KO_DEF.final,data.knockout?.final|| {}),
      third:Object.assign({}, KO_DEF.third,data.knockout?.third|| {})
    },
    subtitle: data.subtitle || ''
  };

  ['A','B','C','D'].forEach(k => {
    const g = (data.groups && data.groups[k]) ? data.groups[k] : {};
    const t = Array.isArray(g.teams) ? g.teams.filter(Boolean) : [];
    const m = Array.isArray(g.matches) ? g.matches.map(mm => Object.assign(
      { home:'', away:'', gh:null, ga:null, hour:'', place:'' }, mm
    )) : [];
    safe.groups[k] = { teams: t, matches: m };
  });

  return safe;
}

function saveToStorage(state){
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    return true;
  } catch(err){
    console.error('No se pudo guardar en localStorage', err);
    return false;
  }
}

const $ = (s, r=document)=>r.querySelector(s);

/* ========= Utilidades ========= */
function pick(obj, paths, def=null){
  for(const p of paths){
    const parts = p.split('.');
    let v = obj;
    let ok = true;
    for(const k of parts){
      if(v && Object.prototype.hasOwnProperty.call(v, k)){ v = v[k]; }
      else { ok = false; break; }
    }
    if(ok && v!=null && v!=='') return v;
  }
  return def;
}

/* ========= Carga ========= */
async function loadData(){
  const q = new URLSearchParams(location.search);
  const slug = q.get('t') || 'data';  // ?t=data-mi-torneo -> data-mi-torneo.json
  const url  = `${slug}.json`;
  const res  = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('No se pudo cargar el JSON ('+res.status+')');
  const raw  = await res.json();
  const safe = normalizeImported(raw);

  // Prefill controls
  $('#ctlName').value = safe.tournamentName || '';
  $('#ctlAccent').value = safe.theme?.color || '#0284c7';
  $('#ctlBg').value = safe.theme?.bg || '#f8fafc';

  // Render y tema
  renderAll(safe);

  // Guardar por defecto para que el admin ya pueda abrirse
  saveToStorage(safe);
}.json`;
  const res  = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('No se pudo cargar el JSON ('+res.status+')');
  const data = await res.json();
  renderAll(data);
}

/* ========= Tema (robusto) ========= */
function applyTheme(data){
  // Soporta varias variantes en el JSON
  const accent = pick(data, ['theme.color','theme.accent','colors.accent'], null);
  const bg     = pick(data, ['theme.bg','theme.background','colors.bg','colors.background'], null);

  if(accent){
    document.documentElement.style.setProperty('--accent', accent);
    // Asegurar el header (si alguien dej√≥ el gradiente fijo)
    const header = document.querySelector('header');
    if(header) header.style.background = `linear-gradient(90deg, ${accent}, ${accent})`;
  }
  if(bg){
    document.documentElement.style.setProperty('--bg', bg);
    // fondo del body (por si el navegador cache√≥ estilos)
    document.body.style.background = bg;
  }
}

/* ========= C√≥mputo de tabla por grupo ========= */
function computeTable(matches, teams){
  const t = Object.fromEntries((teams||[]).map(x => [x, {team:x,PJ:0,G:0,E:0,P:0,GF:0,GC:0,DG:0,Pts:0}]));
  const cfg = {win:3, draw:1, loss:0};
  for(const m of (matches||[])){
    if(m.gh==null || m.ga==null) continue;
    const H=t[m.home], A=t[m.away]; if(!H||!A) continue;
    H.PJ++; A.PJ++;
    H.GF += m.gh; H.GC += m.ga;
    A.GF += m.ga; A.GC += m.gh;
    if(m.gh>m.ga){ H.G++; A.P++; H.Pts += cfg.win; }
    else if(m.gh<m.ga){ A.G++; H.P++; A.Pts += cfg.win; }
    else { H.E++; A.E++; H.Pts += cfg.draw; A.Pts += cfg.draw; }
  }
  for(const x of (teams||[])){ t[x].DG = t[x].GF - t[x].GC; }
  return Object.values(t).sort((a,b)=> b.Pts-a.Pts || b.DG-a.DG || b.GF-a.GF || a.team.localeCompare(b.team));
}

/* ========= Ganador por grupo (para seeds si no hay nombres manuales) ========= */
function groupWinner(g){
  const rows = computeTable(g.matches||[], g.teams||[]);
  return rows[0]?.team || '';
}

/* ========= UI de grupos ========= */
function groupBlock(key, g){
  const teams = g.teams || [];
  const matches = g.matches || [];
  const cal = matches.map(m=>{
    const gh = (m.gh==null || m.gh==='') ? '‚Äî' : m.gh;
    const ga = (m.ga==null || m.ga==='') ? '‚Äî' : m.ga;
    const hour  = (m.hour||'').trim();
    const place = (m.place||'').trim();
    const meta  = (hour||place)
      ? `<div class="meta">${hour?`<span><span class="icon">üïí</span>${hour}</span>`:''}${place?`<span><span class="icon">üìç</span>${place}</span>`:''}</div>`
      : '';
    return `
      <div class="match">
        <div>${m.home||''}</div>
        <div class="score">${gh} ‚Äî ${ga}</div>
        <div style="text-align:right">${m.away||''}</div>
        ${meta}
      </div>`;
  }).join('') || `<div class="badge">No hay calendario para el grupo ${key}</div>`;

  const rows = computeTable(matches, teams);
  const tbody = rows.map((r,i)=>`
    <tr>
      <td class="pos">${i+1}</td>
      <td>${r.team}</td>
      <td>${r.PJ}</td>
      <td>${r.G}</td>
      <td>${r.E}</td>
      <td>${r.P}</td>
      <td>${r.GF}</td>
      <td>${r.GC}</td>
      <td>${r.DG}</td>
      <td class="pts">${r.Pts}</td>
    </tr>`).join('');

  return `
  <div class="group">
    <h3>Grupo ${key}</h3>
    <div class="inner">
      <div><b>Calendario y resultados</b></div>
      <div class="matches">${cal}</div>
      <div class="hr"></div>
      <div><b>Tabla de posiciones</b></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>E</th><th>P</th><th>GF</th><th>GC</th><th>DG</th><th>Pts</th></tr>
          </thead>
          <tbody>${tbody}</tbody>
        </table>
      </div>
    </div>
  </div>`;
}

/* ========= KO (lee manuales y, si faltan, calcula) ========= */
function koLine(title, m, defaults){
  const home  = (m?.home && m.home.trim()) ? m.home : (defaults?.home || '');
  const away  = (m?.away && m.away.trim()) ? m.away : (defaults?.away || '');
  const gh    = (m?.gh==null || m.gh==='') ? '‚Äî' : m.gh;
  const ga    = (m?.ga==null || m.ga==='') ? '‚Äî' : m.ga;
  const hour  = (m?.hour||'').trim();
  const place = (m?.place||'').trim();
  const meta  = (hour||place)
    ? `<div class="meta" style="margin-top:4px">${hour?`<span><span class="icon">üïí</span>${hour}</span>`:''}${place?`<span><span class="icon">üìç</span>${place}</span>`:''}</div>`
    : '';
  const winner = (m?.winner||'').trim();
  return `
    <div class="card">
      <h3>${title}</h3>
      <div class="match">
        <div>${home||defaults.home}</div>
        <div class="score">${gh} ‚Äî ${ga}</div>
        <div style="text-align:right">${away||defaults.away}</div>
      </div>
      ${meta}
      ${winner?`<div class="badge" style="margin-top:8px">Ganador: <b>${winner}</b></div>`:''}
    </div>`;
}

/* ========= Render principal ========= */
function renderAll(data){
  applyTheme(data);

  $('#title').textContent = data.tournamentName || 'Torneo';
  $('#subtitle').textContent = data.subtitle || '';

  // Grupos
  const gr = $('#groupsRoot');
  gr.innerHTML = '';
  const order = ['A','B','C','D'];
  const groupsObj = data.groups || {};
  order.forEach(k=>{
    if(groupsObj[k]) gr.insertAdjacentHTML('beforeend', groupBlock(k, groupsObj[k]));
  });

  // Semillas KO: usar manuales; si faltan, usar l√≠deres de tabla
  const A1 = groupsObj.A ? groupWinner(groupsObj.A) : 'A1';
  const B1 = groupsObj.B ? groupWinner(groupsObj.B) : 'B1';
  const C1 = groupsObj.C ? groupWinner(groupsObj.C) : 'C1';
  const D1 = groupsObj.D ? groupWinner(groupsObj.D) : 'D1';

  const ko = data.knockout || {};
  const sf1Defaults = {home: A1 || 'A1', away: D1 || 'D1'};
  const sf2Defaults = {home: B1 || 'B1', away: C1 || 'C1'};
  const fiDefaults  = {home: 'Ganador SF1', away: 'Ganador SF2'};

  const koRoot = $('#koRoot');
  koRoot.innerHTML = `
    <div class="bracket">
      ${koLine('Semifinal 1', ko.sf1, sf1Defaults)}
      ${koLine('Semifinal 2', ko.sf2, sf2Defaults)}
    </div>
    <div class="hr"></div>
    ${koLine('Final', ko.final, fiDefaults)}
  `;

  // Pie
  const f = $('#footer');
  if(data.updatedAtLocal){
    f.textContent = '√öltima actualizaci√≥n: ' + data.updatedAtLocal;
  }else{
    f.textContent = '';
  }
}

/* ========= Init ========= */
loadData().catch(err=>{
  $('#groupsRoot').innerHTML = `<div class="badge">‚ùå ${err.message}</div>`;
});

// === Controles Car√°tula ===
document.addEventListener('DOMContentLoaded', () => {
  $('#btnSave').addEventListener('click', () => {
    try{
      // Tomar el √∫ltimo JSON cargado de localStorage (si existiera), si no, construir m√≠nimo.
      let current = {};
      try { current = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch(_){}
      if (!current || typeof current !== 'object') current = {};
      current.tournamentName = $('#ctlName').value.trim() || current.tournamentName || '';
      current.theme = {
        color: $('#ctlAccent').value || (current.theme && current.theme.color) || '#0284c7',
        bg: $('#ctlBg').value || (current.theme && current.theme.bg) || '#f8fafc'
      };
      saveToStorage(current);
      // Feedback sutil
      const footer = $('#footer');
      if (footer) footer.textContent = 'Datos guardados en el navegador. Puedes abrir el administrador.';
      // Actualizar header/preview al vuelo
      applyTheme(current);
      $('#title').textContent = current.tournamentName || 'Torneo';
    }catch(e){ console.error(e); }
  });

  $('#btnOpenAdmin').addEventListener('click', () => {
    // Ajusta el nombre si tu administrador tiene otro archivo
    location.href = 'administrador_final_banda.html';
  });

  // Cambios en vivo de color
  $('#ctlAccent').addEventListener('input', e => {
    document.documentElement.style.setProperty('--accent', e.target.value || '#0284c7');
    const header = document.querySelector('header');
    if(header) header.style.background = `linear-gradient(90deg, ${e.target.value || '#0284c7'}, ${e.target.value || '#0284c7'})`;
  });
  $('#ctlBg').addEventListener('input', e => {
    document.documentElement.style.setProperty('--bg', e.target.value || '#f8fafc');
    document.body.style.background = e.target.value || '#f8fafc';
  });
  $('#ctlName').addEventListener('input', e => {
    $('#title').textContent = e.target.value || 'Torneo';
  });
});

</script>
</body>
</html>
