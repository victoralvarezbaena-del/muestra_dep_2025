<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrador ‚Äî Torneo V√≥ley Playa 7 Equipos</title>
  <style>
    :root {
      --bg: #f8fafc;
      --panel: #e2e8f0;
      --card: #ffffff;
      --muted: #475569;
      --text: #0f172a;
      --accent: #f59e0b;
      --ok: #16a34a;
      --bad: #dc2626;
      --ring: 0 0 0 2px var(--accent) inset;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    header {
      padding: 20px 16px;
      border-bottom: 2px solid #cbd5e1;
      background: linear-gradient(90deg, var(--panel), #f1f5f9);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      margin: 0;
      font-size: clamp(22px, 3.2vw, 34px);
    }

    .subtitle {
      color: var(--muted);
      margin-top: 4px;
    }

    .card {
      background: var(--card);
      border: 1px solid #cbd5e1;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 3px 10px rgba(0,0,0,.1);
      margin-bottom: 16px;
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    label {
      display: block;
      margin: 8px 0 6px;
      color: var(--muted);
    }

    textarea, input[type="text"], input[type="number"], input[type="url"], select, input[type="file"], input[type="color"] {
      width: 100%;
      background: #f8fafc;
      color: var(--text);
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }

    textarea:focus, input:focus, select:focus {
      box-shadow: var(--ring);
      border-color: transparent;
    }

    textarea {
      min-height: 96px;
      white-space: pre;
    }

    button {
      background: linear-gradient(180deg, var(--accent), #fbbf24);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    button.ghost {
      background: transparent;
      color: var(--accent);
      border: 1px solid #cbd5e1;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .spacer {
      flex: 1;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 1100px) {
      .grid {
        grid-template-columns: 420px 1fr;
      }
    }

    /* Grupos */
    .groups {
      display: grid;
      gap: 12px;
    }

    @media (min-width: 700px) {
      .groups {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* Colores por grupo */
    .groupA {
      background: rgba(56,189,248,.12);
      border: 1px solid rgba(56,189,248,.45);
    }

    .groupB {
      background: rgba(168,85,247,.12);
      border: 1px solid rgba(168,85,247,.45);
    }

    .groupBox {
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 12px;
    }

    .matches {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .match {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 8px;
      align-items: center;
      background: #f8fafc;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      padding: 10px;
    }

    .team {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .team input {
      max-width: 80px;
      text-align: center;
    }

    .dash {
      opacity: .6;
    }

    .info {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .info input {
      background: #f8fafc;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #cbd5e1;
      text-align: right;
    }

    th:first-child, td:first-child {
      text-align: left;
    }

    thead th {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }

    tbody tr:hover {
      background: #e2e8f0;
    }

    .pos {
      font-variant-numeric: tabular-nums;
      color: var(--muted);
    }

    .pts {
      font-weight: 800;
    }

    .first {
      background: rgba(34,197,94,.15);
    }

    .note {
      font-size: 12px;
      color: var(--muted);
    }

    /* Fase eliminatoria */
    .bracket {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    @media (min-width: 900px) {
      .bracket {
        grid-template-columns: 1fr 1fr;
      }
    }

    .semi, .final, .third {
      background: #ffffff;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      padding: 12px;
    }

    .semi h3, .final h3, .third h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .final {
      position: relative;
      border: 2px solid var(--accent);
      box-shadow: 0 0 0 4px rgba(245,158,11,.12) inset;
      background: #ffffff;
      overflow: hidden;
    }

    .final h3 {
      color: var(--accent);
    }

    .final::before {
      content: 'FINAL üèê';
      position: absolute;
      top: 12px;
      right: -48px;
      transform: rotate(45deg);
      background: var(--accent);
      color: white;
      font-weight: 700;
      font-size: 14px;
      padding: 4px 48px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      opacity: 0.9;
    }

    /* Estado de publicaci√≥n */
    .status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 6px;
      margin-left: 8px;
    }

    .status.success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .status.loading {
      background: #eff6ff;
      color: #1e40af;
      border: 1px solid #dbeafe;
    }

    /* Import/Export section */
    .import-export {
      background: #f0f9ff;
      border: 2px dashed #bae6fd;
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
    }

    .import-export h3 {
      margin: 0 0 12px;
      font-size: 16px;
      color: #0369a1;
    }

    /* Estilos espec√≠ficos para v√≥ley playa */
    .sets-input {
      display: flex;
      gap: 4px;
      align-items: center;
      flex-direction: column;
    }

    .set-row {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .sets-input input {
      max-width: 50px;
      text-align: center;
    }

    .sets-separator {
      color: var(--muted);
      font-weight: bold;
    }

    /* Indicador de sets ganados */
    .sets-indicator {
      display: flex;
      gap: 2px;
      margin-top: 4px;
      justify-content: center;
    }

    .set-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #cbd5e1;
    }

    .set-dot.won {
      background-color: var(--ok);
    }

    .set-dot.lost {
      background-color: var(--bad);
    }

    .total-sets {
      font-weight: bold;
      margin-top: 4px;
      text-align: center;
    }

    .set-label {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .points-total {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Administrador ‚Äî Torneo V√≥ley Playa 7 Equipos</h1>
      <div class="subtitle">Crea y gestiona tu torneo de v√≥ley playa. 2 grupos (3+4 equipos) + Semifinales + Final</div>
    </div>
  </header>

  <main class="container grid">
    <section class="card">
      <h2>1) Equipos por grupo</h2>
      <div class="groups">
        <div>
          <label>Grupo A (3 equipos)</label>
          <textarea id="ga">Equipo A1
Equipo A2
Equipo A3</textarea>
        </div>
        <div>
          <label>Grupo B (4 equipos)</label>
          <textarea id="gb">Equipo B1
Equipo B2
Equipo B3
Equipo B4</textarea>
        </div>
      </div>

      <!-- Tema (colores) -->
      <div class="row" style="margin-top:8px">
        <input type="text" id="tournamentName" placeholder="Nombre del torneo (opcional)" style="flex:2" />
        <div style="display:flex; gap:8px; align-items:center">
          <label for="themeColor" style="margin:0;color:var(--muted)">Acento</label>
          <input type="color" id="themeColor" value="#f59e0b" style="width:54px;padding:0">
          <label for="themeBg" style="margin:0;color:var(--muted)">Fondo</label>
          <input type="color" id="themeBg" value="#f8fafc" style="width:54px;padding:0">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnGenerate">Generar rol por grupo</button>

        <!-- PUBLICAR (para GH Pages descarga data.json) -->
        <input type="url" id="publishURL" placeholder="(Opcional para otros backends)" style="flex:2; min-width:320px" />
        <button id="btnPublish">Publicar <span id="publishStatus"></span></button>

        <div class="spacer"></div>
        <button id="btnSaveCopy" class="ghost">üíæ Guardar copia</button>
        <button id="btnClearAll" class="ghost">üßπ Limpiar</button>
      </div>

      <!-- SECCI√ìN IMPORTAR/EXPORTAR -->
      <div class="import-export">
        <h3>üì• Importar / üì§ Exportar Datos</h3>
        <div class="row">
          <input type="file" id="importFile" accept=".json" style="flex:2">
          <button id="btnImport" class="ghost">üì• Importar JSON</button>
          <button id="btnExport" class="ghost">üì§ Exportar JSON</button>
        </div>
        <div style="font-size:12px; color:var(--muted); margin-top:8px">
          üí° Puedes importar un archivo JSON anterior para continuar donde lo dejaste
        </div>
      </div>

      <div style="margin-top:8px; font-size:12px; color:var(--muted)">
        üí° <strong>Para usar:</strong> 1) Agrega equipos ‚Üí 2) Genera rol ‚Üí 3) Ingresa resultados ‚Üí 4) Publica
      </div>
    </section>

    <section class="card">
      <h2>Grupos y partidos</h2>
      <div id="groupsRoot"></div>

      <div class="bracket">
        <div class="semi">
          <h3>Semifinal 1 ‚Äî A1 vs B2</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf1h">A1</span></div>
            <div class="team" style="justify-content:center">
              <div class="sets-input" id="sf1-sets-container">
                <!-- Los sets se generar√°n din√°micamente aqu√≠ -->
              </div>
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf1a">B2</span></div>
          </div>
          <div class="total-sets" id="sf1-total">Sets: 0-0</div>
          <div class="points-total" id="sf1-points">Puntos: 0-0</div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf1w" style="max-width:260px"><option value="">‚Äî Ganador ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf1Hour" placeholder="Hora (ej. 16:00)" style="max-width:180px">
            <input type="text" id="sf1Place" placeholder="Lugar (ej. Cancha)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf1HomeName" placeholder="Nombre semifinalista local (opcional)" style="flex:1">
            <input type="text" id="sf1AwayName" placeholder="Nombre semifinalista visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="semi">
          <h3>Semifinal 2 ‚Äî B1 vs A2</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf2h">B1</span></div>
            <div class="team" style="justify-content:center">
              <div class="sets-input" id="sf2-sets-container">
                <!-- Los sets se generar√°n din√°micamente aqu√≠ -->
              </div>
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf2a">A2</span></div>
          </div>
          <div class="total-sets" id="sf2-total">Sets: 0-0</div>
          <div class="points-total" id="sf2-points">Puntos: 0-0</div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf2w" style="max-width:260px"><option value="">‚Äî Ganador ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf2Hour" placeholder="Hora (ej. 17:00)" style="max-width:180px">
            <input type="text" id="sf2Place" placeholder="Lugar (ej. Cancha)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf2HomeName" placeholder="Nombre semifinalista local (opcional)" style="flex:1">
            <input type="text" id="sf2AwayName" placeholder="Nombre semifinalista visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="final">
          <h3>Final</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="fih">Ganador SF1</span></div>
            <div class="team" style="justify-content:center">
              <div class="sets-input" id="fi-sets-container">
                <!-- Los sets se generar√°n din√°micamente aqu√≠ -->
              </div>
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="fia">Ganador SF2</span></div>
          </div>
          <div class="total-sets" id="fi-total">Sets: 0-0</div>
          <div class="points-total" id="fi-points">Puntos: 0-0</div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige campe√≥n</label>
            <select id="fiw" style="max-width:260px"><option value="">‚Äî Campe√≥n ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="fiHour" placeholder="Hora (ej. 19:00)" style="max-width:180px">
            <input type="text" id="fiPlace" placeholder="Lugar (ej. Cancha)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="fiHomeName" placeholder="Nombre finalista local (opcional)" style="flex:1">
            <input type="text" id="fiAwayName" placeholder="Nombre finalista visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="third">
          <h3>Tercer Lugar</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="thirdh">Perdedor SF1</span></div>
            <div class="team" style="justify-content:center">
              <div class="sets-input" id="third-sets-container">
                <!-- Los sets se generar√°n din√°micamente aqu√≠ -->
              </div>
            </div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="thirda">Perdedor SF2</span></div>
          </div>
          <div class="total-sets" id="third-total">Sets: 0-0</div>
          <div class="points-total" id="third-points">Puntos: 0-0</div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige tercero</label>
            <select id="thirdw" style="max-width:260px"><option value="">‚Äî Tercero ‚Äî</option></select>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="thirdHour" placeholder="Hora (ej. 18:00)" style="max-width:180px">
            <input type="text" id="thirdPlace" placeholder="Lugar (ej. Cancha)" style="flex:1">
          </div>
          <!-- Nombres manuales (opcional) -->
          <div class="row" style="margin-top:6px">
            <input type="text" id="thirdHomeName" placeholder="Nombre local tercer lugar (opcional)" style="flex:1">
            <input type="text" id="thirdAwayName" placeholder="Nombre visita tercer lugar (opcional)" style="flex:1">
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== CONFIGURACI√ìN =====
    const STORAGE_KEY = 'torneo_voley_playa_7_equipos_v1';
    const $ = (selector, root = document) => root.querySelector(selector);

    // ===== ESTADO INICIAL =====
    let state = {
      groups: {
        A: { teams: ['Equipo A1', 'Equipo A2', 'Equipo A3'], matches: [] },
        B: { teams: ['Equipo B1', 'Equipo B2', 'Equipo B3', 'Equipo B4'], matches: [] }
      },
      points: { win: 2, loss: 1 }, // Para v√≥ley playa: 2 puntos por victoria, 1 por derrota
      knockout: {
        sf1: { home: '', away: '', sets: [], winner: '', hour: '', place: '', homeName: '', awayName: '' },
        sf2: { home: '', away: '', sets: [], winner: '', hour: '', place: '', homeName: '', awayName: '' },
        final: { home: '', away: '', sets: [], winner: '', hour: '', place: '', homeName: '', awayName: '' },
        third: { home: '', away: '', sets: [], winner: '', hour: '', place: '', homeName: '', awayName: '' }
      },
      tournamentName: '',
      theme: { color: '#f59e0b', bg: '#f8fafc' }
    };

    // ===== HELPERS =====
    function parseTeams(txt) {
      return String(txt || '').split('\n').map(s => s.trim()).filter(Boolean);
    }

    // Sistema de todos contra todos para grupos de 3 y 4 equipos
    function roundRobin(teams) {
      const matches = [];
      const n = teams.length;
      
      for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
          matches.push([teams[i], teams[j]]);
        }
      }
      
      return matches;
    }

    function valInt(v) {
      if (v === '' || v == null) return null;
      const n = parseInt(v, 10);
      return Number.isFinite(n) && n >= 0 ? n : null;
    }

    // Calcular total de sets ganados y puntos totales
    function calculateSetsAndPoints(sets) {
      let homeSets = 0;
      let awaySets = 0;
      let homePoints = 0;
      let awayPoints = 0;
      
      sets.forEach(set => {
        if (set.home !== null && set.away !== null) {
          homePoints += set.home || 0;
          awayPoints += set.away || 0;
          
          if (set.home > set.away) homeSets++;
          else if (set.away > set.home) awaySets++;
        }
      });
      
      return { 
        homeSets, 
        awaySets, 
        homePoints, 
        awayPoints,
        pointsDifference: homePoints - awayPoints
      };
    }

    // Calcular tabla de posiciones con diferencia de puntos
    function computeTable(matches, teams) {
      const table = Object.fromEntries(teams.map(team => [team, {
        team, PJ: 0, G: 0, P: 0, 
        SF: 0, SC: 0, DS: 0,        // Sets a favor, en contra, diferencia
        PF: 0, PC: 0, DP: 0,        // Puntos a favor, en contra, diferencia
        Pts: 0
      }]));
      
      const cfg = state.points;
      
      matches.forEach(match => {
        if (!match.sets || match.sets.length === 0) return;
        
        const homeTeam = table[match.home];
        const awayTeam = table[match.away];
        if (!homeTeam || !awayTeam) return;
        
        // Calcular sets ganados y puntos totales
        const result = calculateSetsAndPoints(match.sets);
        
        // Actualizar partidos jugados
        homeTeam.PJ++;
        awayTeam.PJ++;
        
        // Actualizar sets
        homeTeam.SF += result.homeSets;
        homeTeam.SC += result.awaySets;
        awayTeam.SF += result.awaySets;
        awayTeam.SC += result.homeSets;
        
        // Actualizar puntos
        homeTeam.PF += result.homePoints;
        homeTeam.PC += result.awayPoints;
        awayTeam.PF += result.awayPoints;
        awayTeam.PC += result.homePoints;
        
        // Determinar resultado (v√≥ley playa: no hay empates)
        if (result.homeSets > result.awaySets) {
          homeTeam.G++;
          awayTeam.P++;
          homeTeam.Pts += cfg.win;
          awayTeam.Pts += cfg.loss;
        } else {
          awayTeam.G++;
          homeTeam.P++;
          awayTeam.Pts += cfg.win;
          homeTeam.Pts += cfg.loss;
        }
      });
      
      // Calcular diferencias
      teams.forEach(team => {
        table[team].DS = table[team].SF - table[team].SC;
        table[team].DP = table[team].PF - table[team].PC;
      });
      
      // Ordenar por puntos, diferencia de sets, diferencia de puntos, puntos a favor
      return Object.values(table).sort((a, b) => {
        if (b.Pts !== a.Pts) return b.Pts - a.Pts;
        if (b.DS !== a.DS) return b.DS - a.DS;
        if (b.DP !== a.DP) return b.DP - a.DP;
        if (b.PF !== a.PF) return b.PF - a.PF;
        return a.team.localeCompare(b.team);
      });
    }

    function groupWinner(groupKey) {
      const group = state.groups[groupKey];
      const rows = computeTable(group.matches, group.teams);
      return rows[0]?.team || '';
    }

    function groupRunnerUp(groupKey) {
      const group = state.groups[groupKey];
      const rows = computeTable(group.matches, group.teams);
      return rows[1]?.team || '';
    }

    // ===== RENDER GRUPOS =====
    function renderGroups() {
      const root = $('#groupsRoot');
      root.innerHTML = '';
      
      ['A', 'B'].forEach(groupKey => {
        const group = state.groups[groupKey];
        const teams = group.teams || [];
        
        const groupDiv = document.createElement('div');
        groupDiv.className = `groupBox group${groupKey}`;
        groupDiv.innerHTML = `<h3>Grupo ${groupKey} (${teams.length} equipos)</h3>`;
        
        const matchesContainer = document.createElement('div');
        matchesContainer.className = 'matches';
        
        // Crear partidos (todos contra todos)
        const calendar = roundRobin(teams);
        calendar.forEach(([home, away]) => {
          const existingMatch = group.matches.find(m => m.home === home && m.away === away) || 
                              { home, away, sets: [], hour: '', place: '' };
          
          const matchDiv = document.createElement('div');
          matchDiv.className = 'match';
          
          // Crear contenedor de sets
          const setsContainer = document.createElement('div');
          setsContainer.className = 'sets-input';
          setsContainer.id = `match-${groupKey}-${home}-${away}`;
          
          // Generar inputs para sets (m√°ximo 3 sets para v√≥ley playa)
          for (let i = 0; i < 3; i++) {
            const setRow = document.createElement('div');
            setRow.className = 'set-row';
            
            const setData = existingMatch.sets[i] || { home: '', away: '' };
            
            setRow.innerHTML = `
              <input type="number" min="0" class="set-home" data-group="${groupKey}" data-home="${home}" data-away="${away}" data-set="${i}" 
                     value="${setData.home || ''}" style="max-width:50px" placeholder="0">
              <span class="sets-separator">-</span>
              <input type="number" min="0" class="set-away" data-group="${groupKey}" data-home="${home}" data-away="${away}" data-set="${i}" 
                     value="${setData.away || ''}" style="max-width:50px" placeholder="0">
              <div class="set-label">Set ${i + 1}</div>
            `;
            
            setsContainer.appendChild(setRow);
          }
          
          matchDiv.innerHTML = `
            <div class="team">${home}</div>
            <div class="team" style="justify-content:center">
              ${setsContainer.outerHTML}
            </div>
            <div class="team" style="justify-content:flex-end">${away}</div>
          `;
          
          // Calcular y mostrar total
          const result = calculateSetsAndPoints(existingMatch.sets);
          const totalDiv = document.createElement('div');
          totalDiv.className = 'total-sets';
          totalDiv.id = `total-${groupKey}-${home}-${away}`;
          totalDiv.textContent = `Sets: ${result.homeSets}-${result.awaySets}`;
          
          // Mostrar puntos totales
          const pointsDiv = document.createElement('div');
          pointsDiv.className = 'points-total';
          pointsDiv.id = `points-${groupKey}-${home}-${away}`;
          pointsDiv.textContent = `Puntos: ${result.homePoints}-${result.awayPoints}`;
          
          // Indicador visual de sets
          const setsIndicator = document.createElement('div');
          setsIndicator.className = 'sets-indicator';
          
          for (let i = 0; i < result.homeSets; i++) {
            const setDot = document.createElement('div');
            setDot.className = 'set-dot won';
            setsIndicator.appendChild(setDot);
          }
          
          for (let i = 0; i < result.awaySets; i++) {
            const setDot = document.createElement('div');
            setDot.className = 'set-dot lost';
            setsIndicator.appendChild(setDot);
          }
          
          const infoDiv = document.createElement('div');
          infoDiv.className = 'info';
          infoDiv.innerHTML = `
            <input type="text" class="match-hour" data-group="${groupKey}" data-home="${home}" data-away="${away}" 
                   placeholder="Hora (ej. 14:00)" value="${existingMatch.hour || ''}">
            <input type="text" class="match-place" data-group="${groupKey}" data-home="${home}" data-away="${away}" 
                   placeholder="Lugar (ej. Cancha 1)" value="${existingMatch.place || ''}">
          `;
          
          matchesContainer.appendChild(matchDiv);
          matchesContainer.appendChild(totalDiv);
          matchesContainer.appendChild(pointsDiv);
          matchesContainer.appendChild(setsIndicator);
          matchesContainer.appendChild(infoDiv);
        });
        
        groupDiv.appendChild(matchesContainer);
        
        // Tabla de posiciones
        const rows = computeTable(group.matches, teams);
        const tableHTML = `
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>P</th>
                  <th>SF</th><th>SC</th><th>DS</th>
                  <th>PF</th><th>PC</th><th>DP</th>
                  <th>Pts</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map((row, index) => `
                  <tr class="${index === 0 ? 'first' : ''}">
                    <td class="pos">${index + 1}</td>
                    <td>${row.team}</td>
                    <td>${row.PJ}</td>
                    <td>${row.G}</td>
                    <td>${row.P}</td>
                    <td>${row.SF}</td>
                    <td>${row.SC}</td>
                    <td>${row.DS}</td>
                    <td>${row.PF}</td>
                    <td>${row.PC}</td>
                    <td>${row.DP}</td>
                    <td class="pts">${row.Pts}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div class="note" style="margin-top: 8px;">
              üí° Orden: Puntos ‚Üí Dif. Sets ‚Üí Dif. Puntos ‚Üí Puntos a favor
            </div>
          </div>
        `;
        
        groupDiv.insertAdjacentHTML('beforeend', tableHTML);
        root.appendChild(groupDiv);
      });
      
      setupGroupEventListeners();
    }

    // ===== EVENT LISTENERS PARA GRUPOS =====
    function setupGroupEventListeners() {
      // Sets
      document.querySelectorAll('.set-home, .set-away').forEach(input => {
        input.addEventListener('input', function() {
          const groupKey = this.dataset.group;
          const home = this.dataset.home;
          const away = this.dataset.away;
          const setIndex = parseInt(this.dataset.set);
          
          let match = state.groups[groupKey].matches.find(m => m.home === home && m.away === away);
          if (!match) {
            match = { home, away, sets: [], hour: '', place: '' };
            state.groups[groupKey].matches.push(match);
          }
          
          if (!match.sets[setIndex]) {
            match.sets[setIndex] = { home: null, away: null };
          }
          
          const val = valInt(this.value);
          if (this.classList.contains('set-home')) {
            match.sets[setIndex].home = val;
          } else {
            match.sets[setIndex].away = val;
          }
          
          // Actualizar total
          const result = calculateSetsAndPoints(match.sets);
          const totalEl = $(`#total-${groupKey}-${home}-${away}`);
          const pointsEl = $(`#points-${groupKey}-${home}-${away}`);
          if (totalEl) totalEl.textContent = `Sets: ${result.homeSets}-${result.awaySets}`;
          if (pointsEl) pointsEl.textContent = `Puntos: ${result.homePoints}-${result.awayPoints}`;
          
          // Actualizar indicador visual de sets
          const setsIndicator = totalEl?.nextElementSibling?.nextElementSibling;
          if (setsIndicator) {
            setsIndicator.innerHTML = '';
            for (let i = 0; i < result.homeSets; i++) {
              const setDot = document.createElement('div');
              setDot.className = 'set-dot won';
              setsIndicator.appendChild(setDot);
            }
            for (let i = 0; i < result.awaySets; i++) {
              const setDot = document.createElement('div');
              setDot.className = 'set-dot lost';
              setsIndicator.appendChild(setDot);
            }
          }
          
          saveState();
          updateKnockoutTeams();
        });
      });
      
      // Hora y lugar
      document.querySelectorAll('.match-hour, .match-place').forEach(input => {
        input.addEventListener('input', function() {
          const groupKey = this.dataset.group;
          const home = this.dataset.home;
          const away = this.dataset.away;
          
          let match = state.groups[groupKey].matches.find(m => m.home === home && m.away === away);
          if (!match) {
            match = { home, away, sets: [], hour: '', place: '' };
            state.groups[groupKey].matches.push(match);
          }
          
          if (this.classList.contains('match-hour')) {
            match.hour = this.value;
          } else {
            match.place = this.value;
          }
          
          saveState();
        });
      });
    }

    // ===== FASE ELIMINATORIA =====
    function updateKnockoutTeams() {
      // Actualizar equipos en semifinales
      const a1 = groupWinner('A') || 'A1';
      const a2 = groupRunnerUp('A') || 'A2';
      const b1 = groupWinner('B') || 'B1';
      const b2 = groupRunnerUp('B') || 'B2';
      
      // Semifinal 1: A1 vs B2
      $('#sf1h').textContent = a1;
      $('#sf1a').textContent = b2;
      state.knockout.sf1.home = a1;
      state.knockout.sf1.away = b2;
      
      // Semifinal 2: B1 vs A2
      $('#sf2h').textContent = b1;
      $('#sf2a').textContent = a2;
      state.knockout.sf2.home = b1;
      state.knockout.sf2.away = a2;
      
      // Actualizar opciones de ganadores
      updateWinnerOptions('sf1', [a1, b2]);
      updateWinnerOptions('sf2', [b1, a2]);
      
      // Actualizar final y tercer lugar
      updateFinalAndThird();
      
      saveState();
    }

    function updateWinnerOptions(knockoutKey, teams) {
      const select = $(`#${knockoutKey}w`);
      select.innerHTML = '<option value="">‚Äî Ganador ‚Äî</option>';
      teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team;
        option.textContent = team;
        if (state.knockout[knockoutKey].winner === team) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }

    function updateFinalAndThird() {
      const sf1Winner = state.knockout.sf1.winner || 'Ganador SF1';
      const sf2Winner = state.knockout.sf2.winner || 'Ganador SF2';
      const sf1Loser = state.knockout.sf1.winner ? 
        (state.knockout.sf1.winner === state.knockout.sf1.home ? 
          state.knockout.sf1.away : state.knockout.sf1.home) : 'Perdedor SF1';
      const sf2Loser = state.knockout.sf2.winner ? 
        (state.knockout.sf2.winner === state.knockout.sf2.home ? 
          state.knockout.sf2.away : state.knockout.sf2.home) : 'Perdedor SF2';
      
      // Final
      $('#fih').textContent = sf1Winner;
      $('#fia').textContent = sf2Winner;
      state.knockout.final.home = sf1Winner;
      state.knockout.final.away = sf2Winner;
      updateWinnerOptions('final', [sf1Winner, sf2Winner]);
      
      // Tercer lugar
      $('#thirdh').textContent = sf1Loser;
      $('#thirda').textContent = sf2Loser;
      state.knockout.third.home = sf1Loser;
      state.knockout.third.away = sf2Loser;
      updateWinnerOptions('third', [sf1Loser, sf2Loser]);
    }

    function renderKnockoutSets() {
      // Para cada partido eliminatorio, crear inputs de sets
      ['sf1', 'sf2', 'final', 'third'].forEach(key => {
        const container = $(`#${key}-sets-container`);
        container.innerHTML = '';
        
        // En v√≥ley playa se juegan m√°ximo 3 sets
        for (let i = 0; i < 3; i++) {
          const setRow = document.createElement('div');
          setRow.className = 'set-row';
          
          const setData = state.knockout[key].sets[i] || { home: '', away: '' };
          
          setRow.innerHTML = `
            <input type="number" min="0" class="knockout-set-home" data-key="${key}" data-set="${i}" 
                   value="${setData.home || ''}" style="max-width:50px" placeholder="0">
            <span class="sets-separator">-</span>
            <input type="number" min="0" class="knockout-set-away" data-key="${key}" data-set="${i}" 
                   value="${setData.away || ''}" style="max-width:50px" placeholder="0">
            <div class="set-label">Set ${i + 1}</div>
          `;
          
          container.appendChild(setRow);
        }
        
        // Actualizar total
        const result = calculateSetsAndPoints(state.knockout[key].sets);
        const totalEl = $(`#${key}-total`);
        const pointsEl = $(`#${key}-points`);
        if (totalEl) totalEl.textContent = `Sets: ${result.homeSets}-${result.awaySets}`;
        if (pointsEl) pointsEl.textContent = `Puntos: ${result.homePoints}-${result.awayPoints}`;
      });
      
      setupKnockoutEventListeners();
    }

    function setupKnockoutEventListeners() {
      // Sets eliminatorios
      document.querySelectorAll('.knockout-set-home, .knockout-set-away').forEach(input => {
        input.addEventListener('input', function() {
          const key = this.dataset.key;
          const setIndex = parseInt(this.dataset.set);
          
          if (!state.knockout[key].sets[setIndex]) {
            state.knockout[key].sets[setIndex] = { home: null, away: null };
          }
          
          const val = valInt(this.value);
          if (this.classList.contains('knockout-set-home')) {
            state.knockout[key].sets[setIndex].home = val;
          } else {
            state.knockout[key].sets[setIndex].away = val;
          }
          
          // Actualizar total
          const result = calculateSetsAndPoints(state.knockout[key].sets);
          const totalEl = $(`#${key}-total`);
          const pointsEl = $(`#${key}-points`);
          if (totalEl) totalEl.textContent = `Sets: ${result.homeSets}-${result.awaySets}`;
          if (pointsEl) pointsEl.textContent = `Puntos: ${result.homePoints}-${result.awayPoints}`;
          
          saveState();
        });
      });
      
      // Ganadores
      document.querySelectorAll('#sf1w, #sf2w, #fiw, #thirdw').forEach(select => {
        select.addEventListener('change', function() {
          const key = this.id.replace('w', '');
          state.knockout[key].winner = this.value;
          saveState();
          updateFinalAndThird();
        });
      });
      
      // Hora y lugar
      document.querySelectorAll('#sf1Hour, #sf1Place, #sf2Hour, #sf2Place, #fiHour, #fiPlace, #thirdHour, #thirdPlace').forEach(input => {
        input.addEventListener('input', function() {
          const id = this.id;
          const key = id.includes('sf1') ? 'sf1' : 
                     id.includes('sf2') ? 'sf2' : 
                     id.includes('fi') ? 'final' : 'third';
          const field = id.includes('Hour') ? 'hour' : 'place';
          
          state.knockout[key][field] = this.value;
          saveState();
        });
      });
      
      // Nombres manuales
      document.querySelectorAll('#sf1HomeName, #sf1AwayName, #sf2HomeName, #sf2AwayName, #fiHomeName, #fiAwayName, #thirdHomeName, #thirdAwayName').forEach(input => {
        input.addEventListener('input', function() {
          const id = this.id;
          let key, field;
          
          if (id.includes('sf1')) {
            key = 'sf1';
            field = id.includes('HomeName') ? 'homeName' : 'awayName';
          } else if (id.includes('sf2')) {
            key = 'sf2';
            field = id.includes('HomeName') ? 'homeName' : 'awayName';
          } else if (id.includes('fi')) {
            key = 'final';
            field = id.includes('HomeName') ? 'homeName' : 'awayName';
          } else if (id.includes('third')) {
            key = 'third';
            field = id.includes('HomeName') ? 'homeName' : 'awayName';
          }
          
          if (key && field) {
            state.knockout[key][field] = this.value;
            saveState();
          }
        });
      });
    }

    // ===== PERSISTENCIA =====
    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          state = { ...state, ...parsed };
        } catch (e) {
          console.warn('No se pudo cargar el estado guardado', e);
        }
      }
    }

    // ===== FUNCIONES DE LOS BOTONES =====
    function generateGroups() {
      state.groups.A.teams = parseTeams($('#ga').value);
      state.groups.B.teams = parseTeams($('#gb').value);
      
      // Limpiar partidos anteriores
      state.groups.A.matches = [];
      state.groups.B.matches = [];
      
      saveState();
      renderGroups();
      updateKnockoutTeams();
      renderKnockoutSets();
      
      alert('‚úÖ Rol de partidos generado correctamente');
    }

    function saveCopy() {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `torneo-voley-playa-${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert('‚úÖ Copia de seguridad guardada');
    }

    function clearAll() {
      if (confirm('¬øBorrar todos los datos? Se perder√°n equipos, resultados y configuraciones.')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    function publish() {
      const statusEl = $('#publishStatus');
      statusEl.textContent = '‚è≥';
      statusEl.className = 'status loading';
      
      // Crear archivo data.json para publicaci√≥n
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'data.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // Simular publicaci√≥n
      setTimeout(() => {
        statusEl.textContent = '‚úÖ';
        statusEl.className = 'status success';
        setTimeout(() => {
          statusEl.textContent = '';
        }, 3000);
      }, 1000);
    }

    function importData() {
      const fileInput = $('#importFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Selecciona un archivo JSON para importar');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedState = JSON.parse(e.target.result);
          state = { ...state, ...importedState };
          saveState();
          location.reload();
        } catch (err) {
          alert('Error al importar el archivo: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    function exportData() {
      saveCopy();
    }

    function updateTheme() {
      document.documentElement.style.setProperty('--accent', state.theme.color);
      document.documentElement.style.setProperty('--bg', state.theme.bg);
    }

    // ===== INICIALIZACI√ìN =====
    function init() {
      loadState();
      
      // Cargar valores iniciales
      $('#ga').value = state.groups.A.teams.join('\n');
      $('#gb').value = state.groups.B.teams.join('\n');
      $('#tournamentName').value = state.tournamentName || '';
      $('#themeColor').value = state.theme.color;
      $('#themeBg').value = state.theme.bg;
      
      // Cargar datos de fase eliminatoria
      ['sf1', 'sf2', 'final', 'third'].forEach(key => {
        $(`#${key}Hour`).value = state.knockout[key].hour || '';
        $(`#${key}Place`).value = state.knockout[key].place || '';
        
        // Nombres manuales
        if (state.knockout[key].homeName) $(`#${key}HomeName`).value = state.knockout[key].homeName;
        if (state.knockout[key].awayName) $(`#${key}AwayName`).value = state.knockout[key].awayName;
      });
      
      // Renderizar grupos y fase eliminatoria
      renderGroups();
      renderKnockoutSets();
      updateKnockoutTeams();
      
      // Event listeners principales
      $('#btnGenerate').addEventListener('click', generateGroups);
      $('#btnSaveCopy').addEventListener('click', saveCopy);
      $('#btnClearAll').addEventListener('click', clearAll);
      $('#btnPublish').addEventListener('click', publish);
      $('#btnImport').addEventListener('click', () => $('#importFile').click());
      $('#btnExport').addEventListener('click', exportData);
      
      // Event listeners para tema
      $('#tournamentName').addEventListener('input', function() {
        state.tournamentName = this.value;
        saveState();
      });
      
      $('#themeColor').addEventListener('input', function() {
        state.theme.color = this.value;
        saveState();
        updateTheme();
      });
      
      $('#themeBg').addEventListener('input', function() {
        state.theme.bg = this.value;
        saveState();
        updateTheme();
      });
      
      // Event listener para importar archivo
      $('#importFile').addEventListener('change', importData);
      
      updateTheme();
    }

    // Inicializar la aplicaci√≥n
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>