<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrador ‚Äî Voleibol de Playa (2 Grupos + Semifinales) ‚Äî FIX</title>
  <style>
    :root{ --bg:#f8fafc; --panel:#e2e8f0; --card:#ffffff; --muted:#475569; --text:#0f172a; --accent:#0284c7; --ok:#16a34a; --bad:#dc2626; --ring:0 0 0 2px var(--accent) inset; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:20px 16px;border-bottom:2px solid #cbd5e1;background:linear-gradient(90deg,#e2e8f0,#f1f5f9);position:sticky;top:0;z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:clamp(22px,3.2vw,34px)}
    .subtitle{color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media(min-width:1100px){.grid{grid-template-columns:420px 1fr}}
    .card{background:var(--card);border:1px solid #cbd5e1;border-radius:18px;padding:16px;box-shadow:0 3px 10px rgba(0,0,0,.1)}
    .card h2{margin:0 0 12px;font-size:18px}
    label{display:block;margin:8px 0 6px;color:var(--muted)}
    textarea,input[type="text"],input[type="number"],input[type="url"],select,input[type="file"],input[type="color"]{width:100%;background:#f8fafc;color:var(--text);border:1px solid #cbd5e1;border-radius:12px;padding:10px 12px;outline:none}
    textarea:focus,input:focus,select:focus{box-shadow:var(--ring);border-color:transparent}
    textarea{min-height:96px;white-space:pre}
    button{background:linear-gradient(180deg,var(--accent),#0ea5e9);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #cbd5e1}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .spacer{flex:1}
    .groups{display:grid;gap:12px}
    @media(min-width:700px){.groups{grid-template-columns:1fr 1fr}}
    .groupA{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.45)}
    .groupB{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.45)}
    .groupBox{padding:12px;border-radius:12px;margin-bottom:12px}
    .matches{display:grid;gap:10px;margin-top:10px}
    .match{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;background:#f8fafc;border:1px solid #cbd5e1;border-radius:12px;padding:10px}
    .team{display:flex;align-items:center;gap:10px}
    .dash{opacity:.6}
    .info{display:flex;gap:8px;margin-top:6px}
    .info input{background:#f8fafc;border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 10px;border-bottom:1px solid #cbd5e1;text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{font-size:12px;color:var(--muted);font-weight:600}
    tbody tr:hover{background:#e2e8f0}
    .pos{font-variant-numeric:tabular-nums;color:var(--muted)}
    .pts{font-weight:800}
    .first{background:rgba(34,197,94,.15)}
    .note{font-size:12px;color:var(--muted)}
    .bracket{display:grid;gap:12px;margin-top:16px}
    @media(min-width:900px){.bracket{grid-template-columns:1fr 1fr}}
    .semi,.final,.third{background:#ffffff;border:1px solid #cbd5e1;border-radius:12px;padding:12px}
    .semi h3,.final h3,.third h3{margin:0 0 8px;font-size:16px}
    .status{font-size:12px;padding:4px 8px;border-radius:6px;margin-left:8px}
    .status.success{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
    .status.error{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
    .status.loading{background:#eff6ff;color:#1e40af;border:1px solid#dbeafe}
    .import-export{background:#f0f9ff;border:2px dashed #bae6fd;border-radius:12px;padding:16px;margin-top:12px}
    .import-export h3{margin:0 0 12px;font-size:16px;color:#0369a1}
    .final { position: relative; border: 2px solid var(--accent); box-shadow: 0 0 0 4px rgba(2,132,199,.12) inset; background: #ffffff; overflow: hidden; }
    .final h3{ color: var(--accent); }
    .final::before { content: 'FINAL üèê'; position: absolute; top: 12px; right: -48px; transform: rotate(45deg); background: var(--accent); color: white; font-weight: 700; font-size: 14px; padding: 4px 48px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); opacity: 0.9; }
    .sets-input { display:flex; gap:4px; align-items:center; flex-direction:column; }
    .set-row { display:flex; gap:4px; align-items:center; }
    .sets-input input { max-width:50px; text-align:center; }
    .sets-separator { color: var(--muted); font-weight: bold; }
    .sets-indicator { display:flex; gap:2px; margin-top:4px; justify-content:center; }
    .set-dot{ width:8px; height:8px; border-radius:50%; background-color:#cbd5e1; }
    .set-dot.won{ background-color:var(--ok); }
    .set-dot.lost{ background-color:var(--bad); }
    .total-sets{ font-weight:bold; margin-top:4px; text-align:center; }
    .set-label{ font-size:11px; color:var(--muted); text-align:center; }
    .points-total{ font-size:12px; color:var(--muted); text-align:center; margin-top:2px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Administrador ‚Äî Voleibol de Playa (2 Grupos + Semifinales)</h1>
      <div class="subtitle">Versi√≥n robusta: inicializa tras DOMContentLoaded y muestra placeholders aun sin generar.</div>
    </div>
  </header>

  <main class="container grid">
    <section class="card">
      <h2>1) Equipos por grupo</h2>
      <div class="groups">
        <div><label>Grupo A (3 equipos)</label><textarea id="ga">Equipo A1
Equipo A2
Equipo A3</textarea></div>
        <div><label>Grupo B (4 equipos)</label><textarea id="gb">Equipo B1
Equipo B2
Equipo B3
Equipo B4</textarea></div>
      </div>

      <div class="row" style="margin-top:8px">
        <input type="text" id="tournamentName" placeholder="Nombre del torneo (opcional)" style="flex:2" />
        <div style="display:flex; gap:8px; align-items:center">
          <label for="themeColor" style="margin:0;color:var(--muted)">Acento</label>
          <input type="color" id="themeColor" value="#0284c7" style="width:54px;padding:0">
          <label for="themeBg" style="margin:0;color:var(--muted)">Fondo</label>
          <input type="color" id="themeBg" value="#f8fafc" style="width:54px;padding:0">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnGenerate">Generar rol por grupo</button>
        <input type="url" id="publishURL" placeholder="(Opcional: URL de backend para POST)" style="flex:2; min-width:320px" />
        <button id="btnPublish">Publicar <span id="publishStatus"></span></button>
        <div class="spacer"></div>
        <button id="btnSaveCopy" class="ghost">üíæ Guardar copia</button>
        <button id="btnClearAll" class="ghost">üßπ Limpiar</button>
      </div>

      <div class="import-export">
        <h3>üì• Importar / üì§ Exportar Datos</h3>
        <div class="row">
          <input type="file" id="importFile" accept=".json" style="flex:2">
          <button id="btnImport" class="ghost">üì• Importar JSON</button>
          <button id="btnExport" class="ghost">üì§ Exportar JSON</button>
        </div>
        <div style="font-size:12px; color:var(--muted); margin-top:8px">
          üí° Puedes importar un archivo JSON anterior para continuar donde lo dejaste
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Grupos y partidos</h2>
      <div id="groupsRoot"><div class="subtitle">Aparecer√°n aqu√≠ los partidos (placeholders iniciales incluidos).</div></div>

      <div class="bracket">
        <div class="semi">
          <h3>Semifinal 1 ‚Äî A1 vs B2</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf1h">A1</span></div>
            <div class="team" style="justify-content:center"><div class="sets-input" id="sf1-sets-container"></div></div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf1a">B2</span></div>
          </div>
          <div class="total-sets" id="sf1-total">Total: 0-0</div>
          <div class="points-total" id="sf1-points">Puntos: 0-0</div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf1w" style="max-width:260px"><option value="">‚Äî Ganador ‚Äî</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="sf1Hour" placeholder="Hora (ej. 16:00)" style="max-width:180px">
              <input type="text" id="sf1Place" placeholder="Lugar (ej. Cancha)" style="flex:1">
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf1HomeName" placeholder="Nombre semifinalista local (opcional)" style="flex:1">
            <input type="text" id="sf1AwayName" placeholder="Nombre semifinalista visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="semi">
          <h3>Semifinal 2 ‚Äî B1 vs A2</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="sf2h">B1</span></div>
            <div class="team" style="justify-content:center"><div class="sets-input" id="sf2-sets-container"></div></div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="sf2a">A2</span></div>
          </div>
          <div class="total-sets" id="sf2-total">Total: 0-0</div>
          <div class="points-total" id="sf2-points">Puntos: 0-0</div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige ganador</label>
            <select id="sf2w" style="max-width:260px"><option value="">‚Äî Ganador ‚Äî</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="sf2Hour" placeholder="Hora (ej. 17:00)" style="max-width:180px">
              <input type="text" id="sf2Place" placeholder="Lugar (ej. Cancha)" style="flex:1">
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="sf2HomeName" placeholder="Nombre semifinalista local (opcional)" style="flex:1">
            <input type="text" id="sf2AwayName" placeholder="Nombre semifinalista visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="final">
          <h3>Final</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="fih">Ganador SF1</span></div>
            <div class="team" style="justify-content:center"><div class="sets-input" id="fi-sets-container"></div></div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="fia">Ganador SF2</span></div>
          </div>
          <div class="total-sets" id="fi-total">Total: 0-0</div>
          <div class="points-total" id="fi-points">Puntos: 0-0</div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige campe√≥n</label>
            <select id="fiw" style="max-width:260px"><option value="">‚Äî Campe√≥n ‚Äî</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="fiHour" placeholder="Hora (ej. 19:00)" style="max-width:180px">
              <input type="text" id="fiPlace" placeholder="Lugar (ej. Cancha)" style="flex:1">
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="fiHomeName" placeholder="Nombre finalista local (opcional)" style="flex:1">
            <input type="text" id="fiAwayName" placeholder="Nombre finalista visita (opcional)" style="flex:1">
          </div>
        </div>

        <div class="third">
          <h3>Tercer Lugar</h3>
          <div class="row">
            <div class="team" style="flex:1"><span id="thirdh">Perdedor SF1</span></div>
            <div class="team" style="justify-content:center"><div class="sets-input" id="third-sets-container"></div></div>
            <div class="team" style="flex:1;justify-content:flex-end"><span id="thirda">Perdedor SF2</span></div>
          </div>
          <div class="total-sets" id="third-total">Total: 0-0</div>
          <div class="points-total" id="third-points">Puntos: 0-0</div>
          <div class="row" style="margin-top:6px">
            <label style="flex:1">Si hay empate, elige tercero</label>
            <select id="thirdw" style="max-width:260px"><option value="">‚Äî Tercero ‚Äî</option></select>
            <div class="row" style="margin-top:6px">
              <input type="text" id="thirdHour" placeholder="Hora (ej. 18:00)" style="max-width:180px">
              <input type="text" id="thirdPlace" placeholder="Lugar (ej. Cancha)" style="flex:1">
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            <input type="text" id="thirdHomeName" placeholder="Nombre local tercer lugar (opcional)" style="flex:1">
            <input type="text" id="thirdAwayName" placeholder="Nombre visita tercer lugar (opcional)" style="flex:1">
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
// ===== CONFIG Y UTIL =====
const STORAGE_KEY = 'torneo_playa_2grupos_v1_fix';
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

let state = {
  groups: { A:{teams:['Equipo A1','Equipo A2','Equipo A3'], matches:[]}, B:{teams:['Equipo B1','Equipo B2','Equipo B3','Equipo B4'], matches:[]} },
  points: { win:2, loss:1 },
  knockout: { sf1:{home:'',away:'',sets:[],winner:'',hour:'',place:''}, sf2:{home:'',away:'',sets:[],winner:'',hour:'',place:''}, final:{home:'',away:'',sets:[],winner:'',hour:'',place:''}, third:{home:'',away:'',sets:[],winner:'',hour:'',place:''} },
  tournamentName:'', theme:{color:'#0284c7', bg:'#f8fafc'}
};

function parseTeams(txt){ return String(txt||'').split('\\n').map(s=>s.trim()).filter(Boolean); }
function roundRobin3([a,b,c]){ return [[a,b],[c,a],[b,c]]; }
function roundRobin4([a,b,c,d]){ return [[a,b],[c,d],[a,c],[b,d],[a,d],[b,c]]; }
function buildCalendar(t){ if(t.length===3) return roundRobin3(t); if(t.length===4) return roundRobin4(t); return []; }
function valInt(v){ if(v==='' || v==null) return null; const n=parseInt(v,10); return Number.isFinite(n) && n>=0? n : null; }
function calculateSetsAndPoints(sets){ let hs=0,as=0,hp=0,ap=0; (sets||[]).forEach(s=>{ if(s && s.home!=null && s.away!=null){ hp+=s.home||0; ap+=s.away||0; if(s.home>s.away) hs++; else if(s.away>s.home) as++; }}); return {homeSets:hs, awaySets:as, homePoints:hp, awayPoints:ap}; }
function computeTable(matches, teams){ const t=Object.fromEntries(teams.map(x=>[x,{team:x,PJ:0,G:0,P:0,SF:0,SC:0,DS:0,PF:0,PC:0,DP:0,Pts:0}])); (matches||[]).forEach(m=>{ if(!m || !m.sets || !m.sets.length) return; const H=t[m.home], A=t[m.away]; if(!H||!A) return; const r=calculateSetsAndPoints(m.sets); H.PJ++;A.PJ++; H.SF+=r.homeSets;H.SC+=r.awaySets; A.SF+=r.awaySets;A.SC+=r.homeSets; H.PF+=r.homePoints;H.PC+=r.awayPoints; A.PF+=r.awayPoints;A.PC+=r.homePoints; if(r.homeSets>r.awaySets){H.G++;A.P++;H.Pts+=state.points.win;A.Pts+=state.points.loss;} else {A.G++;H.P++;A.Pts+=state.points.win;H.Pts+=state.points.loss;} }); teams.forEach(x=>{t[x].DS=t[x].SF-t[x].SC; t[x].DP=t[x].PF-t[x].PC;}); return Object.values(t).sort((a,b)=> b.Pts-a.Pts || b.DS-a.DS || b.DP-a.DP || b.PF-a.PF || a.team.localeCompare(b.team)); }

function renderGroups(){
  const root = $('#groupsRoot');
  if(!root) return;
  root.innerHTML = '';
  ['A','B'].forEach(k=>{
    const g = state.groups[k], teams=g.teams||[], matches=g.matches||[];
    const box = document.createElement('div'); box.className='groupBox group'+k; box.innerHTML = `<h3>Grupo ${k}</h3>`;
    const matchesContainer = document.createElement('div'); matchesContainer.className='matches';
    const cal = buildCalendar(teams);
    if (cal.length===0) {
      const ph = document.createElement('div'); ph.className='subtitle'; ph.textContent='(Agrega equipos y pulsa "Generar rol" para ver los partidos)'; matchesContainer.appendChild(ph);
    } else {
      cal.forEach(([home,away])=>{
        const ex = matches.find(m=>m.home===home && m.away===away) || {home,away,sets:[],hour:'',place:''};
        const matchDiv = document.createElement('div'); matchDiv.className='match';
        const setsContainer = document.createElement('div'); setsContainer.className='sets-input'; setsContainer.id=`match-${k}-${home}-${away}`;
        for(let i=0;i<5;i++){ const setData = ex.sets[i]||{home:'',away:''}; const row=document.createElement('div'); row.className='set-row'; row.innerHTML = `
          <input type="number" min="0" class="set-home" data-group="${k}" data-home="${home}" data-away="${away}" data-set="${i}" value="${setData.home||''}" placeholder="0" style="max-width:50px">
          <span class="sets-separator">-</span>
          <input type="number" min="0" class="set-away" data-group="${k}" data-home="${home}" data-away="${away}" data-set="${i}" value="${setData.away||''}" placeholder="0" style="max-width:50px">
          <div class="set-label">Set ${i+1}</div>`; setsContainer.appendChild(row); }
        matchDiv.innerHTML = `<div class="team">${home}</div><div class="team" style="justify-content:center">${setsContainer.outerHTML}</div><div class="team" style="justify-content:flex-end">${away}</div>`;
        const res = calculateSetsAndPoints(ex.sets);
        const total = document.createElement('div'); total.className='total-sets'; total.id=`total-${k}-${home}-${away}`; total.textContent=`Sets: ${res.homeSets}-${res.awaySets}`;
        const pts = document.createElement('div'); pts.className='points-total'; pts.id=`points-${k}-${home}-${away}`; pts.textContent=`Puntos: ${res.homePoints}-${res.awayPoints}`;
        const info = document.createElement('div'); info.className='info'; info.innerHTML = `
          <input type="text" class="match-hour" data-group="${k}" data-home="${home}" data-away="${away}" placeholder="Hora (ej. 14:00)" value="${ex.hour||''}">
          <input type="text" class="match-place" data-group="${k}" data-home="${home}" data-away="${away}" placeholder="Lugar (ej. Cancha 1)" value="${ex.place||''}">`;
        matchesContainer.appendChild(matchDiv); matchesContainer.appendChild(total); matchesContainer.appendChild(pts); matchesContainer.appendChild(info);
      });
    }
    box.appendChild(matchesContainer);
    const rows = computeTable(matches, teams);
    const tableHTML = `<div class="table-wrap"><table><thead><tr>
      <th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>P</th><th>SF</th><th>SC</th><th>DS</th><th>PF</th><th>PC</th><th>DP</th><th>Pts</th>
    </tr></thead><tbody>${rows.map((r,i)=>`
      <tr class="${i===0?'first':''}"><td class="pos">${i+1}</td><td>${r.team}</td><td>${r.PJ}</td><td>${r.G}</td><td>${r.P}</td>
      <td>${r.SF}</td><td>${r.SC}</td><td>${r.DS}</td><td>${r.PF}</td><td>${r.PC}</td><td>${r.DP}</td><td class="pts">${r.Pts}</td></tr>`).join('')}
    </tbody></table><div class="note" style="margin-top:8px;">üí° Orden: Puntos ‚Üí Dif. Sets ‚Üí Dif. Puntos ‚Üí Puntos a favor</div></div>`;
    box.insertAdjacentHTML('beforeend', tableHTML);
    root.appendChild(box);
  });
  setupGroupEventListeners();
}

function setupGroupEventListeners(){
  $$('.set-home, .set-away').forEach(inp=>{
    inp.addEventListener('input', function(){
      const g=this.dataset.group, h=this.dataset.home, a=this.dataset.away, idx=parseInt(this.dataset.set);
      let match = state.groups[g].matches.find(m=>m.home===h && m.away===a);
      if(!match){ match={home:h,away:a,sets:[],hour:'',place:''}; state.groups[g].matches.push(match); }
      while((match.sets||[]).length<=idx){ match.sets.push({home:'',away:''}); }
      if(this.classList.contains('set-home')) match.sets[idx].home = valInt(this.value); else match.sets[idx].away = valInt(this.value);
      const r = calculateSetsAndPoints(match.sets);
      const t = document.querySelector(`#total-${g}-${h}-${a}`); if(t) t.textContent = `Sets: ${r.homeSets}-${r.awaySets}`;
      const p = document.querySelector(`#points-${g}-${h}-${a}`); if(p) p.textContent = `Puntos: ${r.homePoints}-${r.awayPoints}`;
      saveState(); renderGroups(); updateKnockout();
    });
  });
  $$('.match-hour, .match-place').forEach(inp=>{
    inp.addEventListener('change', function(){
      const g=this.dataset.group, h=this.dataset.home, a=this.dataset.away;
      let match = state.groups[g].matches.find(m=>m.home===h && m.away===a);
      if(!match){ match={home:h,away:a,sets:[],hour:'',place:''}; state.groups[g].matches.push(match); }
      if(this.classList.contains('match-hour')) match.hour=this.value.trim(); else match.place=this.value.trim();
      saveState();
    });
  });
}

function renderKnockoutSets(){
  const map = {sf1:['#sf1-sets-container','#sf1-total','#sf1-points'], sf2:['#sf2-sets-container','#sf2-total','#sf2-points'], final:['#fi-sets-container','#fi-total','#fi-points'], third:['#third-sets-container','#third-total','#third-points']};
  Object.entries(map).forEach(([key,[cSel,tSel,pSel]])=>{
    const match = state.knockout[key]; const c=$(cSel); const t=$(tSel); const p=$(pSel); if(!c||!t||!p) return;
    c.innerHTML=''; for(let i=0;i<5;i++){ const d=match.sets[i]||{home:'',away:''}; const row=document.createElement('div'); row.className='set-row'; row.innerHTML = `
      <input type="number" min="0" class="set-knockout-home" data-match="${key}" data-set="${i}" value="${d.home||''}" style="max-width:50px" placeholder="0">
      <span class="sets-separator">-</span>
      <input type="number" min="0" class="set-knockout-away" data-match="${key}" data-set="${i}" value="${d.away||''}" style="max-width:50px" placeholder="0">
      <div class="set-label">Set ${i+1}</div>`; c.appendChild(row); }
    const r = calculateSetsAndPoints(match.sets); t.textContent=`Sets: ${r.homeSets}-${r.awaySets}`; p.textContent=`Puntos: ${r.homePoints}-${r.awayPoints}`;
  });
}

function groupStandings(k){ const g=state.groups[k]; return computeTable(g.matches, g.teams); }
function updateKnockout(){
  const A=groupStandings('A'), B=groupStandings('B');
  const A1=A[0]?.team||'A1', A2=A[1]?.team||'A2', B1=B[0]?.team||'B1', B2=B[1]?.team||'B2';
  const sf1h=$('#sf1h'), sf1a=$('#sf1a'), sf2h=$('#sf2h'), sf2a=$('#sf2a'), fih=$('#fih'), fia=$('#fia'), thirdh=$('#thirdh'), thirda=$('#thirda');
  if(sf1h) sf1h.textContent = state.knockout.sf1.home || A1;
  if(sf1a) sf1a.textContent = state.knockout.sf1.away || B2;
  if(sf2h) sf2h.textContent = state.knockout.sf2.home || B1;
  if(sf2a) sf2a.textContent = state.knockout.sf2.away || A2;
  const w1=state.knockout.sf1.winner, w2=state.knockout.sf2.winner;
  if(fih) fih.textContent = state.knockout.final.home || (w1 || 'Ganador SF1');
  if(fia) fia.textContent = state.knockout.final.away || (w2 || 'Ganador SF2');
  const l1 = w1 ? (w1===(state.knockout.sf1.home||A1) ? (state.knockout.sf1.away||B2) : (state.knockout.sf1.home||A1)) : 'Perdedor SF1';
  const l2 = w2 ? (w2===(state.knockout.sf2.home||B1) ? (state.knockout.sf2.away||A2) : (state.knockout.sf2.home||B1)) : 'Perdedor SF2';
  if(thirdh) thirdh.textContent = state.knockout.third.home || l1;
  if(thirda) thirda.textContent = state.knockout.third.away || l2;
  updateWinnerSelects();
}

function updateWinnerSelects(){
  const sf1hText=$('#sf1h')?.textContent||'', sf1aText=$('#sf1a')?.textContent||'', sf2hText=$('#sf2h')?.textContent||'', sf2aText=$('#sf2a')?.textContent||'', fihText=$('#fih')?.textContent||'', fiaText=$('#fia')?.textContent||'', thirdhText=$('#thirdh')?.textContent||'', thirdaText=$('#thirda')?.textContent||'';
  const sf1w=$('#sf1w'), sf2w=$('#sf2w'), fiw=$('#fiw'), thirdw=$('#thirdw');
  if(sf1w){ sf1w.innerHTML = `<option value="">‚Äî Ganador ‚Äî</option><option value="${sf1hText}">${sf1hText}</option><option value="${sf1aText}">${sf1aText}</option>`; if(state.knockout.sf1.winner) sf1w.value=state.knockout.sf1.winner; }
  if(sf2w){ sf2w.innerHTML = `<option value="">‚Äî Ganador ‚Äî</option><option value="${sf2hText}">${sf2hText}</option><option value="${sf2aText}">${sf2aText}</option>`; if(state.knockout.sf2.winner) sf2w.value=state.knockout.sf2.winner; }
  if(fiw){ fiw.innerHTML = `<option value="">‚Äî Campe√≥n ‚Äî</option><option value="${fihText}">${fihText}</option><option value="${fiaText}">${fiaText}</option>`; if(state.knockout.final.winner) fiw.value=state.knockout.final.winner; }
  if(thirdw){ thirdw.innerHTML = `<option value="">‚Äî Tercero ‚Äî</option><option value="${thirdhText}">${thirdhText}</option><option value="${thirdaText}">${thirdaText}</option>`; if(state.knockout.third.winner) thirdw.value=state.knockout.third.winner; }
}

function setupKnockoutListeners(){
  document.addEventListener('input', e=>{
    if(e.target.classList.contains('set-knockout-home') || e.target.classList.contains('set-knockout-away')){
      const k=e.target.dataset.match, idx=parseInt(e.target.dataset.set); const m=state.knockout[k]; while(m.sets.length<=idx) m.sets.push({home:'',away:''}); if(e.target.classList.contains('set-knockout-home')) m.sets[idx].home=valInt(e.target.value); else m.sets[idx].away=valInt(e.target.value);
      const r=calculateSetsAndPoints(m.sets); const t=$(`#${k}-total`), p=$(`#${k}-points`); if(t) t.textContent=`Sets: ${r.homeSets}-${r.awaySets}`; if(p) p.textContent=`Puntos: ${r.homePoints}-${r.awayPoints}`; saveState();
    }
  });
  [['#sf1w','sf1'],['#sf2w','sf2'],['#fiw','final'],['#thirdw','third']].forEach(([sel,key])=>{
    const el=$(sel); if(!el) return; el.addEventListener('change', function(){ state.knockout[key].winner=this.value; saveState(); if(key==='sf1'||key==='sf2') updateKnockout(); });
  });
  const koInputs=['#sf1Hour','#sf1Place','#sf1HomeName','#sf1AwayName','#sf2Hour','#sf2Place','#sf2HomeName','#sf2AwayName','#fiHour','#fiPlace','#fiHomeName','#fiAwayName','#thirdHour','#thirdPlace','#thirdHomeName','#thirdAwayName'];
  koInputs.forEach(sel=>{ const el=$(sel); if(!el) return; el.addEventListener('change', function(){ const key=sel.includes('sf1')?'sf1': sel.includes('sf2')?'sf2': sel.includes('fi')?'final':'third'; const field= sel.includes('Hour')?'hour': sel.includes('Place')?'place': sel.includes('HomeName')?'home':'away'; state.knockout[key][field]=this.value.trim(); if(field==='home'||field==='away') updateKnockout(); saveState(); }); });
}

function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadState(){ try{ const s=localStorage.getItem(STORAGE_KEY); if(s){ state={...state, ...JSON.parse(s)}; return true; } }catch(e){ console.error(e);} return false; }

function generateGroups(){
  state.groups.A.teams = parseTeams($('#ga')?.value||'');
  state.groups.B.teams = parseTeams($('#gb')?.value||'');
  ['A','B'].forEach(k=> state.groups[k].matches=[]);
  saveState(); renderGroups(); updateKnockout(); renderKnockoutSets();
}

async function publish(){
  const publishURL = $('#publishURL')?.value?.trim()||'';
  const statusEl = $('#publishStatus'); if(statusEl){ statusEl.textContent='Publicando...'; statusEl.className='status loading'; }
  const data = {...state, timestamp:new Date().toISOString()};
  try{
    if(publishURL){
      const resp = await fetch(publishURL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      if(statusEl){ statusEl.className='status success'; statusEl.textContent='‚úì Publicado'; }
    } else {
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='data.json'; a.click(); URL.revokeObjectURL(url);
      if(statusEl){ statusEl.className='status success'; statusEl.textContent='‚úì Descargado'; }
    }
  }catch(e){
    console.error(e);
    if(statusEl){ statusEl.className='status error'; statusEl.textContent='‚úó Error'; }
  }
  setTimeout(()=>{ if(statusEl){ statusEl.textContent=''; statusEl.className=''; } }, 3000);
}

function applyStateToUI(){
  const a=$('#ga'), b=$('#gb'); if(a) a.value = (state.groups.A.teams||[]).join('\\n'); if(b) b.value = (state.groups.B.teams||[]).join('\\n');
  const tn=$('#tournamentName'), tc=$('#themeColor'), tb=$('#themeBg'); if(tn) tn.value = state.tournamentName||''; if(tc) tc.value = state.theme?.color||'#0284c7'; if(tb) tb.value = state.theme?.bg||'#f8fafc';
  applyTheme();
}

function applyTheme(){ document.documentElement.style.setProperty('--accent', state.theme.color); document.documentElement.style.setProperty('--bg', state.theme.bg); }

function wireButtons(){
  $('#btnGenerate')?.addEventListener('click', generateGroups);
  $('#btnPublish')?.addEventListener('click', publish);
  $('#btnSaveCopy')?.addEventListener('click', exportData);
  $('#btnClearAll')?.addEventListener('click', ()=>{ if(confirm('¬øBorrar todos los datos?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });
  $('#btnExport')?.addEventListener('click', exportData);
  $('#btnImport')?.addEventListener('click', ()=> $('#importFile')?.click());
  $('#importFile')?.addEventListener('change', function(){ if(this.files?.length){ importData(this.files[0]); this.value=''; }});
  $('#tournamentName')?.addEventListener('change', function(){ state.tournamentName=this.value; saveState(); });
  $('#themeColor')?.addEventListener('change', function(){ state.theme.color=this.value; saveState(); applyTheme(); });
  $('#themeBg')?.addEventListener('change', function(){ state.theme.bg=this.value; saveState(); applyTheme(); });
}

function exportData(){ const str=JSON.stringify(state,null,2); const blob=new Blob([str],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`torneo_playa_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); }
function importData(file){ const r=new FileReader(); r.onload = e=>{ try{ const imp=JSON.parse(e.target.result); state={...state, ...imp}; saveState(); applyStateToUI(); renderGroups(); updateKnockout(); renderKnockoutSets(); alert('‚úÖ Datos importados correctamente'); }catch{ alert('‚ùå Error al importar: JSON inv√°lido'); } }; r.readAsText(file); }

function init(){
  loadState(); applyStateToUI(); renderGroups(); updateKnockout(); renderKnockoutSets(); setupKnockoutListeners(); wireButtons();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
