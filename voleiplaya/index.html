<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizador ‚Äî Voleibol de Playa (2 Grupos)</title>
  <style>
    :root {
      --accent: #0284c7;
      --bg: #f8fafc;
      --panel: #e2e8f0;
      --card: #ffffff;
      --muted: #475569;
      --text: #0f172a;
      --ok: #16a34a;
      --bad: #dc2626;
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{ font-family:system-ui,-apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); line-height:1.5; }
    header{ padding:20px 16px; border-bottom:2px solid #cbd5e1; background:linear-gradient(90deg, var(--panel), #f1f5f9); position:sticky; top:0; z-index:10; }
    .container{ max-width:1200px; margin:0 auto; padding:16px; }
    h1{ margin:0; font-size:clamp(22px,3.2vw,34px); }
    .subtitle{ color:var(--muted); margin-top:4px; }

    .card{ background:var(--card); border:1px solid #cbd5e1; border-radius:18px; padding:16px; box-shadow:0 3px 10px rgba(0,0,0,.1); margin-bottom:16px; }
    .card h2{ margin:0 0 12px; font-size:18px; }

    .groups{ display:grid; gap:12px; }
    @media(min-width:700px){ .groups{ grid-template-columns:1fr 1fr; }}

    .groupA { background: rgba(56,189,248,.12); border:1px solid rgba(56,189,248,.45); }
    .groupB { background: rgba(168,85,247,.12); border:1px solid rgba(168,85,247,.45); }
    .groupBox{ padding:12px; border-radius:12px; margin-bottom:12px; }

    .matches{ display:grid; gap:10px; margin-top:10px; }
    .match{ display:grid; grid-template-columns:1fr auto 1fr; gap:8px; align-items:center; background:#f8fafc; border:1px solid #cbd5e1; border-radius:12px; padding:10px; }
    .team{ display:flex; align-items:center; gap:10px; }
    .dash{ opacity:.6; }

    .info{ display:flex; gap:8px; margin-top:6px; font-size:14px; color:var(--muted); }

    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{ padding:8px 10px; border-bottom:1px solid #cbd5e1; text-align:right; }
    th:first-child, td:first-child{ text-align:left; }
    thead th{ font-size:12px; color:var(--muted); font-weight:600; }
    tbody tr:hover{ background:#e2e8f0; }
    .pos{ font-variant-numeric:tabular-nums; color:var(--muted); }
    .pts{ font-weight:800; }
    .first{ background:rgba(34,197,94,.15); }

    .bracket{ display:grid; gap:12px; margin-top:16px; }
    @media(min-width:900px){ .bracket{ grid-template-columns:1fr 1fr; } }
    .semi,.final,.third{ background:#ffffff; border:1px solid #cbd5e1; border-radius:12px; padding:12px; }
    .semi h3,.final h3,.third h3{ margin:0 0 8px; font-size:16px; }

    .final { position:relative; border:2px solid var(--accent); box-shadow:0 0 0 4px rgba(2,132,199,.12) inset; background:#ffffff; overflow:hidden; }
    .final h3{ color:var(--accent); }
    .final::before { content:'FINAL üèê'; position:absolute; top:12px; right:-48px; transform:rotate(45deg); background:var(--accent); color:white; font-weight:700; font-size:14px; padding:4px 48px; box-shadow:0 2px 6px rgba(0,0,0,0.15); opacity:0.9; }

    /* Indicadores de sets */
    .sets-indicator{ display:flex; gap:4px; margin-top:4px; justify-content:center; }
    .set-dot{ width:8px; height:8px; border-radius:50%; background-color:#cbd5e1; }
    .set-dot.won{ background-color:var(--ok); }
    .set-dot.lost{ background-color:var(--bad); }
    .sets-score{ font-weight:bold; font-size:16px; }
    .sets-detail{ margin-top:8px; font-size:14px; color:var(--muted); text-align:center; }
    .total-sets{ font-weight:bold; text-align:center; margin:8px 0; font-size:16px; }
    .points-total{ font-size:14px; color:var(--muted); text-align:center; margin-bottom:8px; }

    .champion{ text-align:center; padding:20px; background:linear-gradient(135deg,#fef3c7,#fde68a); border-radius:18px; margin:20px 0; border:2px solid #f59e0b; }
    .champion h2{ color:#92400e; margin-bottom:10px; }
    .champion .team-name{ font-size:24px; font-weight:bold; color:#92400e; }

    .loading{ text-align:center; padding:40px; color:var(--muted); }
    .error{ background:#fef2f2; border:1px solid #fecaca; color:#dc2626; padding:16px; border-radius:12px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 id="tournamentTitle">Voleibol de Playa</h1>
      <div class="subtitle" id="tournamentSubtitle">Visualizaci√≥n de resultados</div>
    </div>
  </header>

  <main class="container">
    <div id="tournamentContent">
      <div class="card loading">
        <div class="subtitle">Cargando datos del torneo...</div>
      </div>
    </div>
  </main>

  <script>
    function getJsonFileNameFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const t = urlParams.get('t') || urlParams.get('torneo');
      if (t) return t.includes('.') ? t : `${t}.json`;
      return 'data.json';
    }

    function formatTimestamp(ts) {
      if (!ts) return '';
      try {
        let val = ts;
        if (typeof ts === 'string') val = ts.includes('-') ? ts : parseInt(ts);
        const d = new Date(val); 
        if (isNaN(d.getTime())) return '';
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2,'0');
        const mi = String(d.getMinutes()).padStart(2,'0');
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      } catch { 
        return ''; 
      }
    }

    function applyTheme(theme) {
      if (!theme) return;
      const accent = theme.color || '#0284c7';
      const bg = theme.bg || '#f8fafc';
      document.documentElement.style.setProperty('--accent', accent);
      document.documentElement.style.setProperty('--bg', bg);
      document.body.style.background = bg;
      const header = document.querySelector('header');
      if (header) {
        header.style.background = `linear-gradient(90deg, color-mix(in srgb, ${accent} 15%, white), color-mix(in srgb, ${accent} 8%, white))`;
      }
    }

    function calculateSetsAndPoints(sets) {
      let hs=0, as=0, hp=0, ap=0;
      sets.forEach(s => { 
        if(s && s.home != null && s.away != null){ 
          hp += s.home || 0; 
          ap += s.away || 0; 
          if(s.home > s.away) hs++; 
          else if(s.away > s.home) as++; 
        }
      });
      return {homeSets: hs, awaySets: as, homePoints: hp, awayPoints: ap, pointsDifference: hp - ap};
    }

    function computeTable(matches, teams, cfg = {win: 2, loss: 1}) {
      const table = Object.fromEntries(teams.map(t => [t, {team: t, PJ: 0, G: 0, P: 0, SF: 0, SC: 0, DS: 0, PF: 0, PC: 0, DP: 0, Pts: 0}]));
      (matches || []).forEach(m => {
        if(!m || !m.sets || !m.sets.length) return;
        const h = table[m.home], a = table[m.away]; 
        if(!h || !a) return;
        const r = calculateSetsAndPoints(m.sets);
        h.PJ++; a.PJ++; 
        h.SF += r.homeSets; h.SC += r.awaySets; 
        a.SF += r.awaySets; a.SC += r.homeSets;
        h.PF += r.homePoints; h.PC += r.awayPoints; 
        a.PF += r.awayPoints; a.PC += r.homePoints;
        if(r.homeSets > r.awaySets){ 
          h.G++; a.P++; 
          h.Pts += cfg.win; a.Pts += cfg.loss; 
        } else { 
          a.G++; h.P++; 
          a.Pts += cfg.win; h.Pts += cfg.loss; 
        }
      });
      teams.forEach(t => { 
        table[t].DS = table[t].SF - table[t].SC; 
        table[t].DP = table[t].PF - table[t].PC; 
      });
      return Object.values(table).sort((a,b) => 
        b.Pts - a.Pts || b.DS - a.DS || b.DP - a.DP || b.PF - a.PF || a.team.localeCompare(b.team)
      );
    }

    function renderMatch(m, defHome, defAway) {
      const _m = Object.assign({sets: [], hour: '', place: ''}, m || {});
      const has = _m.sets && _m.sets.length > 0;
      const res = has ? calculateSetsAndPoints(_m.sets) : {homeSets: 0, awaySets: 0, homePoints: 0, awayPoints: 0};
      const hw = has && res.homeSets > res.awaySets, 
            aw = has && res.awaySets > res.homeSets;
      const home = _m.home || defHome || 'Equipo Local';
      const away = _m.away || defAway || 'Equipo Visitante';
      let detail = '';
      
      if (has) {
        const s = _m.sets.map((set, i) => 
          (set && set.home != null && set.away != null) ? `Set ${i+1}: ${set.home}-${set.away}` : ''
        ).filter(Boolean).join(' | ');
        if (s) detail = `<div class="sets-detail">${s}</div>`;
      }
      
      return `
        <div class="match">
          <div class="team ${hw ? 'winner' : ''}">${home}</div>
          <div class="match-result">
            ${has ? `<span class="sets-score">${res.homeSets}</span><span class="dash">-</span><span class="sets-score">${res.awaySets}</span>` : '<span class="dash">-</span>'}
          </div>
          <div class="team ${aw ? 'winner' : ''}" style="justify-content:flex-end">${away}</div>
        </div>
        ${has ? `
          <div class="points-total">Puntos: ${res.homePoints}-${res.awayPoints}</div>
          <div class="sets-indicator">${Array(res.homeSets).fill('<div class="set-dot won"></div>').join('')}${Array(res.awaySets).fill('<div class="set-dot lost"></div>').join('')}</div>
          ${detail}
        ` : ''}
        ${(_m.hour || _m.place) ? `<div class="info">${_m.hour ? 'üïí '+_m.hour : ''} ${_m.place ? 'üìç '+_m.place : ''}</div>` : ''}
      `;
    }

    function renderCover(data) {
      const theme = data.theme || {};
      const accent = theme.color || '#0284c7';
      const updatedAt = data.updatedAtLocal || data.timestamp || '';
      const info = updatedAt ? `<div class="subtitle">üìÖ √öltima actualizaci√≥n: ${formatTimestamp(updatedAt)}</div>` : '';
      return `
        <div class="card" style="background: linear-gradient(135deg, ${accent}, color-mix(in srgb, ${accent} 80%, black)); color:white;">
          <h2 style="font-size:clamp(26px,4vw,42px); margin-bottom:6px;">${data.tournamentName || 'Voleibol de Playa'}</h2>
          <div class="subtitle" style="color:rgba(255,255,255,0.95)">
            ${data.subtitle || 'Fase de grupos y eliminatoria'}
          </div>
          ${info}
        </div>
      `;
    }

    function renderGroups(groups) {
      let html = '<div class="card"><h2>Fase de Grupos</h2><div class="groups">';
      ['A','B'].forEach(k => {
        const g = groups[k]; 
        if(!g || !g.teams || !g.teams.length) return;
        
        const teams = g.teams; 
        const matches = g.matches || [];
        html += `<div class="groupBox group${k}"><h3>Grupo ${k}</h3><div class="matches">`;
        
        matches.filter(m => m && typeof m === 'object').forEach(m => { 
          html += renderMatch(m, m.home, m.away); 
        });
        
        html += '</div>';
        const table = computeTable(matches, teams);
        html += `
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>P</th>
                  <th>SF</th><th>SC</th><th>DS</th>
                  <th>PF</th><th>PC</th><th>DP</th>
                  <th>Pts</th>
                </tr>
              </thead>
              <tbody>
                ${table.map((row, i) => `
                  <tr class="${i === 0 ? 'first' : ''}">
                    <td class="pos">${i+1}</td>
                    <td>${row.team}</td>
                    <td>${row.PJ}</td>
                    <td>${row.G}</td>
                    <td>${row.P}</td>
                    <td>${row.SF}</td>
                    <td>${row.SC}</td>
                    <td>${row.DS}</td>
                    <td>${row.PF}</td>
                    <td>${row.PC}</td>
                    <td>${row.DP}</td>
                    <td class="pts">${row.Pts}</td>
                  </tr>`).join('')}
              </tbody>
            </table>
            <div class="subtitle" style="margin-top:8px;">üí° Orden: Puntos ‚Üí Dif. Sets ‚Üí Dif. Puntos ‚Üí Puntos a favor</div>
          </div>
        `;
        html += '</div>';
      });
      html += '</div></div>';
      return html;
    }

    function renderKnockout(k) {
      if (!k) return '';
      let html = '';
      if (k.final && k.final.winner) {
        html += `
          <div class="champion">
            <h2>üèÜ CAMPE√ìN üèÜ</h2>
            <div class="team-name">${k.final.winner}</div>
          </div>
        `;
      }
      html += `
        <div class="card">
          <h2>Fase Eliminatoria</h2>
          <div class="bracket">
            <div class="semi">
              <h3>Semifinal 1 (A1 vs B2)</h3>
              ${renderMatch(k.sf1, k.sf1.home || 'A1', k.sf1.away || 'B2')}
              ${k.sf1.winner ? `<div class="info"><strong>Ganador: ${k.sf1.winner}</strong></div>` : ''}
            </div>
            <div class="semi">
              <h3>Semifinal 2 (B1 vs A2)</h3>
              ${renderMatch(k.sf2, k.sf2.home || 'B1', k.sf2.away || 'A2')}
              ${k.sf2.winner ? `<div class="info"><strong>Ganador: ${k.sf2.winner}</strong></div>` : ''}
            </div>
            <div class="third">
              <h3>Tercer Lugar</h3>
              ${renderMatch(k.third, k.third.home || 'Perdedor SF1', k.third.away || 'Perdedor SF2')}
              ${k.third.winner ? `<div class="info"><strong>Tercero: ${k.third.winner}</strong></div>` : ''}
            </div>
            <div class="final">
              <h3>Final</h3>
              ${renderMatch(k.final, k.final.home || 'Ganador SF1', k.final.away || 'Ganador SF2')}
              ${k.final.winner ? `<div class="info"><strong>üèÜ Campe√≥n: ${k.final.winner}</strong></div>` : ''}
            </div>
          </div>
        </div>
      `;
      return html;
    }

    async function loadData() {
      const fileName = getJsonFileNameFromUrl();
      console.log('Intentando cargar:', fileName);
      
      try {
        const res = await fetch(fileName, { cache: 'no-store' });
        if (!res.ok) {
          throw new Error(`No se pudo cargar ${fileName} (HTTP ${res.status})`);
        }
        
        const data = await res.json();
        console.log('Datos cargados:', data);

        // Normaliza estructura m√≠nima esperada
        const normalizedData = {
          tournamentName: data.tournamentName || 'Voleibol de Playa',
          subtitle: data.subtitle || 'Visualizaci√≥n de resultados',
          theme: Object.assign({color: '#0284c7', bg: '#f8fafc'}, data.theme || {}),
          points: Object.assign({win: 2, loss: 1}, data.points || {}),
          groups: {
            A: (data.groups && data.groups.A) ? data.groups.A : { teams: [], matches: [] },
            B: (data.groups && data.groups.B) ? data.groups.B : { teams: [], matches: [] }
          },
          knockout: Object.assign({ sf1: {}, sf2: {}, final: {}, third: {} }, data.knockout || {}),
          updatedAtLocal: data.updatedAtLocal || data.timestamp || ''
        };

        applyTheme(normalizedData.theme);
        
        const titleElement = document.getElementById('tournamentTitle');
        const subtitleElement = document.getElementById('tournamentSubtitle');
        
        if (titleElement) titleElement.textContent = normalizedData.tournamentName;
        if (subtitleElement) subtitleElement.textContent = normalizedData.subtitle;

        let html = '';
        html += renderCover(normalizedData);
        html += renderGroups(normalizedData.groups);
        html += renderKnockout(normalizedData.knockout);

        const contentElement = document.getElementById('tournamentContent');
        if (contentElement) {
          contentElement.innerHTML = html;
        }
        
      } catch (e) {
        console.error('Error cargando datos:', e);
        const contentElement = document.getElementById('tournamentContent');
        if (contentElement) {
          contentElement.innerHTML = `
            <div class="card error">
              <h2>Error al cargar datos</h2>
              <p style="margin-top:8px;">${e.message}</p>
              <p style="font-size:14px; color:var(--muted); margin-top:8px;">
                Verifica que <strong>${fileName}</strong> existe junto a este archivo.
                <br>Tambi√©n puedes especificar un archivo diferente usando el par√°metro URL: 
                <code>?t=nombre-del-archivo</code>
              </p>
              <div style="margin-top:12px; font-size:14px;">
                <strong>Posibles soluciones:</strong>
                <ul style="margin-top:8px; padding-left:20px;">
                  <li>Aseg√∫rate de que el archivo JSON existe en el mismo directorio</li>
                  <li>Verifica que el JSON tenga un formato v√°lido</li>
                  <li>Usa el administrador para generar el archivo data.json</li>
                </ul>
              </div>
            </div>`;
        }
      }
    }

    // Cargar datos cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadData);
    } else {
      loadData();
    }
  </script>
</body>
</html>